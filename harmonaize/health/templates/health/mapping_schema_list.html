{% extends "base.html" %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
<div class="content-wrapper" style="max-width:1000px;margin:2rem auto;">
  <div class="info-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.05);padding:1.25rem 1.5rem;">
    <h2 style="margin:0 0 .75rem;font-size:1.3rem;font-weight:700;">Harmonisation Schemas – {{ study.name }}</h2>
    <p style="margin:0 0 1.25rem;color:#6b7280;font-size:.9rem;">Manage mapping schemas linking this source study to a target study. Track progress and continue editing.</p>
    <div style="margin:0 0 1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
      <a href="{% url 'core:study_detail' study.id %}" class="btn btn-secondary">← Back</a>
      <a href="{% url 'health:start_harmonisation' study.id %}" class="btn btn-primary">New Schema</a>
    </div>
    {% if schemas %}
      <div style="display:grid;gap:1rem;">
        {% for schema, flags in schemas %}
          <div style="border:1px solid #e5e7eb;border-radius:10px;padding:1rem;background:#f9fafb;position:relative;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap;">
              <div>
                <h3 style="margin:.1rem 0 .4rem;font-size:1rem;font-weight:600;">Target: {{ schema.target_study.name }}</h3>
                <p style="margin:0;font-size:.75rem;color:#6b7280;">Created {{ schema.created_at|date:'Y-m-d H:i' }}</p>
              </div>
              <div style="display:flex;gap:.4rem;">
                <a href="{% url 'health:edit_mapping' schema.id %}" class="btn btn-primary btn-sm">Edit</a>
                {% if schema.status != 'approved' and flags.rules_count %}
                  <a href="{% url 'health:approve_mapping' schema.id %}" class="btn btn-secondary btn-sm" onclick="return confirm('Approve this schema?');">Approve</a>
                {% endif %}
              </div>
            </div>
            <div style="margin-top:.75rem;">
              {% include 'health/_mapping_progress.html' with schema=schema rules_count=flags.rules_count has_patient_id=flags.has_patient_id has_datetime=flags.has_datetime has_related=flags.has_related has_transforms=flags.has_transforms approved=flags.approved %}
            </div>
            <div style="margin-top:.5rem;font-size:.7rem;color:#374151;display:flex;gap:1.25rem;flex-wrap:wrap;">
              <span>Rules: {{ flags.rules_count }}</span>
              <span>Transforms: {% if flags.has_transforms %}✅{% else %}—{% endif %}</span>
              <span>Related IDs: {% if flags.has_related %}✅{% else %}—{% endif %}</span>
              <span>Status: {{ schema.status }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p style="margin:1rem 0 0;color:#6b7280;font-size:.9rem;">No mapping schemas yet. Create one to begin harmonisation.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
