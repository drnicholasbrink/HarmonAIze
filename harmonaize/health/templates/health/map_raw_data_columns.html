{% extends "base.html" %}
{% load static %}
{% load health_extras %}

{% block title %}{{ page_title }} - HarmonAIze Toolkit{% endblock title %}

{% block css %}
    {{ block.super }}
    <style>
        :root { --primary-color:#007AFF; --secondary-color:#5AC8FA; --accent-color:#34C759; --background-color:#F2F2F7; --card-background:#FFFFFF; --text-primary:#1C1C1E; --text-secondary:#8E8E93; --border-color:#C6C6C8; --shadow:0 2px 20px rgba(0,0,0,0.1); --border-radius:12px; }
        body { background:var(--background-color); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; }
        .breadcrumb-container { background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%); padding:1.5rem 0 1rem; margin:-1rem -15px 0; }
        .breadcrumb { background:transparent; margin:0 auto; max-width:1200px; padding:0 2rem; }
        .breadcrumb-item a { color:rgba(255,255,255,.9); text-decoration:none; font-weight:500; }
        .breadcrumb-item a:hover { color:#fff; text-decoration:underline; }
        .breadcrumb-item.active { color:#fff; font-weight:600; }
        .breadcrumb-item + .breadcrumb-item::before { color:rgba(255,255,255,.7); }

        .page-header { background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%); color:#fff; padding:2rem 0 3rem; margin:0 -15px; text-align:center; }
        .page-title { font-size:2rem; font-weight:700; margin-bottom:.5rem; }
        .page-subtitle { font-size:1rem; opacity:.9; margin-bottom:1.5rem; }
        .study-info { background:rgba(255,255,255,.15); border-radius:8px; padding:.5rem 1rem; display:inline-block; }

        .main-content { max-width:1200px; margin:0 auto; padding:2rem; }
        .card-like { background:var(--card-background); border-radius:var(--border-radius); box-shadow:var(--shadow); padding:2rem; margin-bottom:2rem; }
        .section-title { font-size:1.25rem; font-weight:600; margin-bottom:1rem; }

        .summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:1rem; }
        .summary-item { background:linear-gradient(135deg,var(--secondary-color) 0%,var(--primary-color) 100%); color:#fff; border-radius:10px; padding:1.1rem; text-align:center; }
        .summary-value { font-size:1.4rem; font-weight:700; margin-bottom:.25rem; }
        .summary-label { font-size:.75rem; letter-spacing:.5px; text-transform:uppercase; opacity:.9; }

        .mapping-row { background:#fff; border:1px solid var(--border-color); border-radius:10px; padding:1.1rem 1rem; margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
        .column-info { background:rgba(0,122,255,0.06); border-radius:8px; padding:.75rem .85rem; }
        .column-info h6 { font-size:.95rem; font-weight:600; display:flex; align-items:center; gap:.4rem; }
        .badge-type { background:var(--primary-color); color:#fff; font-size:.6rem; letter-spacing:.5px; padding:.3rem .45rem; border-radius:4px; text-transform:uppercase; }
        .meta-pair { font-size:.65rem; font-weight:500; color:var(--text-secondary); }
        .sample-values { font-family:'Courier New',monospace; font-size:.7rem; background:#f1f5f9; padding:.25rem .45rem; border-radius:4px; display:inline-block; margin-top:.25rem; }
        .arrow-col { display:flex; align-items:center; justify-content:center; color:var(--text-secondary); }
        select.form-select { border-radius:8px; }

        .current-mapping { font-size:.7rem; color:var(--accent-color); font-weight:600; margin-top:.4rem; display:block; }

        .btn-primary { background:var(--primary-color); border:none; }
        .btn-primary:hover { background:#0056CC; }
        .btn-wide { padding:.85rem 2.25rem; font-weight:600; border-radius:10px; }
        .action-center { text-align:center; margin-top:1rem; }

        .process-steps .step { display:flex; align-items:center; padding:.65rem 0; border-left:2px solid var(--border-color); padding-left:1rem; margin-left:.5rem; position:relative; }
        .process-steps .step:before { content:''; position:absolute; left:-7px; top:50%; width:12px; height:12px; border-radius:50%; background:var(--border-color); transform:translateY(-50%); }
        .process-steps .step.completed { border-left-color:var(--accent-color); color:var(--accent-color); }
        .process-steps .step.completed:before { background:var(--accent-color); }
        .process-steps .step.active { border-left-color:var(--primary-color); color:var(--primary-color); font-weight:600; }
        .process-steps .step.active:before { background:var(--primary-color); }
        .process-steps .step i { margin-right:.6rem; width:16px; }

        .help-block h6 { font-size:.8rem; font-weight:700; letter-spacing:.5px; text-transform:uppercase; margin-bottom:.4rem; display:flex; align-items:center; gap:.4rem; }
        .help-block p,.help-block ul { font-size:.7rem; color:var(--text-secondary); margin-bottom:.75rem; }
        .variable-item { padding:.45rem .55rem; border:1px solid #eef0f3; border-radius:6px; background:#fafbfc; margin-bottom:.5rem; }
        .variable-item small { font-size:.65rem; color:var(--text-secondary); }

        @media (max-width: 768px){ .summary-grid { grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); } }
    </style>
{% endblock css %}

{% block content %}
    <!-- Breadcrumb -->
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'core:study_detail' raw_data_file.study.id %}">{{ raw_data_file.study.name }}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'health:raw_data_detail' raw_data_file.id %}">{{ raw_data_file.original_filename }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Map Columns</li>
            </ol>
        </nav>
    </div>

    <!-- Header -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">Map Data Columns</h1>
            <p class="page-subtitle">Align raw data fields to study variables for harmonisation</p>
            <div class="study-info"><span class="study-name">{{ raw_data_file.study.name }}</span></div>
        </div>
    </div>

    <div class="main-content">
        <form method="post">
            {% csrf_token %}
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card-like">
                        <div class="section-title">File Summary</div>
                        <div class="summary-grid">
                            <div class="summary-item"><div class="summary-value">{{ columns.count }}</div><div class="summary-label">Data Columns</div></div>
                            <div class="summary-item"><div class="summary-value">{{ study_variables.count }}</div><div class="summary-label">Study Variables</div></div>
                            <div class="summary-item"><div class="summary-value">{{ raw_data_file.rows_count|floatformat:0 }}</div><div class="summary-label">Data Rows</div></div>
                        </div>
                    </div>

                    <div class="card-like">
                        <div class="section-title">Column Mappings</div>
                        <p style="color:var(--text-secondary); font-size:.85rem; margin-top:-.25rem; margin-bottom:1.25rem;">Match each data column to the appropriate study variable. Suggested mappings are pre-selected based on similarity.</p>

                        {% for column in columns %}
                            <div class="mapping-row">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <div class="column-info">
                                            <h6><strong>{{ column.column_name }}</strong><span class="badge-type">{{ column.inferred_type|title }}</span></h6>
                                            <div class="row mt-1">
                                                <div class="col-6"><span class="meta-pair">Non-null: {{ column.non_null_count }}</span></div>
                                                <div class="col-6"><span class="meta-pair">Unique: {{ column.unique_count }}</span></div>
                                            </div>
                                            {% if column.sample_values %}
                                                <div class="mt-2">
                                                    <small class="text-muted d-block" style="font-size:.65rem;">Sample values:</small>
                                                    <div class="sample-values">{% for value in column.sample_values|slice:":3" %}{{ value }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if column.sample_values|length > 3 %}...{% endif %}</div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% if column.mapped_variable %}
                                            <span class="current-mapping">Mapped to: {{ column.mapped_variable.variable_name }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 arrow-col"><i class="fas fa-arrow-right"></i></div>
                                    <div class="col-md-5">
                                        <label class="form-label" style="font-size:.7rem; text-transform:uppercase; letter-spacing:.5px; font-weight:600;">Map to Study Variable</label>
                                        <select name="column_{{ column.id }}_mapping" class="form-select">
                                            <option value="">-- No mapping --</option>
                                            {% for variable in study_variables %}
                                                <option value="{{ variable.id }}" {% if column.mapped_variable.id == variable.id %}selected{% endif %}{% if not column.mapped_variable and suggested_mappings and variable.id == suggested_mappings|get_item:column.column_name %} selected{% endif %}>{{ variable.variable_name }} ({{ variable.variable_type|title }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="action-center" style="padding:3rem 1rem; color:var(--text-secondary);">
                                <i class="fas fa-table fa-2x mb-3"></i>
                                <p>No columns found. Please validate the file first.</p>
                                <a href="{% url 'health:validate_raw_data' raw_data_file.id %}" class="btn btn-primary btn-wide">Validate File</a>
                            </div>
                        {% endfor %}

                        {% if columns %}
                            <div class="action-center mt-3">
                                <button type="submit" class="btn btn-primary btn-wide">Save Column Mappings</button>
                                <div class="mt-2"><small class="text-muted">Unmapped columns will be ignored during analysis</small></div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card-like">
                        <div class="section-title">Processing Pipeline</div>
                        <div class="process-steps">
                            <div class="step completed"><i class="fas fa-upload"></i><span>File Uploaded</span></div>
                            <div class="step completed"><i class="fas fa-check-circle"></i><span>Validation</span></div>
                            <div class="step {% if raw_data_file.processing_status == 'processed' %}completed{% else %}active{% endif %}"><i class="fas fa-link"></i><span>Column Mapping</span></div>
                            <div class="step"><i class="fas fa-cogs"></i><span>Integration</span></div>
                        </div>
                    </div>

                    <div class="card-like help-block">
                        <div class="section-title" style="margin-bottom:.75rem;">Mapping Guidelines</div>
                        <h6><i class="fas fa-magic"></i>Auto Pre-filling</h6>
                        <p>The system pre-selects likely mappings based on name similarity & inferred types. Review each mapping for accuracy.</p>
                        <h6><i class="fas fa-check-circle" style="color:var(--accent-color);"></i>Best Practices</h6>
                        <ul>
                            <li>Match variable types when possible</li>
                            <li>Review sample values</li>
                            <li>Prefer semantically closest variable</li>
                            <li>Leave extraneous columns unmapped</li>
                        </ul>
                    </div>

                    <div class="card-like">
                        <div class="section-title">Available Variables</div>
                        <div class="variable-list">
                            {% for variable in study_variables %}
                                <div class="variable-item">
                                    <strong style="font-size:.75rem;">{{ variable.variable_name }}</strong><br>
                                    <small>{{ variable.variable_type|title }}</small>
                                    {% if variable.variable_description %}<br><small>{{ variable.variable_description|truncatechars:70 }}</small>{% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock content %}
