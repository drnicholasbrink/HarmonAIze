<!-- Duplicate Detection Section - On Demand -->
<div class="info-card" id="duplicate-detection" style="margin-top: 2rem;">
  <!-- Hidden CSRF token for JavaScript access (since CSRF_COOKIE_HTTPONLY = True) -->
  <input type="hidden" id="csrf-token-duplicate-detection" value="{{ csrf_token }}">
  
  <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
    <h2 class="card-title" style="margin: 0;">
      <i class="fas fa-copy" style="color: var(--warning-color);"></i> Data Quality Check
    </h2>
    
    <button 
      id="start-duplicate-detection-btn"
      onclick="startDuplicateDetection({{ raw_data_file.id }}); return false;"
      class="btn btn-primary"
      style="display: flex; align-items: center; gap: 0.5rem;"
      type="button"
    >
      <i class="fas fa-search"></i> Check for Duplicates
    </button>
  </div>

  <p class="text-muted" style="font-size: 0.95rem; margin-bottom: 1.5rem;">
    Click the button above to scan for duplicate observations and data conflicts. 
    This identifies true duplicates (identical values) and conflicts (same context but different values).
  </p>

  <!-- Loading State -->
  <div id="duplicate-detection-loading" style="display: none; text-align: center; padding: 3rem 0;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p style="margin-top: 1rem; color: #666;">Scanning observations for duplicates and conflicts...</p>
    <small style="color: #999;">This may take a few moments for large datasets</small>
  </div>

  <!-- Results Container -->
  <div id="duplicate-detection-results">
    <div style="background: #E7F3FF; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--info-color);">
      <div style="display: flex; align-items: start; gap: 1rem;">
        <i class="fas fa-info-circle" style="color: var(--info-color); font-size: 1.5rem; margin-top: 0.25rem;"></i>
        <div>
          <strong>Ready to scan</strong>
          <p style="margin: 0.5rem 0 0 0; color: #666;">
            Click "Check for Duplicates" to identify:
          </p>
          <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: #666;">
            <li><strong>Exact Duplicates:</strong> Identical observations that can be safely removed</li>
            <li><strong>Data Conflicts:</strong> Same patient/attribute/time/location with different values</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let duplicateDetectionInterval = null;

// Simple hash function for de-identifying patient IDs
function hashPatientId(patientId) {
  if (!patientId || patientId === 'N/A') return 'N/A';
  
  // Simple hash to create consistent but de-identified ID
  let hash = 0;
  const str = String(patientId);
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  
  // Return as hex with prefix
  const hexHash = Math.abs(hash).toString(16).padStart(8, '0').toUpperCase();
  return `PT-${hexHash.substring(0, 6)}`;
}

// Function to get CSRF token from cookie
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  
  return cookieValue;
}

function getCSRFToken() {
  // First, try the hidden input we added specifically for this (works with CSRF_COOKIE_HTTPONLY = True)
  const hiddenInput = document.getElementById('csrf-token-duplicate-detection');
  if (hiddenInput && hiddenInput.value) {
    return hiddenInput.value;
  }
  
  // Try to get from cookie (won't work if CSRF_COOKIE_HTTPONLY = True)
  let token = getCookie('csrftoken');
  
  // Fallback to form token if cookie not found
  if (!token) {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
      token = csrfInput.value;
    }
  }
  
  return token;
}

function startDuplicateDetection(fileId) {
  const btn = document.getElementById('start-duplicate-detection-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scanning...';
  
  document.getElementById('duplicate-detection-loading').style.display = 'block';
  document.getElementById('duplicate-detection-results').style.display = 'none';
  
  // Get CSRF token
  const csrfToken = getCSRFToken();
  if (!csrfToken) {
    console.error('CSRF token not found');
    showError('Security token not found. Please refresh the page.');
    resetButton();
    return;
  }
  
  fetch(`/health/raw-data/${fileId}/duplicates/start/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json',
    },
    credentials: 'same-origin',
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => {
        throw new Error(`Server returned ${response.status}: ${text}`);
      });
    }
    return response.text();
  })
  .then(data => {
    // Start polling for status
    duplicateDetectionInterval = setInterval(() => checkStatus(fileId), 2000);
  })
  .catch(error => {
    console.error('Error starting task:', error);
    showError('Failed to start duplicate detection: ' + error.message);
    resetButton();
  });
}

function checkStatus(fileId) {
  fetch(`/health/raw-data/${fileId}/duplicates/status/`)
    .then(response => {
      if (!response.ok) throw new Error('Status check failed');
      return response.json();
    })
    .then(data => {
      if (data.status === 'completed') {
        clearInterval(duplicateDetectionInterval);
        displayResults(data, fileId);
        resetButton();
      } else if (data.status === 'failed') {
        console.error('Task failed:', data.message);
        clearInterval(duplicateDetectionInterval);
        showError(data.message || 'Duplicate detection failed');
        resetButton();
      } else if (data.status === 'running') {
        // Update progress message
        updateProgress('Scanning observations... Please wait.');
      }
    })
    .catch(error => {
      console.error('Error checking status:', error);
      clearInterval(duplicateDetectionInterval);
      showError('Error checking status: ' + error.message);
      resetButton();
    });
}

function displayResults(data, fileId) {
  document.getElementById('duplicate-detection-loading').style.display = 'none';
  const resultsDiv = document.getElementById('duplicate-detection-results');
  resultsDiv.style.display = 'block';
  
  const duplicates = data.duplicates || {};
  const conflicts = data.conflicts || {};
  const totalDups = duplicates.total_duplicates || 0;
  const totalConflicts = conflicts.total_conflicts || 0;
  const dupGroups = duplicates.duplicate_groups || 0;
  const conflictGroups = conflicts.total_conflict_groups || 0;
  
  // Get data type context (source vs transformed)
  const isSource = duplicates.is_source !== undefined ? duplicates.is_source : true;
  const dataType = duplicates.data_type || 'source';
  
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">';
  
  // Duplicates card
  html += `<div style="background: ${totalDups > 0 ? '#FFF3CD' : '#D1ECF1'}; padding: 1rem; border-radius: 8px; border-left: 4px solid ${totalDups > 0 ? 'var(--warning-color)' : 'var(--info-color)'};">
    <div style="font-size: 2rem; font-weight: 600; color: ${totalDups > 0 ? 'var(--warning-color)' : 'var(--info-color)'};">${totalDups.toLocaleString()}</div>
    <div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">True Duplicates</div>
    ${dupGroups > 0 ? `<div style="color: #666; font-size: 0.8rem; margin-top: 0.25rem;">in ${dupGroups} groups</div>` : ''}
  </div>`;
  
  // Conflicts card
  html += `<div style="background: ${totalConflicts > 0 ? '#F8D7DA' : '#D1ECF1'}; padding: 1rem; border-radius: 8px; border-left: 4px solid ${totalConflicts > 0 ? 'var(--danger-color)' : 'var(--info-color)'};">
    <div style="font-size: 2rem; font-weight: 600; color: ${totalConflicts > 0 ? 'var(--danger-color)' : 'var(--info-color)'};">${totalConflicts.toLocaleString()}</div>
    <div style="color: #666; font-size: 0.9rem; margin-top: 0.25rem;">Data Conflicts</div>
    ${conflictGroups > 0 ? `<div style="color: #666; font-size: 0.8rem; margin-top: 0.25rem;">${conflictGroups} groups need review</div>` : ''}
  </div>`;
  
  html += '</div>';
  
  // Data type context message
  if (isSource) {
    html += '<div style="background: #FFF3CD; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">';
    html += '<strong><i class="fas fa-upload"></i> Source Data:</strong> ';
    html += 'Duplicates in raw uploaded data should typically be removed to ensure data quality.';
    html += '</div>';
  } else {
    html += '<div style="background: #E7F3FF; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">';
    html += '<strong><i class="fas fa-sync-alt"></i> Transformed Data:</strong> ';
    html += 'Some duplicates may be expected after harmonisation if multiple sources map to the same target values.';
    html += '</div>';
  }
  
  // Duplicates table
  if (totalDups > 0 && duplicates.duplicates && duplicates.duplicates.length > 0) {
    html += '<h3 style="font-size: 1.1rem; margin-top: 2rem; margin-bottom: 1rem; font-weight: 600;">Exact Duplicates Found</h3>';
    html += '<div style="background: #E7F3FF; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; color: #666;">';
    html += '<i class="fas fa-shield-alt" style="color: var(--info-color);"></i> Patient IDs are de-identified for privacy';
    html += '</div>';
    html += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1rem;">';
    html += '<table class="table" style="margin: 0;"><thead style="position: sticky; top: 0; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<tr><th>Patient ID</th><th>Attribute</th><th>Value</th><th>Count</th></tr></thead><tbody>';
    
    duplicates.duplicates.forEach(dup => {
      const hashedPatient = hashPatientId(dup.patient);
      html += `<tr>
        <td><code style="font-family: monospace; color: #666;">${hashedPatient}</code></td>
        <td>${dup.attribute}</td>
        <td>${dup.value}</td>
        <td><span class="badge" style="background: var(--warning-color);">${dup.count}</span></td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
    
    // Cleanup button - now uses background task
    html += `<button 
      type="button" 
      id="delete-duplicates-btn-${fileId}"
      onclick="startDeleteDuplicates(${fileId}, ${totalDups}); return false;"
      class="btn btn-warning">
      <i class="fas fa-trash-alt"></i> Clean Up Duplicates
    </button>`;
    
    // Delete progress container
    html += `<div id="delete-duplicates-progress-${fileId}" style="display: none; margin-top: 1rem; background: #E7F3FF; padding: 1rem; border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 0.75rem;">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span>Deleting duplicates in background...</span>
      </div>
    </div>`;
  }
  
  // Conflicts table
  if (totalConflicts > 0 && conflicts.conflicts && conflicts.conflicts.length > 0) {
    html += '<h3 style="font-size: 1.1rem; margin-top: 2rem; margin-bottom: 1rem; font-weight: 600;">Data Conflicts Found</h3>';
    html += '<div style="background: #FFF3CD; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
    html += '<small>⚠️ These require manual review - same context but different values</small><br>';
    html += '<small style="color: #666;"><i class="fas fa-shield-alt"></i> Patient IDs are de-identified for privacy</small>';
    html += '</div>';
    html += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">';
    html += '<table class="table" style="margin: 0;"><thead style="position: sticky; top: 0; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<tr><th>Patient ID</th><th>Attribute</th><th>Values</th><th>Count</th></tr></thead><tbody>';
    
    conflicts.conflicts.forEach(conflict => {
      const hashedPatient = hashPatientId(conflict.patient);
      const valuesBadges = conflict.values.map(v => `<span class="badge" style="background: var(--danger-color); margin-right: 0.25rem;">${v}</span>`).join('');
      html += `<tr>
        <td><code style="font-family: monospace; color: #666;">${hashedPatient}</code></td>
        <td>${conflict.attribute}</td>
        <td>${valuesBadges}</td>
        <td>${conflict.count}</td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
  }
  
  // Success message
  if (totalDups === 0 && totalConflicts === 0) {
    html = '<div style="background: #D4EDDA; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--success-color);"><i class="fas fa-check-circle" style="color: var(--success-color);"></i> <strong>Data looks clean!</strong> No duplicates or conflicts found.</div>';
  }
  
  resultsDiv.innerHTML = html;
}

function showError(message) {
  document.getElementById('duplicate-detection-loading').style.display = 'none';
  const resultsDiv = document.getElementById('duplicate-detection-results');
  resultsDiv.style.display = 'block';
  resultsDiv.innerHTML = `<div style="background: #F8D7DA; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--danger-color);"><i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> <strong>Error:</strong> ${message}</div>`;
}

function updateProgress(message) {
  const loadingDiv = document.getElementById('duplicate-detection-loading');
  const progressText = loadingDiv.querySelector('p');
  if (progressText) {
    progressText.textContent = message;
  }
}

function resetButton() {
  const btn = document.getElementById('start-duplicate-detection-btn');
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-search"></i> Check for Duplicates';
  }
}

// Delete duplicates with background task
let deleteDuplicatesInterval = null;

function startDeleteDuplicates(fileId, totalDups) {
  if (!confirm(`Delete ${totalDups} duplicate observations? This will keep the first occurrence of each duplicate.`)) {
    return;
  }
  
  const btn = document.getElementById(`delete-duplicates-btn-${fileId}`);
  const progressDiv = document.getElementById(`delete-duplicates-progress-${fileId}`);
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';
  progressDiv.style.display = 'block';
  
  // Get CSRF token
  const csrfToken = getCSRFToken();
  if (!csrfToken) {
    console.error('CSRF token not found');
    alert('Security token not found. Please refresh the page.');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clean Up Duplicates';
    progressDiv.style.display = 'none';
    return;
  }
  
  fetch(`/health/raw-data/${fileId}/duplicates/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json',
    },
    credentials: 'same-origin',
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => {
        throw new Error(`Server returned ${response.status}: ${text}`);
      });
    }
    return response.text();
  })
  .then(data => {
    // Start polling for status
    deleteDuplicatesInterval = setInterval(() => checkDeleteStatus(fileId), 2000);
  })
  .catch(error => {
    console.error('Error starting delete task:', error);
    alert('Failed to start deletion: ' + error.message);
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clean Up Duplicates';
    progressDiv.style.display = 'none';
  });
}

function checkDeleteStatus(fileId) {
  fetch(`/health/raw-data/${fileId}/duplicates/delete/status/`)
    .then(response => {
      if (!response.ok) throw new Error('Status check failed');
      return response.json();
    })
    .then(data => {
      if (data.status === 'completed') {
        clearInterval(deleteDuplicatesInterval);
        
        const btn = document.getElementById(`delete-duplicates-btn-${fileId}`);
        const progressDiv = document.getElementById(`delete-duplicates-progress-${fileId}`);
        
        if (data.success) {
          // Show success message
          progressDiv.innerHTML = `
            <div style="background: #D4EDDA; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success-color);">
              <i class="fas fa-check-circle" style="color: var(--success-color);"></i> 
              <strong>Success!</strong> ${data.message}
            </div>`;
          
          // Hide the button
          btn.style.display = 'none';
          
          // Reload page after 2 seconds to show updated data
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          // Show error
          progressDiv.innerHTML = `
            <div style="background: #F8D7DA; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--danger-color);">
              <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> 
              <strong>Error:</strong> ${data.message}
            </div>`;
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clean Up Duplicates';
        }
      } else if (data.status === 'failed') {
        console.error('Delete task failed:', data.message);
        clearInterval(deleteDuplicatesInterval);
        
        const btn = document.getElementById(`delete-duplicates-btn-${fileId}`);
        const progressDiv = document.getElementById(`delete-duplicates-progress-${fileId}`);
        
        progressDiv.innerHTML = `
          <div style="background: #F8D7DA; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--danger-color);">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> 
            <strong>Failed:</strong> ${data.message}
          </div>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clean Up Duplicates';
      } else if (data.status === 'running') {
        // Still running
      }
    })
    .catch(error => {
      console.error('Error checking delete status:', error);
      clearInterval(deleteDuplicatesInterval);
      
      const btn = document.getElementById(`delete-duplicates-btn-${fileId}`);
      const progressDiv = document.getElementById(`delete-duplicates-progress-${fileId}`);
      
      alert('Error checking deletion status: ' + error.message);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clean Up Duplicates';
      progressDiv.style.display = 'none';
    });
}

</script>
