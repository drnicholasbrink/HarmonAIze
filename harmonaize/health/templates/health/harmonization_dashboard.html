{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Harmonization Dashboard" }}{% endblock %}

{% block css %}
  {{ block.super }}
  
  <!-- Include ACE Editor Media -->
  {% for variable_form in variable_forms %}
    {{ variable_form.form.media.css }}
  {% endfor %}
  
  <style>
    :root {
      --primary-color: #007AFF;
      --secondary-color: #5AC8FA;
      --accent-color: #34C759;
      --health-color: #FF6B6B;
      --warning-color: #FF9500;
      --background-color: #F2F2F7;
      --card-background: #FFFFFF;
      --text-primary: #1C1C1E;
      --text-secondary: #8E8E93;
      --border-color: #C6C6C8;
      --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
    }

    body {
      background-color: var(--background-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .hero-section {
      background: var(--primary-color);
      color: white;
      padding: 2rem 0;
      margin: -1rem -15px 0 -15px;
      text-align: center;
    }

    .hero-header {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .hero-content h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .hero-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 1.5rem;
    }

    .progress-section {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius);
      padding: 1rem 1.5rem;
      backdrop-filter: blur(10px);
      display: inline-block;
      min-width: 300px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .progress-stats {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .progress-bar-container {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      height: 8px;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
      height: 100%;
      border-radius: 50px;
      transition: width 0.5s ease;
    }

    .hero-actions {
      display: flex;
      gap: 1rem;
      flex-shrink: 0;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      font-weight: 500;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .main-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 2rem;
    }

    /* Breadcrumb Styles */
    .breadcrumb {
      background: transparent;
      padding: 1rem 0;
      margin-bottom: 0;
      border-radius: 0;
      font-size: 0.9rem;
    }

    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .breadcrumb-item a:hover {
      text-decoration: underline;
    }

    .breadcrumb-item.active {
      color: var(--text-secondary);
    }

    .breadcrumb-item + .breadcrumb-item::before {
      content: ">";
      color: var(--text-secondary);
      margin: 0 0.5rem;
    }

    .navigation-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Study Selection Panel */
    .study-selection-panel {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin: 1.5rem auto 0 auto;
      max-width: 1200px;
    }

    .study-selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1.5rem;
      align-items: end;
    }

    .study-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .study-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .study-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      padding: 0.75rem;
      background: var(--background-color);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    /* Universal Settings Panel */
    .settings-panel {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 2rem;
      grid-column: 1 / -1;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .settings-title {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-select, .form-input {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-select:focus, .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Variables Section */
    .variables-section {
      grid-column: 1;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .filter-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .filter-select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .search-input {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      width: 200px;
    }

    /* Variable Cards */
    .variable-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
      transition: all 0.2s;
    }

    .variable-card:hover {
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
    }

    .variable-card.complete {
      border-left: 4px solid var(--accent-color);
    }

    .variable-card.incomplete {
      border-left: 4px solid var(--warning-color);
    }

    .variable-card.not-mappable {
      border-left: 4px solid #ff9800;
      background: #f5f5f5;
      opacity: 0.7;
    }

    .variable-card.not-mappable .variable-content {
      opacity: 0.6;
    }

    .variable-card.not-mappable .source-attribute-details,
    .variable-card.not-mappable .mapping-form {
      filter: grayscale(50%);
    }

    .variable-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(45deg, #f8f9fa 0%, #ffffff 100%);
    }

    .variable-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .variable-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .completion-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .badge-complete {
      background: var(--accent-color);
      color: white;
    }

    .badge-incomplete {
      background: var(--warning-color);
      color: white;
    }

    .badge-not-mappable {
      background: #ff9800;
      color: white;
    }

    /* ACE Editor Professional Styling */
    .ace_editor {
      border: 2px solid var(--border-color) !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace !important;
      transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
    }
    
    .ace_editor.ace_focus {
      border-color: var(--primary-color) !important;
      box-shadow: 0 2px 12px rgba(0, 122, 255, 0.2) !important;
    }
    
    .ace_gutter {
      background: #f8f9fa !important;
      border-right: 1px solid var(--border-color) !important;
    }
    
    .ace_gutter-active-line {
      background: rgba(0, 122, 255, 0.1) !important;
    }
    
    .ace_active-line {
      background: rgba(0, 122, 255, 0.05) !important;
    }
    
    .ace_cursor {
      color: var(--primary-color) !important;
    }
    
    .ace_selection {
      background: rgba(0, 122, 255, 0.2) !important;
    }
    
    .ace_marker-layer .ace_selected-word {
      background: rgba(0, 122, 255, 0.15) !important;
      border: 1px solid rgba(0, 122, 255, 0.3) !important;
    }
    
    .ace_print-margin {
      background: rgba(255, 152, 0, 0.1) !important;
    }
    
    /* Enhanced annotations/linting styles */
    .ace_error {
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH2QUFCQsTj3XBagAAAAlwSFlzAAAOwwAADsMBx2+oZAAAABJpVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVDBhvOXAAAAJElEQVQI12P4//8/AzoYkACgoALDAIBBgUELQIBBCUADQQVAEQEBqWQQgwAAAABJRU5ErkJggg==") !important;
      background-repeat: repeat-x !important;
      background-position: left bottom !important;
    }
    
    .ace_warning {
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH2QUFCgsn8CV8VgAAAAlwSFlzAAAOwwAADsMBx2+oZAAAABJpVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVDBhvOXAAAAJElEQVQI12P4DwR/gABCAhDwAwhKQCxAQP8A8Q8I+AEE/hAAqGMfQAI/AHsAAAAASUVORK5CYII=") !important;
      background-repeat: repeat-x !important;
      background-position: left bottom !important;
    }
    
    .ace_info {
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH2QUFCgkzIHh9WgAAAAlwSFlzAAAOwwAADsMBx2+oZAAAABJpVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVDBhvOXAAAAJElEQVQI12P4DwABAP8A/wHJDAABAP8A/wHJDAABAP8A/wHJDAABAP8A/wHJA9QP/wHoANfAAAAAAElFTkSuQmCC") !important;
      background-repeat: repeat-x !important;
      background-position: left bottom !important;
    }
    
    /* Tooltip styling for ace editor */
    .ace_tooltip {
      background: #333 !important;
      color: white !important;
      border-radius: 6px !important;
      padding: 8px 12px !important;
      font-size: 12px !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
      max-width: 300px !important;
      z-index: 1000 !important;
    }
    
    /* Autocomplete popup styling */
    .ace_autocomplete {
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
      background: white !important;
      max-height: 200px !important;
    }
    
    .ace_autocomplete .ace_completion-highlight {
      color: var(--primary-color) !important;
      font-weight: bold !important;
    }
    
    .ace_autocomplete .ace_completion-meta {
      color: #666 !important;
      font-style: italic !important;
    }

    /* Source Attribute Details */
    .source-attribute-details {
      background: #f8f9fa;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .attribute-section-title {
      color: var(--primary-color);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .attribute-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .info-item.full-width {
      grid-column: 1 / -1;
    }
    
    .info-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .info-value {
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Target Attribute Details */
    .target-attribute-details {
      background: #f0f8ff;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border: 1px solid #b3d9ff;
    }
    
    .target-section-title {
      color: var(--info-color);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .target-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    /* Not Mappable Section - Horizontal at Bottom */
    .not-mappable-section-bottom {
      background: #fff8f0;
      padding: 1rem;
      border-top: 1px solid #ffcc80;
      border-radius: 0 0 8px 8px;
      margin-top: 1rem;
    }
    
    .checkbox-wrapper-horizontal {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .checkbox-label-horizontal {
      font-weight: 600;
      color: #007AFF;
      cursor: pointer;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }
    
    .help-text-inline {
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-style: italic;
      margin-left: auto;
    }

    /* Not Mappable Section */
    .not-mappable-section {
      background: #fff8f0;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #ffcc80;
      margin-bottom: 1rem;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .checkbox-label {
      font-weight: 600;
      color: #ff9800;
      cursor: pointer;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .not-mappable-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Advanced Options */
    .advanced-options {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      border: 1px solid #ddd;
    }
    
    .advanced-title {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Form Enhancements */
    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .help-text {
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-top: 0.25rem;
      line-height: 1.4;
    }
    
    .code-help {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      border-left: 3px solid var(--info-color);
    }
    
    .code-help code {
      background: #e9ecef;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .variable-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .variable-content {
      padding: 1.5rem;
    }

    .mapping-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .mapping-form .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-textarea {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 80px;
    }

    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    /* Code Examples Toolbar */
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .code-header .form-label {
      margin-bottom: 0;
    }

    .code-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .code-buttons .btn {
      white-space: nowrap;
    }

    .example-section {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 1rem;
    }

    .example-section h6 {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .example-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .example-buttons .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .example-buttons .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .example-buttons .btn i {
      margin-right: 0.3rem;
      font-size: 0.75rem;
    }

    /* ACE Editor Styling */
    .ace_editor {
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
    }

    .ace_editor.ace_focus {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1) !important;
    }

    /* Code Help Section */
    .code-help details {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      background: #fafafa;
    }

    .code-help summary {
      padding: 0.75rem;
      font-weight: 600;
      border-radius: 6px 6px 0 0;
      background: #f1f3f4;
    }

    .code-help details[open] summary {
      border-bottom: 1px solid #e9ecef;
      border-radius: 6px 6px 0 0;
    }

    .code-help pre {
      background: #2d3748;
      color: #e2e8f0;
      border-radius: 4px;
      padding: 0.75rem;
      font-size: 0.85rem;
      overflow-x: auto;
      margin: 0.5rem 0;
    }

    .code-help code {
      background: #f7fafc;
      color: #2d3748;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.85rem;
    }

    .relationship-section {
      display: none;
      grid-column: 1 / -1;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .variable-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .btn-success {
      background: var(--accent-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    /* Sidebar */
    .sidebar {
      grid-column: 2;
    }

    .sidebar-section {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .sidebar-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      gap: 1rem;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--background-color);
      border-radius: 8px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .stat-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .bulk-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .action-btn {
      width: 100%;
      justify-content: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
        padding: 0 1rem;
      }

      .hero-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
        padding: 0 1rem;
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }

      .mapping-form {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }
    }

    /* Auto-save indicator */
    .auto-save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .auto-save-indicator.show {
      opacity: 1;
    }

    /* Error styling */
    .form-group.error .form-select,
    .form-group.error .form-input,
    .form-group.error .form-textarea {
      border-color: #dc3545;
    }

    .error-message {
      color: #dc3545;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }

    /* Similarity Suggestions Styling */
    .similarity-suggestions {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
    }

    .suggestions-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .suggestions-loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .suggestions-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .suggestion-item {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .suggestion-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
      transform: translateY(-1px);
    }

    .suggestion-item.selected {
      border-color: var(--primary-color);
      background: rgba(0, 122, 255, 0.05);
    }

    .suggestion-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .suggestion-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .confidence-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .confidence-badge.success {
      background: rgba(52, 199, 89, 0.15);
      color: #34c759;
    }

    .confidence-badge.info {
      background: rgba(90, 200, 250, 0.15);
      color: #5ac8fa;
    }

    .confidence-badge.warning {
      background: rgba(255, 149, 0, 0.15);
      color: #ff9500;
    }

    .confidence-badge.danger {
      background: rgba(255, 59, 48, 0.15);
      color: #ff3b30;
    }

    .confidence-badge.secondary {
      background: rgba(142, 142, 147, 0.15);
      color: #8e8e93;
    }

    .suggestion-details {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .suggestion-scores {
      margin-top: 0.5rem;
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
    }

    .score-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .score-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .suggestions-empty {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      padding: 1rem;
    }

    .suggestions-error {
      text-align: center;
      color: #dc3545;
      padding: 1rem;
      background: rgba(220, 53, 69, 0.05);
      border-radius: 6px;
    }

    .show-suggestions-btn {
      background: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 0.5rem;
    }

    .show-suggestions-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .show-suggestions-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .ai-progress {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1rem;
    }
    
    .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: #495057;
    }
    
    .progress {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* Target Variable Details */
    .target-variable-details {
        background: linear-gradient(135deg, #e0f2fe 0%, #f1f8ff 100%);
        border: 1px solid #b3e5fc;
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .target-details-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #1976d2;
    }
    
    .target-details-content {
        display: grid;
        gap: 0.5rem;
    }
    
    .detail-row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 0.5rem;
        align-items: start;
    }
    
    .detail-label {
        font-weight: 600;
        color: #546e7a;
        font-size: 0.875rem;
    }
    
    .detail-value {
        color: #37474f;
        font-size: 0.875rem;
        word-break: break-word;
    }

    /* AI Suggestions Dropdown */
    .ai-suggestions-dropdown {
        background: #fff;
        border: 2px solid #e3f2fd;
        border-radius: 12px;
        margin-top: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .ai-suggestions-dropdown.has-suggestions {
        border-color: #2196f3;
        box-shadow: 0 4px 16px rgba(33, 150, 243, 0.1);
    }
    
    .dropdown-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
        border-bottom: 1px solid #dee2e6;
    }
    
    .dropdown-header:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    
    .dropdown-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #495057;
    }
    
    .dropdown-arrow {
        color: #6c757d;
        transition: transform 0.2s ease;
    }
    
    .dropdown-header.expanded .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    .dropdown-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .dropdown-content.expanded {
        max-height: 400px;
    }
    
    .suggestions-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .suggestion-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa;
        border-left: 4px solid #2196f3;
        padding-left: calc(1rem - 4px);
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-main {
        flex: 1;
    }
    
    .suggestion-name {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.25rem;
    }
    
    .suggestion-description {
        font-size: 0.875rem;
        color: #6c757d;
        line-height: 1.4;
        margin-bottom: 0.5rem;
    }
    
    .suggestion-scores {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .score-detail {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .score-detail i {
        width: 12px;
        opacity: 0.7;
    }
    
    .score-detail.combined-score {
        color: #495057;
        font-weight: 600;
    }
    
    .score-detail strong {
        color: #212529;
    }
    
    .suggestion-confidence {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
    }
    
    .confidence-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .confidence-score {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .dropdown-help {
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        font-size: 0.875rem;
        color: #6c757d;
        border-top: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Confidence indicator styles */
    .confidence-indicator {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        margin-left: 0.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .confidence-excellent {
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    
    .confidence-good {
        background-color: #d1ecf1;
        color: #055160;
        border: 1px solid #b8daff;
    }
    
    .confidence-fair {
        background-color: #fff3cd;
        color: #664d03;
        border: 1px solid #ffdf7e;
    }
    
    .confidence-poor {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f1aeb5;
    }
  </style>
{% endblock %}

{% block content %}
<div class="hero-section">
  <div class="hero-header">
    <div class="hero-content">
      <h1>Harmonise Study Dashboard</h1>
      <p class="hero-subtitle">Manage variable mappings and track harmonisation progress</p>
      {% if schema and schema.source_study.status == 'harmonised' %}
      <div class="alert alert-success mt-3" role="alert">
        This study has been <strong>harmonised</strong>.
        <a class="alert-link" href="{% url 'core:study_detail' schema.source_study.pk %}">View study details</a>
      </div>
      {% elif schema and schema.status == 'approved' %}
      <div class="alert alert-info mt-3" role="alert">
        Mapping approved. Transformation running in background. You can <a class="alert-link" href="{% url 'core:study_detail' schema.source_study.pk %}">monitor from study page</a> or finalize when ready below.
      </div>
      {% endif %}
      
      {% if not creating_new %}
      <div class="progress-section">
        <div class="progress-header">
          <span>Progress</span>
          <span class="progress-stats">{{ completed_rules }}/{{ total_variables }} variables mapped</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: {{ progress_percent }}%"></div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Study Selection Panel -->
<div class="study-selection-panel">
  <form method="post" id="study-selection-form">
    {% csrf_token %}
    <div class="study-selection-grid">
      <div class="study-info">
        <label class="study-label">Source Study</label>
        <div class="study-value">{% if creating_new %}{{ study.name }}{% else %}{{ schema.source_study.name }}{% endif %}</div>
      </div>
      
      <div class="form-group" style="margin: 0;">
        <label class="form-label study-label">Target Database</label>
        {{ universal_form.target_study }}
        {% if universal_form.target_study.errors %}
          <div class="error-message">
            {% for error in universal_form.target_study.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      
      <div>
        <button type="submit" name="update_universal_settings" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Update
        </button>
      </div>
    </div>
    
    <!-- Hidden fields to preserve other universal settings -->
    {{ universal_form.universal_patient_id.as_hidden }}
    {{ universal_form.universal_datetime.as_hidden }}
    {{ universal_form.universal_relation_type.as_hidden }}
    {{ universal_form.comments.as_hidden }}
  </form>
</div>



<!-- Navigation Breadcrumbs -->
<div class="navigation-wrapper">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
      {% if creating_new %}
        {% if study.project %}
          <li class="breadcrumb-item"><a href="{% url 'core:project_list' %}">Projects</a></li>
          <li class="breadcrumb-item"><a href="{% url 'core:project_detail' study.project.pk %}">{{ study.project.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item"><a href="{% url 'core:study_detail' study.pk %}">{{ study.name }}</a></li>
      {% else %}
        {% if schema.source_study.project %}
          <li class="breadcrumb-item"><a href="{% url 'core:project_list' %}">Projects</a></li>
          <li class="breadcrumb-item"><a href="{% url 'core:project_detail' schema.source_study.project.pk %}">{{ schema.source_study.project.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item"><a href="{% url 'core:study_detail' schema.source_study.pk %}">{{ schema.source_study.name }}</a></li>
      {% endif %}
      <li class="breadcrumb-item active">Harmonise Dashboard</li>
    </ol>
  </nav>
</div>

{% if creating_new %}
<!-- Schema Creation Form -->
<div class="main-container" style="grid-template-columns: 1fr;">
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">
        <i class="fas fa-plus-circle"></i>
        Create Harmonization Schema
      </h2>
      <p class="hero-subtitle">Set up the mapping configuration for {{ study.name }}</p>
    </div>

    <form method="post">
      {% csrf_token %}
      <div class="settings-grid">
        <div class="form-group">
          <label class="form-label">Target Study</label>
          {{ form.target_study }}
          {% if form.target_study.errors %}
            <div class="error-message">
              {% for error in form.target_study.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Select the target database to harmonize this study with</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default Patient ID Variable</label>
          {{ form.universal_patient_id }}
          {% if form.universal_patient_id.errors %}
            <div class="error-message">
              {% for error in form.universal_patient_id.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Default patient identifier for all mappings</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default DateTime Variable</label>
          {{ form.universal_datetime }}
          {% if form.universal_datetime.errors %}
            <div class="error-message">
              {% for error in form.universal_datetime.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Default timestamp variable for all mappings</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default Relationship Type</label>
          {{ form.universal_relation_type }}
          {% if form.universal_relation_type.errors %}
            <div class="error-message">
              {% for error in form.universal_relation_type.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Default relationship type for all mappings</small>
        </div>
        
        <div class="form-group full-width">
          <label class="form-label">Comments</label>
          {{ form.comments }}
          {% if form.comments.errors %}
            <div class="error-message">
              {% for error in form.comments.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Optional notes about this harmonization schema</small>
        </div>
      </div>

      <div class="variable-actions">
        <a href="{% url 'core:study_detail' study.pk %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Cancel
        </a>
        <button type="submit" class="btn btn-success">
          <i class="fas fa-plus-circle"></i>
          Create Schema
        </button>
      </div>
    </form>
  </div>
</div>

{% else %}
<!-- Existing Harmonization Dashboard -->
<div class="main-container">
  <!-- Universal Settings Panel -->
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">
        <i class="fas fa-cog"></i>
        Universal Settings
      </h2>
      <button type="button" class="btn btn-outline btn-small" onclick="toggleSettingsForm()">
        <i class="fas fa-edit"></i>
        Edit Settings
      </button>
    </div>

    {% if universal_form %}
    <form method="post" id="universal-settings-form" style="display: none;">
      {% csrf_token %}
      <div class="settings-grid">
        <div class="form-group">
          <label class="form-label">Default Patient ID Variable</label>
          {{ universal_form.universal_patient_id }}
          {% if universal_form.universal_patient_id.errors %}
            <div class="error-message">
              {% for error in universal_form.universal_patient_id.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label">Default DateTime Variable</label>
          {{ universal_form.universal_datetime }}
          {% if universal_form.universal_datetime.errors %}
            <div class="error-message">
              {% for error in universal_form.universal_datetime.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label">Default Relationship Type</label>
          {{ universal_form.universal_relation_type }}
          {% if universal_form.universal_relation_type.errors %}
            <div class="error-message">
              {% for error in universal_form.universal_relation_type.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Hidden field to preserve target_study when updating universal settings -->
      {{ universal_form.target_study.as_hidden }}

      <div class="variable-actions">
        <button type="button" class="btn btn-secondary btn-small" onclick="toggleSettingsForm()">Cancel</button>
        <button type="submit" name="update_universal_settings" class="btn btn-success btn-small">
          <i class="fas fa-check"></i>
          Save Universal Settings
        </button>
      </div>
    </form>
    {% endif %}

    <!-- Current Settings Display -->
    {% if universal_form %}
    <div id="settings-display">
      <div class="settings-grid">
        <div class="stat-item">
          <span class="stat-label">Patient ID</span>
          <span class="stat-value">{{ schema.universal_patient_id.variable_name|default:"Not set" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">DateTime</span>
          <span class="stat-value">{{ schema.universal_datetime.variable_name|default:"Not set" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Relationship</span>
          <span class="stat-value">{{ schema.get_universal_relation_type_display|default:"Self" }}</span>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Variables Section -->
  <div class="variables-section">
    <div class="section-header">
      <h2 class="section-title">Variable Mappings</h2>
      <div class="filter-controls">
        <select class="filter-select" id="completion-filter">
          <option value="all">All Variables</option>
          <option value="complete">Mapped Only</option>
          <option value="incomplete">Unmapped Only</option>
          <option value="not-mappable">Not Mappable Only</option>
        </select>
        <input type="text" class="search-input" id="search-variables" placeholder="Search variables...">
      </div>
    </div>

    <form method="post" id="mappings-form">
      {% csrf_token %}
      
  {% for variable_form in variable_forms %}
  <div class="variable-card {% if variable_form.instance.not_mappable %}not-mappable{% elif variable_form.is_complete %}complete{% else %}incomplete{% endif %}" 
       data-variable-name="{{ variable_form.attribute.variable_name|lower }}"
       data-completion="{% if variable_form.instance.not_mappable %}not-mappable{% elif variable_form.is_complete %}complete{% else %}incomplete{% endif %}">
        
        <div class="variable-header">
          <div class="variable-title">
            <span class="variable-name">{{ variable_form.attribute.display_name|default:variable_form.attribute.variable_name }}</span>
            <span class="completion-badge {% if variable_form.instance.not_mappable %}badge-not-mappable{% elif variable_form.is_complete %}badge-complete{% else %}badge-incomplete{% endif %}">
              {% if variable_form.instance.not_mappable %}
                <i class="fas fa-ban"></i> Not Mappable
              {% elif variable_form.is_complete %}
                <i class="fas fa-check"></i> Mapped
              {% else %}
                <i class="fas fa-exclamation-triangle"></i> Needs Mapping
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Source Attribute Details -->
        <div class="source-attribute-details">
          <h4 class="attribute-section-title">
            <i class="fas fa-upload"></i> Source Attribute
          </h4>
          <div class="attribute-info-grid">
            <div class="info-item">
              <span class="info-label">Variable Name:</span>
              <span class="info-value">{{ variable_form.attribute.variable_name }}</span>
            </div>
            {% if variable_form.attribute.display_name %}
            <div class="info-item">
              <span class="info-label">Display Name:</span>
              <span class="info-value">{{ variable_form.attribute.display_name }}</span>
            </div>
            {% endif %}
            {% if variable_form.attribute.description %}
            <div class="info-item full-width">
              <span class="info-label">Description:</span>
              <span class="info-value">{{ variable_form.attribute.description }}</span>
            </div>
            {% endif %}
            <div class="info-item">
              <span class="info-label">Data Type:</span>
              <span class="info-value">{{ variable_form.attribute.variable_type|default:"Unknown" }}</span>
            </div>
            {% if variable_form.attribute.unit %}
            <div class="info-item">
              <span class="info-label">Unit:</span>
              <span class="info-value">{{ variable_form.attribute.unit }}</span>
            </div>
            {% endif %}
            {% if variable_form.attribute.ontology_code %}
            <div class="info-item">
              <span class="info-label">Ontology Code:</span>
              <span class="info-value">{{ variable_form.attribute.ontology_code }}</span>
            </div>
            {% endif %}
            {% if variable_form.attribute.values_count %}
            <div class="info-item">
              <span class="info-label">Unique Values:</span>
              <span class="info-value">{{ variable_form.attribute.values_count }}</span>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="variable-content">
          <div class="mapping-form">
            <div class="mapping-fields" style="{% if variable_form.instance.not_mappable %}display: none;{% endif %}">
              <!-- Target Attribute Selection -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-download"></i> Target Variable
                  <span class="confidence-indicator" id="confidence-{{ variable_form.attribute.id }}" style="display: none;"></span>
                </label>
                {{ variable_form.form.target_attribute }}
                {% if variable_form.form.target_attribute.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.target_attribute.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="help-text">Select the target variable this source variable maps to</small>
              </div>
              <!-- Target Attribute Details (populated via JavaScript) -->
              <div class="target-attribute-details" id="target-details-{{ variable_form.attribute.id }}" style="display: none;">
                <h5 class="target-section-title">
                  <i class="fas fa-download"></i> Target Variable Details
                </h5>
                <div class="target-info-grid">
                  <div class="info-item">
                    <span class="info-label">Variable Name:</span>
                    <span class="info-value" id="target-name-{{ variable_form.attribute.id }}">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Display Name:</span>
                    <span class="info-value" id="target-display-name-{{ variable_form.attribute.id }}">-</span>
                  </div>
                  <div class="info-item full-width">
                    <span class="info-label">Description:</span>
                    <span class="info-value" id="target-description-{{ variable_form.attribute.id }}">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Data Type:</span>
                    <span class="info-value" id="target-type-{{ variable_form.attribute.id }}">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Unit:</span>
                    <span class="info-value" id="target-unit-{{ variable_form.attribute.id }}">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Ontology Code:</span>
                    <span class="info-value" id="target-ontology-{{ variable_form.attribute.id }}">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Values Count:</span>
                    <span class="info-value" id="target-values-count-{{ variable_form.attribute.id }}">-</span>
                  </div>
                </div>
              </div>
              <!-- AI Similarity Suggestions Dropdown -->
              <div class="ai-suggestions-dropdown" id="ai-dropdown-{{ variable_form.attribute.id }}" style="display: none;">
                <div class="dropdown-header" onclick="toggleAISuggestions({{ variable_form.attribute.id }})">
                  <div class="dropdown-title">
                    <i class="fas fa-robot text-info"></i> AI Suggestions
                    <span class="suggestions-count" id="count-{{ variable_form.attribute.id }}"></span>
                  </div>
                  <i class="fas fa-chevron-down dropdown-arrow" id="arrow-{{ variable_form.attribute.id }}"></i>
                </div>
                <div class="dropdown-content" id="dropdown-content-{{ variable_form.attribute.id }}" style="display: none;">
                  <div class="suggestions-loading" id="loading-{{ variable_form.attribute.id }}" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Analyzing similarity...</span>
                  </div>
                  <div class="suggestions-list" id="suggestions-list-{{ variable_form.attribute.id }}">
                    <!-- AI suggestions will be populated here -->
                  </div>
                  <div class="dropdown-help">
                    <i class="fas fa-lightbulb"></i>
                    Click any suggestion to automatically apply it as the target variable
                  </div>
                </div>
              </div>
              
              <!-- Role Selection -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag"></i> Mapping Role
                </label>
                {{ variable_form.form.role }}
                {% if variable_form.form.role.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.role.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="help-text">
                  <strong>Value:</strong> Map to target variable (most common) | 
                  <strong>Patient ID:</strong> Use as patient identifier | 
                  <strong>Date/Time:</strong> Use as timestamp | 
                  <strong>Related Patient ID:</strong> For family/related person data
                </small>
              </div>

              <!-- Custom Settings Checkbox -->
              <div class="form-group">
                <div class="checkbox-wrapper">
                  {{ variable_form.form.use_custom_settings }}
                  <label for="{{ variable_form.form.use_custom_settings.id_for_label }}" class="checkbox-label-horizontal">
                    <i class="fas fa-cogs"></i> Use custom settings
                  </label>
                </div>
                <small class="help-text">{{ variable_form.form.use_custom_settings.help_text }}</small>
              </div>

              <!-- Custom Settings (override universal settings) -->
              <div class="advanced-options" id="custom-settings-{{ variable_form.attribute.id }}" style="{% if not variable_form.form.use_custom_settings.value %}display: none;{% endif %}">
                <h5 class="advanced-title">
                  <i class="fas fa-cog"></i> Custom Settings (Override Universal)
                </h5>
                
                <div class="form-group">
                  <label class="form-label">Custom Patient ID</label>
                  {{ variable_form.form.patient_id_attribute }}
                  {% if variable_form.form.patient_id_attribute.errors %}
                    <div class="error-message">
                      {% for error in variable_form.form.patient_id_attribute.errors %}
                        <span>{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <small class="help-text">Override universal patient ID setting for this specific mapping</small>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Custom DateTime</label>
                  {{ variable_form.form.datetime_attribute }}
                  {% if variable_form.form.datetime_attribute.errors %}
                    <div class="error-message">
                      {% for error in variable_form.form.datetime_attribute.errors %}
                        <span>{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <small class="help-text">Override universal datetime setting for this specific mapping</small>
                </div>
                
                <!-- Relationship Type (only for related patient role) -->
                <div class="form-group" id="relationship-{{ variable_form.attribute.id }}" style="{% if variable_form.form.role.value != 'related_patient_id' %}display: none;{% endif %}">
                  <label class="form-label">Relationship Type</label>
                  {{ variable_form.form.related_relation_type }}
                  {% if variable_form.form.related_relation_type.errors %}
                    <div class="error-message">
                      {% for error in variable_form.form.related_relation_type.errors %}
                        <span>{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <small class="help-text">Required when role is 'Related Patient ID'</small>
                </div>
              </div>
              
              <!-- Transform Code -->
              <div class="form-group full-width">
                <div class="code-header">
                  <label class="form-label">
                    <i class="fas fa-code"></i> Transform Code (Optional)
                  </label>
                  <div class="code-buttons">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateTransformationCode({{ variable_form.attribute.id }})">
                      <i class="fas fa-magic"></i> Generate Coding Instructions
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearCode({{ variable_form.attribute.id }})">
                      <i class="fas fa-eraser"></i> Clear
                    </button>
                  </div>
                </div>
                
                {{ variable_form.form.transform_code }}
                {% if variable_form.form.transform_code.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.transform_code.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                
                <div class="code-help">
                  <details class="mt-2">
                    <summary class="text-muted" style="cursor: pointer;">
                      <small><i class="fas fa-info-circle"></i> Transform Code Documentation & Examples</small>
                    </summary>
                    <div class="mt-2 p-3 bg-light rounded">
                      <!-- Quick Insert Examples -->
                      <div class="example-section mb-3">
                        <h6 class="mb-2"><i class="fas fa-magic"></i> Quick Insert Examples:</h6>
                        <div class="example-buttons">
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertExample({{ variable_form.attribute.id }}, 'uppercase')">
                            <i class="fas fa-font"></i> Uppercase Text
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertExample({{ variable_form.attribute.id }}, 'split')">
                            <i class="fas fa-cut"></i> Split & Extract
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertExample({{ variable_form.attribute.id }}, 'convert_units')">
                            <i class="fas fa-calculator"></i> Convert Units
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertExample({{ variable_form.attribute.id }}, 'replace')">
                            <i class="fas fa-exchange-alt"></i> Replace Values
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertExample({{ variable_form.attribute.id }}, 'conditional')">
                            <i class="fas fa-question-circle"></i> Conditional Logic
                          </button>
                        </div>
                      </div>
                      
                      <!-- Documentation -->
                      <small class="help-text">
                        <strong>Basic Examples:</strong><br>
                         Text cleanup: <code>lambda value: value.upper().strip() if value else ""</code><br>
                         Extract first part: <code>lambda value: value.split(',')[0] if value else None</code><br>
                         Unit conversion: <code>lambda value: float(value) * 2.54 if value else None</code><br>
                         Replace values: <code>lambda value: value.replace('old', 'new') if value else value</code><br>
                         Conditional mapping: <code>lambda value: 'Yes' if value == '1' else 'No' if value == '0' else value</code><br><br>
                        
                        <strong>Multi-line Functions:</strong><br>
                        <pre><code>def transform(value):
    if not value:
        return None
    # Clean and convert
    cleaned = value.strip().upper()
    return cleaned if cleaned != 'UNKNOWN' else None</code></pre><br>
                        
                        <strong>Safe Methods Available:</strong><br>
                        String: <code>.upper()</code>, <code>.lower()</code>, <code>.strip()</code>, <code>.split()</code>, <code>.replace()</code>, <code>.join()</code>, <code>.startswith()</code>, <code>.endswith()</code><br>
                        Numeric: <code>int()</code>, <code>float()</code>, <code>round()</code>, <code>abs()</code>, <code>min()</code>, <code>max()</code><br>
                        Lists: <code>.append()</code>, <code>.extend()</code>, <code>.sort()</code>, <code>.reverse()</code>, <code>len()</code>, <code>sum()</code>
                      </small>
                    </div>
                  </details>
                </div>
              </div>
              
              <!-- Comments -->
              <div class="form-group full-width">
                <label class="form-label">
                  <i class="fas fa-comment"></i> Comments (Optional)
                </label>
                {{ variable_form.form.comments }}
                {% if variable_form.form.comments.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.comments.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="help-text">Optional notes about this mapping</small>
              </div>
            </div>
          </div>

          <div class="variable-actions">
            <button type="button" class="btn btn-warning btn-small" onclick="clearMapping({{ variable_form.attribute.id }})">
              <i class="fas fa-times"></i>
              Clear
            </button>
            <button type="button" class="btn btn-success btn-small" onclick="saveMapping({{ variable_form.attribute.id }})">
              <i class="fas fa-save"></i>
              Save
            </button>
          </div>

          <!-- Not Mappable Option - Horizontal Layout at Bottom -->
          <div class="not-mappable-section-bottom">
            <div class="checkbox-wrapper-horizontal">
              {{ variable_form.form.not_mappable }}
              <label for="{{ variable_form.form.not_mappable.id_for_label }}" class="checkbox-label-horizontal">
                <i class="fas fa-ban"></i> Mark as not mappable
              </label>
              <small class="help-text-inline">This variable cannot be mapped to any target variable</small>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </form>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Progress Stats -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">Progress</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">Total Variables</span>
          <span class="stat-value">{{ total_variables }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Mapped</span>
          <span class="stat-value">{{ completed_rules|add:"-"|add:not_mappable_count }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Not Mappable</span>
          <span class="stat-value">{{ not_mappable_count }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Remaining</span>
          <span class="stat-value">{{ total_variables|add:"-"|add:completed_rules }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Completion</span>
          <span class="stat-value">{{ progress_percent }}%</span>
        </div>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">Bulk Actions</h3>
      <div class="bulk-actions">
        <button type="button" class="btn btn-primary action-btn" onclick="processAllVariablesWithAI()">
          <i class="fas fa-robot"></i>
          AI Process All
        </button>
        <button type="button" class="btn btn-success action-btn" onclick="approveExcellentMatches()">
          <i class="fas fa-star"></i>
          Approve 85%
        </button>
        <button type="button" class="btn btn-info action-btn" onclick="approveGoodPlusMatches()">
          <i class="fas fa-thumbs-up"></i>
          Approve 70%
        </button>
        <button type="button" class="btn btn-warning action-btn" onclick="approveFairPlusMatches()">
          <i class="fas fa-check"></i>
          Approve 55%
        </button>
        <button type="button" class="btn btn-outline action-btn" onclick="applyUniversalSettings()">
          <i class="fas fa-magic"></i>
          Apply Universal Settings
        </button>
        <button type="button" class="btn btn-outline action-btn" onclick="clearAllMappings()">
          <i class="fas fa-trash"></i>
          Clear All Mappings
        </button>
        <button type="button" class="btn btn-primary action-btn" onclick="validateAllMappings()">
          <i class="fas fa-check-circle"></i>
          Validate All
        </button>
      </div>
      
      <!-- AI Progress Bar -->
      <div class="ai-progress" id="ai-progress" style="display: none;">
        <div class="progress-info">
          <span class="progress-text" id="progress-text">Processing variables...</span>
          <span class="progress-count" id="progress-count">0/0</span>
        </div>
        <div class="progress">
          <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">Navigation</h3>
      
      <!-- Raw Data Files Section -->
      <div class="sidebar-section" style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0, 122, 255, 0.05); border-radius: 8px;">
        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
          <i class="fas fa-database"></i> Raw Data Files
        </h4>
        {% if has_raw_data %}
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
            <i class="fas fa-check-circle" style="color: var(--accent-color);"></i>
            {{ raw_data_files.count }} file{{ raw_data_files.count|pluralize }} uploaded
          </div>
          <div style="max-height: 150px; overflow-y: auto; margin-bottom: 0.75rem;">
            {% for file in raw_data_files|slice:":5" %}
              <div style="padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.8rem;">
                <a href="{% url 'health:raw_data_detail' file_id=file.id %}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">
                  {{ file.original_filename|truncatechars:30 }}
                </a>
                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">
                  {{ file.uploaded_at|date:"M d, Y" }}
                  {% if file.transformation_status == 'completed' %}
                    <span style="color: var(--accent-color);"> Transformed</span>
                  {% elif file.transformation_status == 'in_progress' %}
                    <span style="color: #FFA500;"> In Progress</span>
                  {% elif file.transformation_status == 'failed' %}
                    <span style="color: #DC3545;"> Failed</span>
                  {% else %}
                    <span style="color: var(--text-secondary);">Not transformed</span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
            {% if raw_data_files.count > 5 %}
              <div style="font-size: 0.75rem; color: var(--text-secondary); text-align: center;">
                and {{ raw_data_files.count|add:"-5" }} more...
              </div>
            {% endif %}
          </div>
          <a href="{% url 'health:upload_raw_data_for_study' study_id=schema.source_study.id %}" class="btn btn-sm btn-outline" style="width: 100%; font-size: 0.85rem;">
            <i class="fas fa-plus"></i> Upload More Data
          </a>
        {% else %}
          <div style="padding: 0.75rem; background: rgba(255, 193, 7, 0.1); border-left: 3px solid #FFC107; border-radius: 4px; margin-bottom: 0.75rem;">
            <div style="font-size: 0.85rem; color: #856404; margin-bottom: 0.5rem;">
              <i class="fas fa-exclamation-triangle"></i> No raw data files uploaded
            </div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">
              Upload raw data files to enable transformation after approving mappings.
            </div>
          </div>
          <a href="{% url 'health:upload_raw_data_for_study' study_id=schema.source_study.id %}" class="btn btn-sm btn-primary" style="width: 100%; font-size: 0.85rem;">
            <i class="fas fa-upload"></i> Upload Raw Data
          </a>
        {% endif %}
      </div>
      
      <div class="bulk-actions">
        <!-- Approve Mapping -->
        {% if schema.status != 'approved' %}
          <form method="post" action="{% url 'health:approve_mapping' schema.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary action-btn" {% if progress_percent < 1 %}disabled{% endif %}>
              <i class="fas fa-check-circle"></i>
              Approve Mapping
            </button>
          </form>
        {% else %}
          <div class="stat-item">
            <span class="stat-label">Status</span>
            <span class="stat-value">Approved</span>
          </div>
        {% endif %}
        
        <!-- Finalize (mark study harmonised) -->
        {% if schema.status == 'approved' %}
          <form method="post" action="{% url 'health:finalize_harmonisation' schema.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success action-btn">
              <i class="fas fa-flag-checkered"></i>
              Finalize Harmonisation
            </button>
          </form>
          <form method="post" action="{% url 'health:rerun_harmonisation_transformations' schema.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline action-btn">
              <i class="fas fa-sync"></i>
              Re-run Harmonisation Approval
            </button>
          </form>
        {% else %}
          <button type="button" class="btn btn-secondary action-btn" disabled>
            <i class="fas fa-flag"></i>
            Finalize Harmonisation
          </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
<!-- Auto-save indicator -->
<div class="auto-save-indicator" id="auto-save-indicator">
  <i class="fas fa-save"></i> Saving...
</div>

<!-- Include ACE Editor JavaScript -->
{% for variable_form in variable_forms %}
  {{ variable_form.form.media.js }}
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize role-dependent sections
    initializeRoleDependentSections();
    
    // Initialize filters
    initializeFilters();
    
    // Initialize auto-save
    initializeAutoSave();
    
    // Initialize target attribute change handlers
    initializeTargetAttributeHandlers();
    
    // Initialize not mappable checkbox handlers
    initializeNotMappableHandlers();
    
    // Load similarity suggestions
    loadSimilaritySuggestions();
});

function initializeNotMappableHandlers() {
    // Initialize target details for existing selections
    document.querySelectorAll('select[name*="target_attribute"]').forEach(targetSelect => {
        if (targetSelect.value) {
            // Trigger change event to populate details for existing selections
            targetSelect.dispatchEvent(new Event('change'));
        }
    });
    
    // Add event listeners for not mappable checkboxes
    document.querySelectorAll('.not-mappable-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const mappingFields = variableCard.querySelector('.mapping-fields');
            
            if (this.checked) {
                // Hide mapping fields and grey out card when not mappable is checked
                mappingFields.style.display = 'none';
                variableCard.classList.remove('complete', 'incomplete');
                variableCard.classList.add('not-mappable');
                variableCard.dataset.completion = 'not-mappable';
                
                // Update badge
                const badge = variableCard.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-not-mappable';
                badge.innerHTML = '<i class="fas fa-ban"></i> Not Mappable';
                
                // Clear target attribute selection and hide details
                const targetSelect = variableCard.querySelector('select[name*="target_attribute"]');
                if (targetSelect) {
                    targetSelect.value = '';
                    const detailsDiv = variableCard.querySelector('.target-attribute-details');
                    if (detailsDiv) {
                        detailsDiv.style.display = 'none';
                    }
                }
            } else {
                // Show mapping fields when not mappable is unchecked
                mappingFields.style.display = 'block';
                variableCard.classList.remove('not-mappable');
                variableCard.classList.add('incomplete');
                variableCard.dataset.completion = 'incomplete';
                
                // Update badge
                const badge = variableCard.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-incomplete';
                badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Needs Mapping';
            }
        });
    });
}

function initializeRoleDependentSections() {
    document.querySelectorAll('select[name$="-role"]').forEach(select => {
        const variableId = select.name.match(/variable_(\d+)-role/)[1];
        const relationshipSection = document.getElementById(`relationship-${variableId}`);
        
        function toggleRelationshipSection() {
            if (select.value === 'related_patient_id') {
                relationshipSection.style.display = 'block';
            } else {
                relationshipSection.style.display = 'none';
            }
        }
        
        // Initialize state
        toggleRelationshipSection();
        
        // Listen for changes
        select.addEventListener('change', toggleRelationshipSection);
    });
}

function initializeFilters() {
    const completionFilter = document.getElementById('completion-filter');
    const searchInput = document.getElementById('search-variables');
    
    function filterVariables() {
        const completionValue = completionFilter.value;
        const searchValue = searchInput.value.toLowerCase();
        
        document.querySelectorAll('.variable-card').forEach(card => {
            const completion = card.dataset.completion;
            const variableName = card.dataset.variableName;
            
            let showCompletion = completionValue === 'all' || completion === completionValue;
            let showSearch = !searchValue || variableName.includes(searchValue);
            
            if (showCompletion && showSearch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    completionFilter.addEventListener('change', filterVariables);
    searchInput.addEventListener('input', filterVariables);
}

function initializeAutoSave() {
    let autoSaveTimeout;
    const indicator = document.getElementById('auto-save-indicator');
    
    function showSaveIndicator() {
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
    }
    
    function triggerAutoSave(variableId) {
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        autoSaveTimeout = setTimeout(() => {
            saveMapping(variableId, true);
        }, 2000);
    }
    
    // Listen for form changes
    document.querySelectorAll('select, textarea, input').forEach(element => {
        if (element.name && element.name.startsWith('variable_')) {
            element.addEventListener('change', function() {
                const variableId = element.name.match(/variable_(\d+)/)[1];
                triggerAutoSave(variableId);
            });
        }
    });
}

function initializeTargetAttributeHandlers() {
    // Add change event listeners to all target attribute dropdowns
    document.querySelectorAll('select[name$="-target_attribute"]').forEach(select => {
        const variableId = select.name.match(/variable_(\d+)-target_attribute/)[1];
        
        select.addEventListener('change', function() {
            if (this.value) {
                // Fetch target attribute details and show them
                fetchTargetAttributeDetails(variableId, this.value);
            } else {
                // Hide target details if no selection
                const detailsDiv = document.getElementById(`target-details-${variableId}`);
                if (detailsDiv) {
                    detailsDiv.style.display = 'none';
                }
            }
        });
        
        // Initialize details for already selected values
        if (select.value) {
            fetchTargetAttributeDetails(variableId, select.value);
        }
    });
}

function fetchTargetAttributeDetails(variableId, targetAttributeId) {
    // Fetch detailed information about the target attribute from the API
    fetch(`/health/api/attribute/${targetAttributeId}/details/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.attribute) {
                showTargetVariableDetails(variableId, data.attribute);
            } else {
                console.error('No attribute data received');
                // Fallback to basic info from dropdown
                const select = document.querySelector(`select[name="variable_${variableId}-target_attribute"]`);
                const selectedOption = select.querySelector(`option[value="${targetAttributeId}"]`);
                
                if (selectedOption && selectedOption.textContent) {
                    const targetData = {
                        variable_name: selectedOption.textContent.trim(),
                        display_name: selectedOption.textContent.trim(),
                        description: 'Details not available',
                        variable_type: 'Unknown',
                        unit: 'Not specified',
                        ontology_code: '-',
                        values_count: '-'
                    };
                    showTargetVariableDetails(variableId, targetData);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching target attribute details:', error);
            // Fallback to basic info from dropdown
            const select = document.querySelector(`select[name="variable_${variableId}-target_attribute"]`);
            const selectedOption = select.querySelector(`option[value="${targetAttributeId}"]`);
            
            if (selectedOption && selectedOption.textContent) {
                const targetData = {
                    variable_name: selectedOption.textContent.trim(),
                    display_name: selectedOption.textContent.trim(),
                    description: 'Error loading details',
                    variable_type: 'Unknown',
                    unit: 'Not available',
                    ontology_code: '-',
                    values_count: '-'
                };
                showTargetVariableDetails(variableId, targetData);
            }
        });
}

function toggleSettingsForm() {
    const form = document.getElementById('universal-settings-form');
    const display = document.getElementById('settings-display');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        display.style.display = 'none';
    } else {
        form.style.display = 'none';
        display.style.display = 'block';
    }
}

function saveMapping(variableId, isAutoSave = false) {
    const form = document.getElementById('mappings-form');
    const formData = new FormData(form);
    
    // Only include data for this specific variable
    const newFormData = new FormData();
    newFormData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));
    
    for (const [key, value] of formData.entries()) {
        if (key.startsWith(`variable_${variableId}-`)) {
            newFormData.append(key, value);
        }
    }
    
    if (!isAutoSave) {
        document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-save"></i> Saving...';
        document.getElementById('auto-save-indicator').classList.add('show');
    }
    
    fetch(window.location.href, {
        method: 'POST',
        body: newFormData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (!isAutoSave) {
                document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-check"></i> Saved!';
                setTimeout(() => {
                    document.getElementById('auto-save-indicator').classList.remove('show');
                }, 2000);
            }
            
            // Update completion status
            const card = document.querySelector(`[data-variable-name="${data.variable_name.toLowerCase()}"]`);
            if (card && data.is_complete) {
                card.classList.remove('incomplete');
                card.classList.add('complete');
                card.dataset.completion = 'complete';
                
                const badge = card.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-complete';
                badge.innerHTML = '<i class="fas fa-check"></i> Mapped';
            }
        } else {
            console.error('Save failed:', data.errors);
            
            // Show specific errors to the user
            if (data.errors && Array.isArray(data.errors)) {
                data.errors.forEach(error => {
                    showErrorNotification(error);
                });
            } else if (data.errors) {
                showErrorNotification(`Save failed: ${JSON.stringify(data.errors)}`);
            } else {
                showErrorNotification('Save failed: Unknown error occurred');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (!isAutoSave) {
            // Show more detailed error message
            const errorMsg = error.message || 'Network error occurred';
            document.getElementById('auto-save-indicator').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${errorMsg}`;
            document.getElementById('auto-save-indicator').style.color = '#dc3545';
            setTimeout(() => {
                document.getElementById('auto-save-indicator').classList.remove('show');
                document.getElementById('auto-save-indicator').style.color = '';
            }, 5000);
        }
        
        // Also show a notification at the top of the page
        showErrorNotification(`Save failed: ${error.message || 'Network error'}`);
    });
}

function saveAllMappings() {
    const form = document.getElementById('mappings-form');
    const formData = new FormData(form);
    
    document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-save"></i> Saving all...';
    document.getElementById('auto-save-indicator').classList.add('show');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-check"></i> All saved!';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error('Save failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error!';
        setTimeout(() => {
            document.getElementById('auto-save-indicator').classList.remove('show');
        }, 2000);
    });
}

function clearVariableUIState(variableId) {
    // Hide confidence indicator
    const confidenceIndicator = document.getElementById(`confidence-${variableId}`);
    if (confidenceIndicator) {
        confidenceIndicator.style.display = 'none';
        confidenceIndicator.className = 'confidence-indicator';
        confidenceIndicator.textContent = '';
    }
    
    // Hide target variable details
    const targetDetails = document.getElementById(`target-details-${variableId}`);
    if (targetDetails) {
        targetDetails.style.display = 'none';
    }
    
    // Remove AI matching scores
    removeAIMatchingScores(variableId);
    
    // Remove any AI suggestion highlighting/styling
    const variableCard = document.querySelector(`#variable-${variableId}`);
    if (variableCard) {
        variableCard.classList.remove('ai-suggested', 'ai-applied');
    }
    
    // Clear any ACE editor content
    clearCode(variableId);
}

function clearAllVariableUIState() {
    // Find all variable IDs from the form fields
    const variableIds = new Set();
    document.querySelectorAll('[name^="variable_"]').forEach(field => {
        const match = field.name.match(/^variable_(\d+)-/);
        if (match) {
            variableIds.add(match[1]);
        }
    });
    
    // Clear UI state for each variable
    variableIds.forEach(variableId => {
        clearVariableUIState(variableId);
    });
    
    // Clear any global AI suggestions state
    if (window.currentAISuggestions) {
        window.currentAISuggestions = {};
    }
}

function clearMapping(variableId) {
    if (confirm('Are you sure you want to clear this mapping?')) {
        // Clear form fields for this variable
        document.querySelectorAll(`[name^="variable_${variableId}-"]`).forEach(field => {
            if (field.type === 'select-one') {
                field.selectedIndex = 0;
            } else {
                field.value = '';
            }
        });
        
        // Clear visual state elements
        clearVariableUIState(variableId);
        
        // Save the cleared mapping
        saveMapping(variableId);
    }
}

function applyUniversalSettings() {
    if (confirm('Apply universal settings to all unmapped variables?')) {
        // This would trigger a special form submission
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.href;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'apply_universal_settings';
        actionInput.value = 'true';
        
        form.appendChild(csrfInput);
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function clearAllMappings() {
    if (confirm('Are you sure you want to clear ALL mappings? This cannot be undone.')) {
        // Clear all form fields
        document.querySelectorAll('select, textarea, input[type="text"]').forEach(field => {
            if (field.name && field.name.startsWith('variable_')) {
                if (field.type === 'select-one') {
                    field.selectedIndex = 0;
                } else {
                    field.value = '';
                }
            }
        });
        
        // Clear all visual state elements
        clearAllVariableUIState();
        
        saveAllMappings();
    }
}

function validateAllMappings() {
    // This could check for required fields, validate transforms, etc. TO DO
    const incompleteVariables = document.querySelectorAll('.variable-card.incomplete').length;
    
    if (incompleteVariables > 0) {
        alert(`There are ${incompleteVariables} variables that still need mapping before validation.`);
    } else {
        alert('All variables are mapped! You can now proceed to approval.');
    }
}

function showErrorNotification(message) {
    // Create or get the notification container
    let container = document.querySelector('.error-notifications');
    if (!container) {
        container = document.createElement('div');
        container.className = 'error-notifications';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        `;
        document.body.appendChild(container);
    }
    
    // Create the notification element
    const notification = document.createElement('div');
    notification.className = 'error-notification';
    notification.style.cssText = `
        background-color: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 1rem 1.5rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInRight 0.3s ease-out;
        cursor: pointer;
    `;
    notification.innerHTML = `
        <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> ${message}
        <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">Click to dismiss</div>
    `;
    
    // Add click to dismiss
    notification.addEventListener('click', () => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    });
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 10000);
    
    container.appendChild(notification);
}

// Add CSS animations for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
`;
document.head.appendChild(style);

// ACE Editor Professional Enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Wait for ACE editor to be fully loaded
    setTimeout(function() {
        // Find all ACE editors on the page
        $('.ace_editor').each(function() {
            if (this.env) {
                var editor = this.env.editor;
                
                // Enable enhanced Python linting and features
                editor.setOptions({
                    enableBasicAutocompletion: true,
                    enableLiveAutocompletion: true,
                    enableSnippets: true,
                    highlightActiveLine: true,
                    showPrintMargin: true,
                    printMarginColumn: 88,  // PEP 8 line length
                    fontSize: "14px",
                    showGutter: true,
                    displayIndentGuides: true,
                    fadeFoldWidgets: false,
                    showFoldWidgets: true,
                    behavioursEnabled: true,
                    wrapBehavioursEnabled: true,
                    autoScrollEditorIntoView: true,
                    copyWithEmptySelection: false,
                    useSoftTabs: true,
                    navigateWithinSoftTabs: false,
                    enableMultiselect: true,
                    scrollPastEnd: 0.2,
                    fixedWidthGutter: false,
                    showLineNumbers: true
                });
                
                // Set Python-specific session options
                editor.getSession().setOptions({
                    tabSize: 4,
                    useSoftTabs: true,
                    useWorker: true,
                    mode: "ace/mode/python",
                    wrap: false
                });
                
                // Enhanced Python autocompletion
                editor.completers.push({
                    getCompletions: function(editor, session, pos, prefix, callback) {
                        var pythonCompletions = [
                            // Common Python keywords
                            {caption: "def", snippet: "def ${1:function_name}(${2:value}):\n    ${3:return value}", meta: "keyword", score: 1000},
                            {caption: "lambda", snippet: "lambda ${1:value}: ${2:value}", meta: "keyword", score: 1000},
                            {caption: "if", snippet: "if ${1:condition}:\n    ${2:pass}", meta: "keyword", score: 1000},
                            {caption: "elif", snippet: "elif ${1:condition}:\n    ${2:pass}", meta: "keyword", score: 900},
                            {caption: "else", snippet: "else:\n    ${1:pass}", meta: "keyword", score: 900},
                            {caption: "for", snippet: "for ${1:item} in ${2:iterable}:\n    ${3:pass}", meta: "keyword", score: 800},
                            {caption: "while", snippet: "while ${1:condition}:\n    ${2:pass}", meta: "keyword", score: 700},
                            {caption: "try", snippet: "try:\n    ${1:pass}\nexcept ${2:Exception} as ${3:e}:\n    ${4:pass}", meta: "keyword", score: 600},
                            {caption: "return", snippet: "return ${1:value}", meta: "keyword", score: 1000},
                            
                            // Variable and common patterns
                            {caption: "value", snippet: "value", meta: "variable", score: 1000},
                            {caption: "None", snippet: "None", meta: "constant", score: 900},
                            {caption: "True", snippet: "True", meta: "constant", score: 900},
                            {caption: "False", snippet: "False", meta: "constant", score: 900},
                            
                            // String methods
                            {caption: "value.strip()", snippet: "value.strip()", meta: "method", score: 950},
                            {caption: "value.upper()", snippet: "value.upper()", meta: "method", score: 950},
                            {caption: "value.lower()", snippet: "value.lower()", meta: "method", score: 950},
                            {caption: "value.title()", snippet: "value.title()", meta: "method", score: 900},
                            {caption: "value.replace()", snippet: "value.replace('${1:old}', '${2:new}')", meta: "method", score: 940},
                            {caption: "value.split()", snippet: "value.split('${1:separator}')", meta: "method", score: 940},
                            {caption: "value.startswith()", snippet: "value.startswith('${1:prefix}')", meta: "method", score: 920},
                            {caption: "value.endswith()", snippet: "value.endswith('${1:suffix}')", meta: "method", score: 920},
                            {caption: "value.find()", snippet: "value.find('${1:substring}')", meta: "method", score: 900},
                            {caption: "value.isdigit()", snippet: "value.isdigit()", meta: "method", score: 900},
                            {caption: "value.isalpha()", snippet: "value.isalpha()", meta: "method", score: 900},
                            
                            // Type conversion functions
                            {caption: "float(value)", snippet: "float(value)", meta: "function", score: 950},
                            {caption: "int(value)", snippet: "int(value)", meta: "function", score: 950},
                            {caption: "str(value)", snippet: "str(value)", meta: "function", score: 950},
                            {caption: "bool(value)", snippet: "bool(value)", meta: "function", score: 900},
                            {caption: "len(value)", snippet: "len(value)", meta: "function", score: 930},
                            
                            // Common patterns for data transformation
                            {caption: "if value else", snippet: "if value else ${1:default}", meta: "pattern", score: 980},
                            {caption: "value if value else", snippet: "value if value else ${1:default}", meta: "pattern", score: 980},
                            {caption: "value and value.strip()", snippet: "value and value.strip()", meta: "pattern", score: 970},
                            {caption: "value in [", snippet: "value in [${1:'option1'}, ${2:'option2'}]", meta: "pattern", score: 960},
                            {caption: "value not in [", snippet: "value not in [${1:'option1'}, ${2:'option2'}]", meta: "pattern", score: 940},
                            
                            // Error handling patterns
                            {caption: "try float", snippet: "try:\n    return float(value)\nexcept (ValueError, TypeError):\n    return ${1:None}", meta: "pattern", score: 920},
                            {caption: "try int", snippet: "try:\n    return int(value)\nexcept (ValueError, TypeError):\n    return ${1:None}", meta: "pattern", score: 920}
                        ];
                        
                        if (prefix.length >= 1) {
                            var filtered = pythonCompletions.filter(function(item) {
                                return item.caption.toLowerCase().indexOf(prefix.toLowerCase()) === 0;
                            });
                            callback(null, filtered);
                        }
                    }
                });
                
                // Enhanced Python validation and linting
                editor.getSession().on('changeAnnotation', function() {
                    var annotations = editor.getSession().getAnnotations() || [];
                    var customLints = [];
                    var code = editor.getValue();
                    
                    if (code.trim()) {
                        var lines = code.split('\n');
                        
                        lines.forEach(function(line, index) {
                            var lineNum = index;
                            var trimmedLine = line.trim();
                            
                            // Skip empty lines and comments
                            if (!trimmedLine || trimmedLine.startsWith('#')) return;
                            
                            // Check indentation (should be multiples of 4 spaces)
                            var leadingSpaces = line.match(/^( *)/)[1].length;
                            if (leadingSpaces > 0 && leadingSpaces % 4 !== 0) {
                                customLints.push({
                                    row: lineNum,
                                    column: 0,
                                    text: "PEP 8: Use 4 spaces for indentation (found " + leadingSpaces + " spaces)",
                                    type: "warning"
                                });
                            }
                            
                            // Check line length (PEP 8: max 88 characters for readability)
                            if (line.length > 88) {
                                customLints.push({
                                    row: lineNum,
                                    column: 88,
                                    text: "PEP 8: Line too long (" + line.length + " > 88 characters)",
                                    type: "info"
                                });
                            }
                            
                            // Check for trailing whitespace
                            if (line.match(/\s+$/)) {
                                customLints.push({
                                    row: lineNum,
                                    column: line.length - 1,
                                    text: "Remove trailing whitespace",
                                    type: "info"
                                });
                            }
                            
                            // Check for common Python style issues
                            if (trimmedLine.match(/^(if|elif|for|while|def|class|try|except|with)\s*\(/)) {
                                if (!trimmedLine.includes(' ')) {
                                    customLints.push({
                                        row: lineNum,
                                        column: line.indexOf(trimmedLine),
                                        text: "PEP 8: Add space after keyword",
                                        type: "info"
                                    });
                                }
                            }
                            
                            // Check for missing space around operators (basic check)
                            if (trimmedLine.match(/[a-zA-Z0-9][=!<>]=?[a-zA-Z0-9]/) && !trimmedLine.includes('==') && !trimmedLine.includes('!=')) {
                                customLints.push({
                                    row: lineNum,
                                    column: line.indexOf(trimmedLine),
                                    text: "PEP 8: Add spaces around operators",
                                    type: "info"
                                });
                            }
                        });
                    }
                    
                    // Merge with existing annotations from ACE's Python mode
                    var allAnnotations = annotations.concat(customLints);
                    editor.getSession().setAnnotations(allAnnotations);
                });
                
                // Enhanced bracket matching and auto-closing
                editor.setBehavioursEnabled(true);
                editor.setWrapBehavioursEnabled(true);
                
                // Add useful keyboard shortcuts
                editor.commands.addCommand({
                    name: 'toggleComment',
                    bindKey: {win: 'Ctrl-/', mac: 'Command-/'},
                    exec: function(editor) {
                        editor.toggleCommentLines();
                    },
                    multiSelectAction: "forEachLine"
                });
                
                editor.commands.addCommand({
                    name: 'duplicateLine',
                    bindKey: {win: 'Ctrl-D', mac: 'Command-D'},
                    exec: function(editor) {
                        editor.copyLinesDown();
                    }
                });
                
                editor.commands.addCommand({
                    name: 'formatCode',
                    bindKey: {win: 'Ctrl-Shift-F', mac: 'Command-Shift-F'},
                    exec: function(editor) {
                        // Basic Python formatting
                        var code = editor.getValue();
                        var lines = code.split('\n');
                        var indentLevel = 0;
                        var formattedLines = [];
                        
                        lines.forEach(function(line) {
                            var trimmed = line.trim();
                            if (!trimmed) {
                                formattedLines.push('');
                                return;
                            }
                            
                            // Decrease indent for certain keywords
                            if (trimmed.match(/^(elif|else|except|finally):/)) {
                                indentLevel = Math.max(0, indentLevel - 1);
                            }
                            
                            formattedLines.push('    '.repeat(indentLevel) + trimmed);
                            
                            // Increase indent after certain keywords
                            if (trimmed.match(/^(def|class|if|elif|else|for|while|try|except|finally|with).*:$/)) {
                                indentLevel++;
                            }
                        });
                        
                        editor.setValue(formattedLines.join('\n'));
                        editor.clearSelection();
                    }
                });
                
                // Trigger initial validation
                setTimeout(function() {
                    editor.getSession().$annotations = [];
                    editor.getSession()._signal("changeAnnotation", {});
                }, 100);
            }
        });
    }, 100);
});

// Enhanced functionality for improved harmonization cards

// Transform code example insertion functions
function insertExample(variableId, exampleType) {
    const examples = {
        'uppercase': "lambda value: value.upper().strip() if value else \"\"",
        'split': "lambda value: value.split(',')[0].strip() if value else None",
        'convert_units': "lambda value: float(value) * 2.54 if value and value != '' else None",
        'replace': "lambda value: value.replace('old_value', 'new_value') if value else value",
        'conditional': `def transform(value):
    if not value or value.strip() == '':
        return None
    value = value.strip().upper()
    if value in ['YES', 'Y', '1', 'TRUE']:
        return 'Yes'
    elif value in ['NO', 'N', '0', 'FALSE']:
        return 'No'
    else:
        return value`
    };
    
    const exampleCode = examples[exampleType];
    if (!exampleCode) {
        console.warn('Unknown example type:', exampleType);
        return;
    }
    
    // Try multiple methods to find the ACE editor for this variable
    let editor = null;
    
    // Method 1: Try to find by variable-specific textarea name
    const textareaName = `variable_${variableId}-transform_code`;
    const textarea = document.querySelector(`textarea[name="${textareaName}"]`);
    
    if (textarea && typeof ace !== 'undefined') {
        // Check if this textarea has been converted to ACE editor
        const aceContainer = textarea.parentNode.querySelector('.ace_editor');
        if (aceContainer && aceContainer.env && aceContainer.env.editor) {
            editor = aceContainer.env.editor;
        } else {
            // Try to get ACE editor by textarea ID
            try {
                editor = ace.edit(textarea.id);
            } catch (e) {
                console.log('Could not get ACE editor by textarea ID:', e);
            }
        }
    }
    
    // Method 2: Search for ACE editor containers and match by field name
    if (!editor) {
        const aceEditors = document.querySelectorAll('.ace_editor');
        for (let aceContainer of aceEditors) {
            const textareaElement = aceContainer.previousElementSibling;
            if (textareaElement && textareaElement.name && textareaElement.name.includes(`variable_${variableId}-transform_code`)) {
                if (aceContainer.env && aceContainer.env.editor) {
                    editor = aceContainer.env.editor;
                    break;
                }
            }
        }
    }
    
    if (editor) {
        try {
            // Insert the example code
            editor.setValue(exampleCode);
            editor.clearSelection();
            editor.focus();
            
            // Trigger change event for auto-save
            setTimeout(() => {
                triggerAutoSave(variableId);
            }, 100);
            
            console.log('Successfully inserted example using ACE editor');
            return;
        } catch (e) {
            console.warn('ACE editor error, using fallback method:', e);
        }
    }
    
    // Fallback method if ACE editor not found
    console.log('ACE editor not found, using fallback method');
    insertExampleFallback(variableId, exampleType);
}

function insertExampleFallback(variableId, exampleType) {
    const examples = {
        'uppercase': "lambda value: value.upper().strip() if value else \"\"",
        'split': "lambda value: value.split(',')[0].strip() if value else None",
        'convert_units': "lambda value: float(value) * 2.54 if value and value != '' else None",
        'replace': "lambda value: value.replace('old_value', 'new_value') if value else value",
        'conditional': `def transform(value):
    if not value or value.strip() == '':
        return None
    value = value.strip().upper()
    if value in ['YES', 'Y', '1', 'TRUE']:
        return 'Yes'
    elif value in ['NO', 'N', '0', 'FALSE']:
        return 'No'
    else:
        return value`
    };
    
    const exampleCode = examples[exampleType];
    if (!exampleCode) {
        return;
    }
    
    // Find the textarea element within the variable card
    const variableCard = document.querySelector(`[data-variable-id="${variableId}"]`) || 
                        document.querySelector(`[data-attribute-id="${variableId}"]`);
    
    let textareaElement = null;
    
    if (variableCard) {
        textareaElement = variableCard.querySelector('textarea[name*="transform_code"]');
    }
    
    // If not found in specific card, try a broader search
    if (!textareaElement) {
        const allTextareas = document.querySelectorAll('textarea[name*="transform_code"]');
        if (allTextareas.length > 0) {
            textareaElement = allTextareas[0]; // Use the first one as fallback
        }
    }
    
    if (textareaElement) {
        textareaElement.value = exampleCode;
        textareaElement.focus();
        
        // Trigger change event for auto-save
        const event = new Event('change', { bubbles: true });
        textareaElement.dispatchEvent(event);
        
        // Also trigger input event for more comprehensive updates
        const inputEvent = new Event('input', { bubbles: true });
        textareaElement.dispatchEvent(inputEvent);
    } else {
        console.warn('Could not find transform_code textarea for variable:', variableId);
    }
}

function clearCode(variableId) {
    // Try multiple methods to find the ACE editor for this variable
    let editor = null;
    
    // Method 1: Try to find by variable-specific textarea name
    const textareaName = `variable_${variableId}-transform_code`;
    const textarea = document.querySelector(`textarea[name="${textareaName}"]`);
    
    if (textarea && typeof ace !== 'undefined') {
        // Check if this textarea has been converted to ACE editor
        const aceContainer = textarea.parentNode.querySelector('.ace_editor');
        if (aceContainer && aceContainer.env && aceContainer.env.editor) {
            editor = aceContainer.env.editor;
        } else {
            // Try to get ACE editor by textarea ID
            try {
                editor = ace.edit(textarea.id);
            } catch (e) {
                console.log('Could not get ACE editor by textarea ID:', e);
            }
        }
    }
    
    // Method 2: Search for ACE editor containers and match by field name
    if (!editor) {
        const aceEditors = document.querySelectorAll('.ace_editor');
        for (let aceContainer of aceEditors) {
            const textareaElement = aceContainer.previousElementSibling;
            if (textareaElement && textareaElement.name && textareaElement.name.includes(`variable_${variableId}-transform_code`)) {
                if (aceContainer.env && aceContainer.env.editor) {
                    editor = aceContainer.env.editor;
                    break;
                }
            }
        }
    }
    
    if (editor) {
        try {
            // Clear the editor content
            editor.setValue('');
            editor.clearSelection();
            editor.focus();
            
            // Trigger change event for auto-save
            setTimeout(() => {
                triggerAutoSave(variableId);
            }, 100);
            
            console.log('Successfully cleared code using ACE editor');
            return;
        } catch (e) {
            console.warn('ACE editor error, using fallback method:', e);
        }
    }
    
    // Fallback method if ACE editor not found
    console.log('ACE editor not found, using fallback method');
    clearCodeFallback(variableId);
}

function clearCodeFallback(variableId) {
    // Find any textarea with transform_code in the name within the variable card
    const variableCard = document.querySelector(`[data-variable-id="${variableId}"]`) || 
                        document.querySelector(`[data-attribute-id="${variableId}"]`);
    
    if (variableCard) {
        const textareaElement = variableCard.querySelector('textarea[name*="transform_code"]');
        if (textareaElement) {
            textareaElement.value = '';
            textareaElement.focus();
            
            // Trigger change event for auto-save
            const event = new Event('change', { bubbles: true });
            textareaElement.dispatchEvent(event);
            return;
        }
    }
    
    // Final fallback: find any transform_code textarea
    const allTextareas = document.querySelectorAll('textarea[name*="transform_code"]');
    if (allTextareas.length > 0) {
        // If we can't identify the specific one, at least clear the first one as feedback
        allTextareas[0].value = '';
        allTextareas[0].focus();
    }
}

function generateTransformationCode(variableId) {
    // Find the source attribute ID from the variable card
    const sourceAttributeId = variableId;
    
    // Find the selected target attribute ID from the dropdown
    const targetSelect = document.querySelector(`select[name="variable_${variableId}-target_attribute"]`);
    if (!targetSelect || !targetSelect.value) {
        showNotification('Please select a target variable first before generating transformation code.', 'warning');
        return;
    }
    
    const targetAttributeId = targetSelect.value;
    
    // Find the transformation code textarea/editor
    const textareaName = `variable_${variableId}-transform_code`;
    const textarea = document.querySelector(`textarea[name="${textareaName}"]`);
    
    if (!textarea) {
        showNotification('Could not find transformation code field.', 'error');
        return;
    }
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    // Make API call to generate transformation code
    fetch('/health/api/transformation-suggestion/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            source_attribute_id: sourceAttributeId,
            target_attribute_id: targetAttributeId,
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.transformation_needed) {
                // Set the generated code
                setTransformationCode(variableId, data.transformation_code);
                showNotification('Transformation code generated successfully!', 'success');
            } else {
                // No transformation needed
                setTransformationCode(variableId, '');
                showNotification('No transformation needed - variables are already compatible.', 'info');
            }
        } else {
            showNotification(data.error || 'Failed to generate transformation code.', 'error');
        }
    })
    .catch(error => {
        console.error('Error generating transformation code:', error);
        showNotification('An error occurred while generating transformation code.', 'error');
    })
    .finally(() => {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function setTransformationCode(variableId, code) {
    // Try to set the code using ACE editor first, then fallback to textarea
    let editor = null;
    
    // Try to find ACE editor
    const textareaName = `variable_${variableId}-transform_code`;
    const textarea = document.querySelector(`textarea[name="${textareaName}"]`);
    
    if (textarea && typeof ace !== 'undefined') {
        // Check if this textarea has been converted to ACE editor
        const aceContainer = textarea.parentNode.querySelector('.ace_editor');
        if (aceContainer && aceContainer.env && aceContainer.env.editor) {
            editor = aceContainer.env.editor;
        } else {
            // Try to get ACE editor by textarea ID
            try {
                editor = ace.edit(textarea.id);
            } catch (e) {
                console.log('Could not get ACE editor by textarea ID:', e);
            }
        }
    }
    
    if (editor) {
        try {
            // Set the editor content
            editor.setValue(code);
            editor.clearSelection();
            
            // Trigger change event for auto-save
            setTimeout(() => {
                triggerAutoSave(variableId);
            }, 100);
            
            return;
        } catch (e) {
            console.warn('ACE editor error, using fallback method:', e);
        }
    }
    
    // Fallback to textarea
    if (textarea) {
        textarea.value = code;
        
        // Trigger change event for auto-save
        const event = new Event('change', { bubbles: true });
        textarea.dispatchEvent(event);
    }
}

function getFormIndexFromVariableId(variableId) {
    // Helper function to convert variable ID to form index
    // This might need adjustment based on how the form indices are structured
    const variableCard = document.querySelector(`[data-variable-id="${variableId}"]`) || 
                        document.querySelector(`[data-attribute-id="${variableId}"]`);
    
    if (variableCard) {
        const formElement = variableCard.querySelector('select[name*="form-"], textarea[name*="form-"]');
        if (formElement && formElement.name) {
            const match = formElement.name.match(/form-(\d+)-/);
            return match ? match[1] : '0';
        }
    }
    
    return '0'; // Default fallback
}

// Handle not mappable checkbox changes
document.addEventListener('DOMContentLoaded', function() {
    // Initialize target details for existing selections
    document.querySelectorAll('select[name*="target_attribute"]').forEach(targetSelect => {
        if (targetSelect.value) {
            // Trigger change event to populate details for existing selections
            targetSelect.dispatchEvent(new Event('change'));
        }
    });
    
    // Add event listeners for not mappable checkboxes
    document.querySelectorAll('.not-mappable-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const mappingFields = variableCard.querySelector('.mapping-fields');
            
            if (this.checked) {
                // Hide mapping fields and grey out card when not mappable is checked
                mappingFields.style.display = 'none';
                variableCard.classList.remove('complete', 'incomplete');
                variableCard.classList.add('not-mappable');
                variableCard.dataset.completion = 'not-mappable';
                
                // Update badge
                const badge = variableCard.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-not-mappable';
                badge.innerHTML = '<i class="fas fa-ban"></i> Not Mappable';
                
                // Clear target attribute selection
                const targetSelect = variableCard.querySelector('select[name*="target_attribute"]');
                if (targetSelect) targetSelect.selectedIndex = 0;
                
            } else {
                // Show mapping fields and remove grey-out when not mappable is unchecked
                mappingFields.style.display = 'block';
                variableCard.classList.remove('not-mappable');
                variableCard.classList.add('incomplete');
                variableCard.dataset.completion = 'incomplete';
                
                // Update badge
                const badge = variableCard.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-incomplete';
                badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Needs Mapping';
            }
        });
    });
    
    // Add event listeners for role changes
    document.querySelectorAll('select[name*="role"]').forEach(roleSelect => {
        roleSelect.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const relationshipSection = variableCard.querySelector('[id^="relationship-"]');
            
            if (this.value === 'related_patient_id') {
                // Show relationship type for related patient ID role
                relationshipSection.style.display = 'block';
            } else {
                // Hide relationship type for other roles
                relationshipSection.style.display = 'none';
            }
        });
    });
    
    // Add event listeners for custom settings checkbox
    document.querySelectorAll('input[name*="use_custom_settings"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const customSettingsSection = variableCard.querySelector('[id^="custom-settings-"]');
            
            if (this.checked) {
                // Show custom settings when checkbox is checked
                customSettingsSection.style.display = 'block';
            } else {
                // Hide custom settings when checkbox is unchecked
                customSettingsSection.style.display = 'none';
            }
        });
    });
    
    // Add event listeners for custom settings checkbox
    document.querySelectorAll('.custom-settings-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const customSettingsSection = variableCard.querySelector('[id^="custom-settings-"]');
            
            if (this.checked) {
                // Show custom settings when checkbox is checked
                customSettingsSection.style.display = 'block';
            } else {
                // Hide custom settings when checkbox is unchecked
                customSettingsSection.style.display = 'none';
                
                // Clear the custom settings fields when hiding
                const patientIdField = customSettingsSection.querySelector('select[name*="patient_id_attribute"]');
                const datetimeField = customSettingsSection.querySelector('select[name*="datetime_attribute"]');
                const relationField = customSettingsSection.querySelector('select[name*="related_relation_type"]');
                
                if (patientIdField) patientIdField.selectedIndex = 0;
                if (datetimeField) datetimeField.selectedIndex = 0;
                if (relationField) relationField.selectedIndex = 0;
            }
        });
    });
});

// Function to update variable completion status
function updateVariableCompletionStatus(variableCard) {
    const notMappableCheck = variableCard.querySelector('.not-mappable-checkbox');
    const targetSelect = variableCard.querySelector('select[name*="target_attribute"]');
    const badge = variableCard.querySelector('.completion-badge');
    
    if (notMappableCheck && notMappableCheck.checked) {
        // Already handled in the checkbox event listener
        return;
    }
    
    if (targetSelect && targetSelect.value) {
        // Variable is mapped
        variableCard.classList.remove('incomplete', 'not-mappable');
        variableCard.classList.add('complete');
  variableCard.dataset.completion = 'complete';
        badge.className = 'completion-badge badge-complete';
        badge.innerHTML = '<i class="fas fa-check"></i> Mapped';
    } else {
        // Variable needs mapping
        variableCard.classList.remove('complete', 'not-mappable');
        variableCard.classList.add('incomplete');
  variableCard.dataset.completion = 'incomplete';
        badge.className = 'completion-badge badge-incomplete';
        badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Needs Mapping';
    }
}

// Enhanced clear mapping function
function clearMapping(variableId) {
    if (confirm('Are you sure you want to clear this mapping?')) {
        // Clear form fields for this variable
        const variableCard = document.querySelector(`[data-variable-name*="${variableId}"]`).closest('.variable-card');
        
        // Clear all form inputs
        variableCard.querySelectorAll('select, textarea, input[type="text"]').forEach(field => {
            if (field.type === 'select-one') {
                field.selectedIndex = 0;
            } else if (field.type === 'checkbox') {
                field.checked = false;
            } else {
                field.value = '';
            }
        });
        
        // Hide custom settings and relationship sections when cleared
        const customSettingsSection = variableCard.querySelector('[id^="custom-settings-"]');
        const relationshipSection = variableCard.querySelector('[id^="relationship-"]');
        const mappingFields = variableCard.querySelector('.mapping-fields');
        
        if (customSettingsSection) customSettingsSection.style.display = 'none';
        if (relationshipSection) relationshipSection.style.display = 'none';
        if (mappingFields) mappingFields.style.display = 'block';
        
        // Hide target details
        const targetDetails = variableCard.querySelector('.target-attribute-details');
        if (targetDetails) targetDetails.style.display = 'none';
        
        // Update completion status
        updateVariableCompletionStatus(variableCard);
        
        // Save the cleared mapping
        saveMapping(variableId);
    }
}

// Similarity Suggestions Functionality
let similaritySuggestions = null;
let suggestionsLoaded = false;

function loadSimilaritySuggestions() {
    if (suggestionsLoaded) return Promise.resolve();
    
    const schemaId = {{ schema.id }};
    
    return fetch(`/health/api/mapping/${schemaId}/similarity-suggestions/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            similaritySuggestions = data.suggestions;
            suggestionsLoaded = true;
            populateAllSuggestions();
        })
        .catch(error => {
            console.error('Error loading similarity suggestions:', error);
            // Show error in all suggestion containers
            document.querySelectorAll('.suggestions-container').forEach(container => {
                container.innerHTML = `
                    <div class="suggestions-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load suggestions: ${error.message}
                    </div>
                `;
            });
        });
}

function populateAllSuggestions() {
    // Show AI dropdowns and populate suggestions for all variables
    Object.keys(similaritySuggestions || {}).forEach(variableId => {
        const dropdown = document.getElementById(`ai-dropdown-${variableId}`);
        const loadingElement = document.getElementById(`loading-${variableId}`);
        const suggestionsList = document.getElementById(`suggestions-list-${variableId}`);
        const countElement = document.getElementById(`count-${variableId}`);
        
        if (dropdown) {
            dropdown.style.display = 'block';
            
            if (similaritySuggestions[variableId]) {
                const suggestions = similaritySuggestions[variableId];
                dropdown.classList.add('has-suggestions');
                
                if (loadingElement) loadingElement.style.display = 'none';
                
                renderDropdownSuggestions(variableId, suggestions);
                
                // Update count
                if (countElement) {
                    countElement.textContent = `${suggestions.length} found`;
                }
            }
        }
    });
}

function approveFairPlusMatches() {
    if (!confirm('Approve all mappings with "Fair" or better confidence scores (55% similarity)? This will apply AI suggestions for medium to high confidence matches.')) {
        return;
    }
    
    const approveBtn = document.querySelector('button[onclick="approveFairPlusMatches()"]');
    const originalText = approveBtn.innerHTML;
    
    // Disable button and show processing state
    approveBtn.disabled = true;
    approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    let approvedCount = 0;
    let totalFairPlus = 0;
    
    // Find all variables with AI suggestions using similarity score threshold
    if (similaritySuggestions) {
        // Count fair+ matches first (55% similarity)
        Object.keys(similaritySuggestions).forEach(variableId => {
            const suggestions = similaritySuggestions[variableId];
            if (suggestions && suggestions.length > 0) {
                const bestSuggestion = suggestions[0];
                if (bestSuggestion.combined_similarity >= 0.55) {
                    totalFairPlus++;
                }
            }
        });
        
        // Apply fair+ matches
        Object.keys(similaritySuggestions).forEach(variableId => {
            const suggestions = similaritySuggestions[variableId];
            if (suggestions && suggestions.length > 0) {
                const bestSuggestion = suggestions[0];
                if (bestSuggestion.combined_similarity >= 0.55) {
                    // Apply the AI suggestion for this variable
                    applyAISuggestion(variableId, bestSuggestion);
                    approvedCount++;
                }
            }
        });
        
        // Save all mappings after applying suggestions
        if (approvedCount > 0) {
            saveAllMappings();
        }
    }
    
    // Re-enable button and show result
    setTimeout(() => {
        approveBtn.disabled = false;
        approveBtn.innerHTML = originalText;
        
        if (approvedCount > 0) {
            showNotification(`Successfully approved ${approvedCount} fair+ matches (55% similarity)!`, 'success');
        } else {
            showNotification('No fair+ matches found to approve. Try running AI suggestions first.', 'info');
        }
    }, 500);
}

function approveGoodPlusMatches() {
    if (!confirm('Approve all mappings with "Good" or "Excellent" confidence scores (70% similarity)? This will apply AI suggestions for high and medium-high confidence matches.')) {
        return;
    }
    
    const approveBtn = document.querySelector('button[onclick="approveGoodPlusMatches()"]');
    const originalText = approveBtn.innerHTML;
    
    // Disable button and show processing state
    approveBtn.disabled = true;
    approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    let approvedCount = 0;
    let totalGoodPlus = 0;
    
    // Find all variables with AI suggestions using similarity score threshold
    if (similaritySuggestions) {
        // Count good+ matches first (70% similarity)
        Object.keys(similaritySuggestions).forEach(variableId => {
            const suggestions = similaritySuggestions[variableId];
            if (suggestions && suggestions.length > 0) {
                const bestSuggestion = suggestions[0];
                if (bestSuggestion.combined_similarity >= 0.70) {
                    totalGoodPlus++;
                }
            }
        });
        
        // Apply good+ matches
        Object.keys(similaritySuggestions).forEach(variableId => {
            const suggestions = similaritySuggestions[variableId];
            if (suggestions && suggestions.length > 0) {
                const bestSuggestion = suggestions[0];
                if (bestSuggestion.combined_similarity >= 0.70) {
                    // Apply the AI suggestion for this variable
                    applyAISuggestion(variableId, bestSuggestion);
                    approvedCount++;
                }
            }
        });
        
        // Save all mappings after applying suggestions
        if (approvedCount > 0) {
            saveAllMappings();
        }
    }
    
    // Re-enable button and show result
    setTimeout(() => {
        approveBtn.disabled = false;
        approveBtn.innerHTML = originalText;
        
        if (approvedCount > 0) {
            showNotification(`Successfully approved ${approvedCount} good+ matches (70% similarity)!`, 'success');
        } else {
            showNotification('No good+ matches found to approve. Try running AI suggestions first.', 'info');
        }
    }, 500);
}

function approveExcellentMatches() {
    if (!confirm('Approve all mappings with "Excellent" confidence scores (85% similarity)? This will apply AI suggestions for high-confidence matches only.')) {
        return;
    }
    
    const approveBtn = document.querySelector('button[onclick="approveExcellentMatches()"]');
    const originalText = approveBtn.innerHTML;
    
    // Disable button and show processing state
    approveBtn.disabled = true;
    approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
    
    let approvedCount = 0;
    let totalExcellent = 0;
    
    // Find all variables with AI suggestions using similarity score threshold
    if (similaritySuggestions) {
        // Count excellent matches first (85% similarity)
        Object.keys(similaritySuggestions).forEach(variableId => {
            const suggestions = similaritySuggestions[variableId];
            if (suggestions && suggestions.length > 0) {
                const bestSuggestion = suggestions[0];
                if (bestSuggestion.combined_similarity >= 0.85) {
                    totalExcellent++;
                }
            }
        });
        
        // Apply excellent matches
        Object.keys(similaritySuggestions).forEach(variableId => {
            const suggestions = similaritySuggestions[variableId];
            if (suggestions && suggestions.length > 0) {
                const bestSuggestion = suggestions[0];
                if (bestSuggestion.combined_similarity >= 0.85) {
                    // Apply the AI suggestion for this variable
                    applyAISuggestion(variableId, bestSuggestion);
                    approvedCount++;
                }
            }
        });
        
        // Save all mappings after applying suggestions
        if (approvedCount > 0) {
            saveAllMappings();
        }
    }
    
    // Re-enable button and show result
    setTimeout(() => {
        approveBtn.disabled = false;
        approveBtn.innerHTML = originalText;
        
        if (approvedCount > 0) {
            showNotification(`Successfully approved ${approvedCount} excellent matches (85% similarity)!`, 'success');
        } else {
            showNotification('No excellent matches found to approve. Try running AI suggestions first.', 'info');
        }
    }, 500);
}

// Global AI Processing Functions
function processAllVariablesWithAI() {
    const processBtn = document.querySelector('button[onclick="processAllVariablesWithAI()"]');
    const progressDiv = document.getElementById('ai-progress');
    const progressText = document.getElementById('progress-text');
    const progressCount = document.getElementById('progress-count');
    const progressBar = document.getElementById('progress-bar');
    
    // Show progress
    progressDiv.style.display = 'block';
    processBtn.disabled = true;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Get all variables that can be mapped
    const variableCards = document.querySelectorAll('.variable-card:not(.not-mappable)');
    const totalVariables = variableCards.length;
    let processedCount = 0;
    
    progressCount.textContent = `0/${totalVariables}`;
    progressBar.style.width = '0%';
    
    // Process each variable sequentially
    processVariablesSequentially(variableCards, 0, totalVariables, (current, total) => {
        processedCount = current;
        const percent = Math.round((current / total) * 100);
        progressCount.textContent = `${current}/${total}`;
        progressBar.style.width = `${percent}%`;
        progressText.textContent = current < total ? 
            `Processing variable ${current + 1} of ${total}...` : 
            'Processing complete!';
            
        if (current >= total) {
            setTimeout(() => {
                progressDiv.style.display = 'none';
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-robot"></i> AI Process All';
                showNotification(`Successfully processed ${total} variables with AI suggestions!`, 'success');
            }, 1000);
        }
    });
}

function processVariablesSequentially(variableCards, index, total, progressCallback) {
    if (index >= total) {
        progressCallback(index, total);
        return;
    }
    
    const card = variableCards[index];
    const variableId = getVariableIdFromCard(card);
    
    if (variableId && similaritySuggestions?.[variableId]) {
        const suggestions = similaritySuggestions[variableId];
        if (suggestions.length > 0) {
            const bestSuggestion = suggestions[0];
            
            // Apply the best suggestion
            applyAISuggestion(variableId, bestSuggestion);
            
            // Show the AI dropdown for this variable
            showAIDropdownForVariable(variableId);
        }
    }
    
    progressCallback(index + 1, total);
    
    // Continue with next variable after a short delay
    setTimeout(() => {
        processVariablesSequentially(variableCards, index + 1, total, progressCallback);
    }, 300);
}

function clearAllMappings() {
    if (!confirm('Are you sure you want to clear all variable mappings? This action cannot be undone.')) {
        return;
    }
    
    const targetSelects = document.querySelectorAll('select[name*="target_attribute"]');
    targetSelects.forEach(select => {
        select.value = '';
        select.dispatchEvent(new Event('change'));
    });
    
    // Clear all confidence indicators
    document.querySelectorAll('.confidence-indicator').forEach(indicator => {
        indicator.style.display = 'none';
    });
    
    // Hide all target details
    document.querySelectorAll('.target-variable-details').forEach(details => {
        details.style.display = 'none';
    });
    
    showNotification('All variable mappings cleared', 'info');
}

function showAIDropdownForVariable(variableId) {
    const dropdown = document.getElementById(`ai-dropdown-${variableId}`);
    if (dropdown) {
        dropdown.style.display = 'block';
        if (similaritySuggestions?.[variableId]) {
            dropdown.classList.add('has-suggestions');
            renderDropdownSuggestions(variableId, similaritySuggestions[variableId]);
        }
    }
}

function toggleAISuggestions(variableId) {
    const header = document.querySelector(`#ai-dropdown-${variableId} .dropdown-header`);
    const content = document.getElementById(`dropdown-content-${variableId}`);
    const arrow = document.getElementById(`arrow-${variableId}`);
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        header.classList.remove('expanded');
        arrow.className = 'fas fa-chevron-down dropdown-arrow';
        content.style.display = 'none';
    } else {
        content.classList.add('expanded');
        header.classList.add('expanded');
        arrow.className = 'fas fa-chevron-up dropdown-arrow';
        content.style.display = 'block';
    }
}

function renderDropdownSuggestions(variableId, suggestions) {
    const suggestionsList = document.getElementById(`suggestions-list-${variableId}`);
    const countElement = document.getElementById(`count-${variableId}`);
    
    if (!suggestionsList) return;
    
    if (!suggestions || suggestions.length === 0) {
        suggestionsList.innerHTML = `
            <div class="suggestions-empty">
                <i class="fas fa-info-circle"></i>
                No similar variables found
            </div>
        `;
        return;
    }
    
    const suggestionsHtml = suggestions.map(suggestion => `
        <div class="suggestion-item" onclick="applySuggestionFromDropdown('${variableId}', ${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
            <div class="suggestion-main">
                <div class="suggestion-name">${suggestion.display_name || suggestion.variable_name}</div>
                <div class="suggestion-description">${suggestion.description || 'No description available'}</div>
                <div class="suggestion-scores">
                    <div class="score-detail">
                        <i class="fas fa-tag"></i> Name: <strong>${(suggestion.name_similarity * 100).toFixed(1)}%</strong>
                    </div>
                    ${suggestion.description_similarity !== null ? `
                        <div class="score-detail">
                            <i class="fas fa-file-text"></i> Description: <strong>${(suggestion.description_similarity * 100).toFixed(1)}%</strong>
                        </div>
                    ` : ''}
                    <div class="score-detail combined-score">
                        <i class="fas fa-chart-line"></i> Combined: <strong>${(suggestion.combined_similarity * 100).toFixed(1)}%</strong>
                    </div>
                </div>
            </div>
            <div class="suggestion-confidence">
                <span class="confidence-badge ${getConfidenceColorClass(suggestion.confidence_label)}">
                    ${suggestion.confidence_label}
                </span>
            </div>
        </div>
    `).join('');
    
    suggestionsList.innerHTML = suggestionsHtml;
    
    // Update count badge
    if (countElement) {
        countElement.textContent = `${suggestions.length} found`;
    }
}

function applySuggestionFromDropdown(variableId, suggestionData) {
    applyAISuggestion(variableId, suggestionData);
    
    // Collapse the dropdown after selection
    toggleAISuggestions(variableId);
}

function applyAISuggestion(variableId, suggestion) {
    // Find the target attribute select for this variable
    const targetSelect = document.querySelector(`select[name="variable_${variableId}-target_attribute"]`);
    
    if (targetSelect) {
        // Set the selected value
        targetSelect.value = suggestion.attribute_id;
        
        // Trigger change event to update UI - this will call fetchTargetAttributeDetails via the event listener
        targetSelect.dispatchEvent(new Event('change'));
        
        // Show confidence indicator
        showConfidenceIndicator(variableId, suggestion);
        
        // Highlight the variable card as processed
        const card = document.querySelector(`[data-variable-name*="${variableId}"]`)?.closest('.variable-card');
        if (card) {
            card.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%)';
            card.style.borderColor = '#28a745';
            setTimeout(() => {
                card.style.background = '';
                card.style.borderColor = '';
            }, 2000);
        }
    }
}

function getConfidenceColorClass(confidenceLabel) {
    const label = confidenceLabel.toLowerCase();
    if (label.includes('excellent')) return 'success';
    if (label.includes('good')) return 'info';
    if (label.includes('fair')) return 'warning';
    return 'danger';
}

function selectSuggestion(variableId, targetAttributeId, targetName, suggestionData = null) {
    // This function is kept for backward compatibility
    applyAISuggestion(variableId, suggestionData || {
        attribute_id: targetAttributeId,
        variable_name: targetName
    });
}

function showSuggestionsForVariable(variableId) {
    const suggestionsDiv = document.getElementById(`suggestions-${variableId}`);
    const container = suggestionsDiv.querySelector('.suggestions-container');
    const loading = suggestionsDiv.querySelector('.suggestions-loading');
    
    // Show the suggestions section
    suggestionsDiv.style.display = 'block';
    
    // Show loading state
    loading.style.display = 'flex';
    container.innerHTML = '';
    
    // Check if we have suggestions for this variable
    if (similaritySuggestions && similaritySuggestions[variableId]) {
        setTimeout(() => {
            loading.style.display = 'none';
            renderSuggestions(variableId, similaritySuggestions[variableId]);
        }, 500); // Small delay for better UX
    } else {
        setTimeout(() => {
            loading.style.display = 'none';
            container.innerHTML = `
                <div class="suggestions-empty">
                    <i class="fas fa-info-circle"></i>
                    No similarity suggestions available for this variable
                </div>
            `;
        }, 500);
    }
}

function renderSuggestions(variableId, suggestions) {
    const container = document.querySelector(`#suggestions-${variableId} .suggestions-container`);
    
    if (!suggestions || suggestions.length === 0) {
        container.innerHTML = `
            <div class="suggestions-empty">
                <i class="fas fa-info-circle"></i>
                No similar variables found
            </div>
        `;
        return;
    }
    
    const suggestionsHtml = suggestions.map(suggestion => `
        <div class="suggestion-item" onclick="selectSuggestion('${variableId}', ${suggestion.attribute_id}, '${suggestion.variable_name}', ${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
            <div class="suggestion-header">
                <div class="suggestion-name">${suggestion.display_name || suggestion.variable_name}</div>
                <span class="confidence-badge ${suggestion.confidence_color}">
                    ${suggestion.confidence_label}
                </span>
            </div>
            <div class="suggestion-details">
                ${suggestion.description || 'No description available'}
                <div class="suggestion-scores">
                    <div class="score-item">
                        <i class="fas fa-tag"></i>
                        <span>Name: <span class="score-value">${(suggestion.name_similarity * 100).toFixed(1)}%</span></span>
                    </div>
                    ${suggestion.description_similarity !== null ? `
                        <div class="score-item">
                            <i class="fas fa-file-text"></i>
                            <span>Description: <span class="score-value">${(suggestion.description_similarity * 100).toFixed(1)}%</span></span>
                        </div>
                    ` : ''}
                    <div class="score-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Combined: <span class="score-value">${(suggestion.combined_similarity * 100).toFixed(1)}%</span></span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = suggestionsHtml;
}

function addAIMatchingScores(variableId, targetAttributeId, detailsDiv) {
    // Check if there's AI matching data for this source variable
    const sourceVariable = document.getElementById(`variable-${variableId}`);
    if (!sourceVariable) return;
    
    // Look for an existing AI suggestion for this source variable
    const suggestion = window.currentAISuggestions && window.currentAISuggestions[variableId];
    if (!suggestion || suggestion.target_attribute_id !== targetAttributeId) {
        // No AI matching data available for this target
        removeAIMatchingScores(variableId);
        return;
    }
    
    // Add or update AI matching scores section
    let aiScoresDiv = document.getElementById(`ai-scores-${variableId}`);
    if (!aiScoresDiv) {
        aiScoresDiv = document.createElement('div');
        aiScoresDiv.id = `ai-scores-${variableId}`;
        aiScoresDiv.className = 'ai-matching-scores mt-3 p-3 bg-light rounded';
        detailsDiv.appendChild(aiScoresDiv);
    }
    
    aiScoresDiv.innerHTML = `
        <h6 class="text-primary mb-2">
            <i class="fas fa-robot me-1"></i> AI Matching Analysis
        </h6>
        <div class="row">
            <div class="col-md-4">
                <small class="text-muted">Name Similarity</small>
                <div class="fw-bold">${(suggestion.name_similarity * 100).toFixed(1)}%</div>
            </div>
            <div class="col-md-4">
                <small class="text-muted">Description Similarity</small>
                <div class="fw-bold">${(suggestion.description_similarity * 100).toFixed(1)}%</div>
            </div>
            <div class="col-md-4">
                <small class="text-muted">Combined Score</small>
                <div class="fw-bold text-primary">${(suggestion.combined_similarity * 100).toFixed(1)}%</div>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">Confidence: </small>
            <span class="badge bg-${getConfidenceBadgeColor(suggestion.confidence_label)}">${suggestion.confidence_label}</span>
        </div>
    `;
}

function removeAIMatchingScores(variableId) {
    const aiScoresDiv = document.getElementById(`ai-scores-${variableId}`);
    if (aiScoresDiv) {
        aiScoresDiv.remove();
    }
}

function getConfidenceBadgeColor(confidenceLabel) {
    const confidence = confidenceLabel.toLowerCase();
    if (confidence.includes('excellent')) return 'success';
    if (confidence.includes('good')) return 'info';
    if (confidence.includes('fair')) return 'warning';
    return 'secondary';
}

function showTargetVariableDetails(variableId, targetData, matchingScores = null) {
    const detailsDiv = document.getElementById(`target-details-${variableId}`);
    if (!detailsDiv) return;
    
    // Populate all the detail fields
    const nameElement = document.getElementById(`target-name-${variableId}`);
    const displayNameElement = document.getElementById(`target-display-name-${variableId}`);
    const descriptionElement = document.getElementById(`target-description-${variableId}`);
    const typeElement = document.getElementById(`target-type-${variableId}`);
    const unitElement = document.getElementById(`target-unit-${variableId}`);
    const ontologyElement = document.getElementById(`target-ontology-${variableId}`);
    const valuesCountElement = document.getElementById(`target-values-count-${variableId}`);
    
    if (nameElement) nameElement.textContent = targetData.variable_name || '-';
    if (displayNameElement) displayNameElement.textContent = targetData.display_name || '-';
    if (descriptionElement) descriptionElement.textContent = targetData.description || 'No description available';
    if (typeElement) typeElement.textContent = targetData.variable_type || 'Unknown';
    if (unitElement) unitElement.textContent = targetData.unit || 'Not specified';
    if (ontologyElement) ontologyElement.textContent = targetData.ontology_code || '-';
    if (valuesCountElement) valuesCountElement.textContent = targetData.values_count || '-';
    
    // Add AI matching scores if available
    addAIMatchingScores(variableId, targetData.attribute_id || targetData.id, detailsDiv);
    
    // Show the details section
    detailsDiv.style.display = 'block';
}

function selectSuggestion(variableId, targetAttributeId, targetName, suggestionData = null) {
    // This function is kept for backward compatibility
    applyAISuggestion(variableId, suggestionData || {
        attribute_id: targetAttributeId,
        variable_name: targetName
    });
}

function showConfidenceIndicator(variableId, suggestion) {
    const indicator = document.getElementById(`confidence-${variableId}`);
    if (indicator) {
        const confidence = suggestion.confidence_label.toLowerCase();
        // Map confidence labels to CSS classes properly
        let confidenceClass = 'confidence-poor'; // default
        if (confidence.includes('excellent')) confidenceClass = 'confidence-excellent';
        else if (confidence.includes('good')) confidenceClass = 'confidence-good';
        else if (confidence.includes('fair')) confidenceClass = 'confidence-fair';
        
        indicator.className = `confidence-indicator ${confidenceClass}`;
        indicator.textContent = `${suggestion.confidence_label} Match (${(suggestion.combined_similarity * 100).toFixed(1)}%)`;
        indicator.style.display = 'inline-block';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 1rem; border-radius: 8px; max-width: 400px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function getVariableIdFromCard(card) {
    // Extract variable ID from the card's data or form elements
    const formElement = card.querySelector('select[name*="variable_"]');
    if (formElement) {
        const match = formElement.name.match(/variable_(\d+)/);
        return match ? match[1] : null;
    }
    return null;
}

</script>
{% endblock %}
