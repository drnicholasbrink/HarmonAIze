{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Harmonization Dashboard" }}{% endblock %}

{% block css %}
  {{ block.super }}
  <style>
    :root {
      --primary-color: #007AFF;
      --secondary-color: #5AC8FA;
      --accent-color: #34C759;
      --health-color: #FF6B6B;
      --warning-color: #FF9500;
      --background-color: #F2F2F7;
      --card-background: #FFFFFF;
      --text-primary: #1C1C1E;
      --text-secondary: #8E8E93;
      --border-color: #C6C6C8;
      --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
    }

    body {
      background-color: var(--background-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .hero-section {
      background: var(--primary-color);
      color: white;
      padding: 2rem 0;
      margin: -1rem -15px 0 -15px;
      text-align: center;
    }

    .hero-header {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .hero-content h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .hero-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 1.5rem;
    }

    .progress-section {
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius);
      padding: 1rem 1.5rem;
      backdrop-filter: blur(10px);
      display: inline-block;
      min-width: 300px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .progress-stats {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .progress-bar-container {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      height: 8px;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
      height: 100%;
      border-radius: 50px;
      transition: width 0.5s ease;
    }

    .hero-actions {
      display: flex;
      gap: 1rem;
      flex-shrink: 0;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      font-weight: 500;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .main-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 2rem;
    }

    /* Breadcrumb Styles */
    .breadcrumb {
      background: transparent;
      padding: 1rem 0;
      margin-bottom: 0;
      border-radius: 0;
      font-size: 0.9rem;
    }

    .breadcrumb-item a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .breadcrumb-item a:hover {
      text-decoration: underline;
    }

    .breadcrumb-item.active {
      color: var(--text-secondary);
    }

    .breadcrumb-item + .breadcrumb-item::before {
      content: ">";
      color: var(--text-secondary);
      margin: 0 0.5rem;
    }

    .navigation-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Study Selection Panel */
    .study-selection-panel {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin: 1.5rem auto 0 auto;
      max-width: 1200px;
    }

    .study-selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1.5rem;
      align-items: end;
    }

    .study-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .study-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .study-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      padding: 0.75rem;
      background: var(--background-color);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    /* Universal Settings Panel */
    .settings-panel {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 2rem;
      grid-column: 1 / -1;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .settings-title {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-select, .form-input {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .form-select:focus, .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Variables Section */
    .variables-section {
      grid-column: 1;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .filter-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .filter-select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .search-input {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      width: 200px;
    }

    /* Variable Cards */
    .variable-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
      transition: all 0.2s;
    }

    .variable-card:hover {
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
    }

    .variable-card.complete {
      border-left: 4px solid var(--accent-color);
    }

    .variable-card.incomplete {
      border-left: 4px solid var(--warning-color);
    }

    .variable-card.not-mappable {
      border-left: 4px solid #ff9800;
      background: #f5f5f5;
      opacity: 0.7;
    }

    .variable-card.not-mappable .variable-content {
      opacity: 0.6;
    }

    .variable-card.not-mappable .source-attribute-details,
    .variable-card.not-mappable .mapping-form {
      filter: grayscale(50%);
    }

    .variable-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(45deg, #f8f9fa 0%, #ffffff 100%);
    }

    .variable-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .variable-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .completion-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .badge-complete {
      background: var(--accent-color);
      color: white;
    }

    .badge-incomplete {
      background: var(--warning-color);
      color: white;
    }

    .badge-not-mappable {
      background: #ff9800;
      color: white;
    }

    /* Source Attribute Details */
    .source-attribute-details {
      background: #f8f9fa;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .attribute-section-title {
      color: var(--primary-color);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .attribute-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .info-item.full-width {
      grid-column: 1 / -1;
    }
    
    .info-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .info-value {
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Target Attribute Details */
    .target-attribute-details {
      background: #f0f8ff;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border: 1px solid #b3d9ff;
    }
    
    .target-section-title {
      color: var(--info-color);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .target-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    /* Not Mappable Section - Horizontal at Bottom */
    .not-mappable-section-bottom {
      background: #fff8f0;
      padding: 1rem;
      border-top: 1px solid #ffcc80;
      border-radius: 0 0 8px 8px;
      margin-top: 1rem;
    }
    
    .checkbox-wrapper-horizontal {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .checkbox-label-horizontal {
      font-weight: 600;
      color: #007AFF;
      cursor: pointer;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }
    
    .help-text-inline {
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-style: italic;
      margin-left: auto;
    }

    /* Not Mappable Section */
    .not-mappable-section {
      background: #fff8f0;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #ffcc80;
      margin-bottom: 1rem;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .checkbox-label {
      font-weight: 600;
      color: #ff9800;
      cursor: pointer;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .not-mappable-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Advanced Options */
    .advanced-options {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      border: 1px solid #ddd;
    }
    
    .advanced-title {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Form Enhancements */
    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .help-text {
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-top: 0.25rem;
      line-height: 1.4;
    }
    
    .code-help {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      border-left: 3px solid var(--info-color);
    }
    
    .code-help code {
      background: #e9ecef;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .variable-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .variable-content {
      padding: 1.5rem;
    }

    .mapping-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .mapping-form .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-textarea {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 80px;
    }

    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .relationship-section {
      display: none;
      grid-column: 1 / -1;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .variable-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .btn-success {
      background: var(--accent-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    /* Sidebar */
    .sidebar {
      grid-column: 2;
    }

    .sidebar-section {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .sidebar-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      gap: 1rem;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--background-color);
      border-radius: 8px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .stat-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .bulk-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .action-btn {
      width: 100%;
      justify-content: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
        padding: 0 1rem;
      }

      .hero-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
        padding: 0 1rem;
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }

      .mapping-form {
        grid-template-columns: 1fr;
      }

      .sidebar {
        order: -1;
      }
    }

    /* Auto-save indicator */
    .auto-save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .auto-save-indicator.show {
      opacity: 1;
    }

    /* Error styling */
    .form-group.error .form-select,
    .form-group.error .form-input,
    .form-group.error .form-textarea {
      border-color: #dc3545;
    }

    .error-message {
      color: #dc3545;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
  </style>
{% endblock %}

{% block content %}
<div class="hero-section">
  <div class="hero-header">
    <div class="hero-content">
      <h1>Harmonise Study Dashboard</h1>
      <p class="hero-subtitle">Manage variable mappings and track harmonisation progress</p>
      
      {% if not creating_new %}
      <div class="progress-section">
        <div class="progress-header">
          <span>Progress</span>
          <span class="progress-stats">{{ completed_rules }}/{{ total_variables }} variables mapped</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: {{ progress_percent }}%"></div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Study Selection Panel -->
<div class="study-selection-panel">
  <form method="post" id="study-selection-form">
    {% csrf_token %}
    <div class="study-selection-grid">
      <div class="study-info">
        <label class="study-label">Source Study</label>
        <div class="study-value">{% if creating_new %}{{ study.name }}{% else %}{{ schema.source_study.name }}{% endif %}</div>
      </div>
      
      <div class="form-group" style="margin: 0;">
        <label class="form-label study-label">Target Database</label>
        {{ universal_form.target_study }}
        {% if universal_form.target_study.errors %}
          <div class="error-message">
            {% for error in universal_form.target_study.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      
      <div>
        <button type="submit" name="update_universal_settings" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Update
        </button>
      </div>
    </div>
    
    <!-- Hidden fields to preserve other universal settings -->
    {{ universal_form.universal_patient_id.as_hidden }}
    {{ universal_form.universal_datetime.as_hidden }}
    {{ universal_form.universal_relation_type.as_hidden }}
    {{ universal_form.comments.as_hidden }}
  </form>
</div>



<!-- Navigation Breadcrumbs -->
<div class="navigation-wrapper">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
      {% if creating_new %}
        {% if study.project %}
          <li class="breadcrumb-item"><a href="{% url 'core:project_list' %}">Projects</a></li>
          <li class="breadcrumb-item"><a href="{% url 'core:project_detail' study.project.pk %}">{{ study.project.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item"><a href="{% url 'core:study_detail' study.pk %}">{{ study.name }}</a></li>
      {% else %}
        {% if schema.source_study.project %}
          <li class="breadcrumb-item"><a href="{% url 'core:project_list' %}">Projects</a></li>
          <li class="breadcrumb-item"><a href="{% url 'core:project_detail' schema.source_study.project.pk %}">{{ schema.source_study.project.name }}</a></li>
        {% endif %}
        <li class="breadcrumb-item"><a href="{% url 'core:study_detail' schema.source_study.pk %}">{{ schema.source_study.name }}</a></li>
      {% endif %}
      <li class="breadcrumb-item active">Harmonise Dashboard</li>
    </ol>
  </nav>
</div>

{% if creating_new %}
<!-- Schema Creation Form -->
<div class="main-container" style="grid-template-columns: 1fr;">
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">
        <i class="fas fa-plus-circle"></i>
        Create Harmonization Schema
      </h2>
      <p class="hero-subtitle">Set up the mapping configuration for {{ study.name }}</p>
    </div>

    <form method="post">
      {% csrf_token %}
      <div class="settings-grid">
        <div class="form-group">
          <label class="form-label">Target Study</label>
          {{ form.target_study }}
          {% if form.target_study.errors %}
            <div class="error-message">
              {% for error in form.target_study.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Select the target database to harmonize this study with</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default Patient ID Variable</label>
          {{ form.universal_patient_id }}
          {% if form.universal_patient_id.errors %}
            <div class="error-message">
              {% for error in form.universal_patient_id.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Default patient identifier for all mappings</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default DateTime Variable</label>
          {{ form.universal_datetime }}
          {% if form.universal_datetime.errors %}
            <div class="error-message">
              {% for error in form.universal_datetime.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Default timestamp variable for all mappings</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default Relationship Type</label>
          {{ form.universal_relation_type }}
          {% if form.universal_relation_type.errors %}
            <div class="error-message">
              {% for error in form.universal_relation_type.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Default relationship type for all mappings</small>
        </div>
        
        <div class="form-group full-width">
          <label class="form-label">Comments</label>
          {{ form.comments }}
          {% if form.comments.errors %}
            <div class="error-message">
              {% for error in form.comments.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
          <small class="help-text">Optional notes about this harmonization schema</small>
        </div>
      </div>

      <div class="variable-actions">
        <a href="{% url 'core:study_detail' study.pk %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Cancel
        </a>
        <button type="submit" class="btn btn-success">
          <i class="fas fa-plus-circle"></i>
          Create Schema
        </button>
      </div>
    </form>
  </div>
</div>

{% else %}
<!-- Existing Harmonization Dashboard -->
<div class="main-container">
  <!-- Universal Settings Panel -->
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">
        <i class="fas fa-cog"></i>
        Universal Settings
      </h2>
      <button type="button" class="btn btn-outline btn-small" onclick="toggleSettingsForm()">
        <i class="fas fa-edit"></i>
        Edit Settings
      </button>
    </div>

    {% if universal_form %}
    <form method="post" id="universal-settings-form" style="display: none;">
      {% csrf_token %}
      <div class="settings-grid">
        <div class="form-group">
          <label class="form-label">Default Patient ID Variable</label>
          {{ universal_form.universal_patient_id }}
          {% if universal_form.universal_patient_id.errors %}
            <div class="error-message">
              {% for error in universal_form.universal_patient_id.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label">Default DateTime Variable</label>
          {{ universal_form.universal_datetime }}
          {% if universal_form.universal_datetime.errors %}
            <div class="error-message">
              {% for error in universal_form.universal_datetime.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label">Default Relationship Type</label>
          {{ universal_form.universal_relation_type }}
          {% if universal_form.universal_relation_type.errors %}
            <div class="error-message">
              {% for error in universal_form.universal_relation_type.errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Hidden field to preserve target_study when updating universal settings -->
      {{ universal_form.target_study.as_hidden }}

      <div class="variable-actions">
        <button type="button" class="btn btn-secondary btn-small" onclick="toggleSettingsForm()">Cancel</button>
        <button type="submit" name="update_universal_settings" class="btn btn-success btn-small">
          <i class="fas fa-check"></i>
          Save Universal Settings
        </button>
      </div>
    </form>
    {% endif %}

    <!-- Current Settings Display -->
    {% if universal_form %}
    <div id="settings-display">
      <div class="settings-grid">
        <div class="stat-item">
          <span class="stat-label">Patient ID</span>
          <span class="stat-value">{{ schema.universal_patient_id.variable_name|default:"Not set" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">DateTime</span>
          <span class="stat-value">{{ schema.universal_datetime.variable_name|default:"Not set" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Relationship</span>
          <span class="stat-value">{{ schema.get_universal_relation_type_display|default:"Self" }}</span>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Variables Section -->
  <div class="variables-section">
    <div class="section-header">
      <h2 class="section-title">Variable Mappings</h2>
      <div class="filter-controls">
        <select class="filter-select" id="completion-filter">
          <option value="all">All Variables</option>
          <option value="complete">Mapped Only</option>
          <option value="incomplete">Unmapped Only</option>
          <option value="not-mappable">Not Mappable Only</option>
        </select>
        <input type="text" class="search-input" id="search-variables" placeholder="Search variables...">
      </div>
    </div>

    <form method="post" id="mappings-form">
      {% csrf_token %}
      
      {% for variable_form in variable_forms %}
      <div class="variable-card {% if variable_form.is_complete %}complete{% elif variable_form.instance.not_mappable %}not-mappable{% else %}incomplete{% endif %}" 
           data-variable-name="{{ variable_form.attribute.variable_name|lower }}"
           data-completion="{% if variable_form.is_complete %}complete{% elif variable_form.instance.not_mappable %}not-mappable{% else %}incomplete{% endif %}">
        
        <div class="variable-header">
          <div class="variable-title">
            <span class="variable-name">{{ variable_form.attribute.display_name|default:variable_form.attribute.variable_name }}</span>
            <span class="completion-badge {% if variable_form.is_complete %}badge-complete{% elif variable_form.instance.not_mappable %}badge-not-mappable{% else %}badge-incomplete{% endif %}">
              {% if variable_form.is_complete %}
                <i class="fas fa-check"></i> Mapped
              {% elif variable_form.instance.not_mappable %}
                <i class="fas fa-ban"></i> Not Mappable
              {% else %}
                <i class="fas fa-exclamation-triangle"></i> Needs Mapping
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Source Attribute Details -->
        <div class="source-attribute-details">
          <h4 class="attribute-section-title">
            <i class="fas fa-upload"></i> Source Attribute
          </h4>
          <div class="attribute-info-grid">
            <div class="info-item">
              <span class="info-label">Variable Name:</span>
              <span class="info-value">{{ variable_form.attribute.variable_name }}</span>
            </div>
            {% if variable_form.attribute.display_name %}
            <div class="info-item">
              <span class="info-label">Display Name:</span>
              <span class="info-value">{{ variable_form.attribute.display_name }}</span>
            </div>
            {% endif %}
            {% if variable_form.attribute.description %}
            <div class="info-item full-width">
              <span class="info-label">Description:</span>
              <span class="info-value">{{ variable_form.attribute.description }}</span>
            </div>
            {% endif %}
            <div class="info-item">
              <span class="info-label">Data Type:</span>
              <span class="info-value">{{ variable_form.attribute.variable_type|default:"Unknown" }}</span>
            </div>
            {% if variable_form.attribute.unit %}
            <div class="info-item">
              <span class="info-label">Unit:</span>
              <span class="info-value">{{ variable_form.attribute.unit }}</span>
            </div>
            {% endif %}
            {% if variable_form.attribute.ontology_code %}
            <div class="info-item">
              <span class="info-label">Ontology Code:</span>
              <span class="info-value">{{ variable_form.attribute.ontology_code }}</span>
            </div>
            {% endif %}
            {% if variable_form.attribute.values_count %}
            <div class="info-item">
              <span class="info-label">Unique Values:</span>
              <span class="info-value">{{ variable_form.attribute.values_count }}</span>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="variable-content">
          <div class="mapping-form">
            <div class="mapping-fields" style="{% if variable_form.instance.not_mappable %}display: none;{% endif %}">
              <!-- Target Attribute Selection -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-download"></i> Target Variable
                </label>
                {{ variable_form.form.target_attribute }}
                {% if variable_form.form.target_attribute.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.target_attribute.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="help-text">Select the target variable this source variable maps to</small>
              </div>

              <!-- Target Attribute Details (populated via JavaScript) -->
              <div class="target-attribute-details" id="target-details-{{ variable_form.attribute.id }}" style="display: none;">
                <h5 class="target-section-title">
                  <i class="fas fa-download"></i> Target Variable Details
                </h5>
                <div class="target-info-grid">
                  <!-- This will be populated by JavaScript when target is selected -->
                </div>
              </div>
              
              <!-- Role Selection -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag"></i> Mapping Role
                </label>
                {{ variable_form.form.role }}
                {% if variable_form.form.role.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.role.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="help-text">
                  <strong>Value:</strong> Map to target variable (most common) | 
                  <strong>Patient ID:</strong> Use as patient identifier | 
                  <strong>Date/Time:</strong> Use as timestamp | 
                  <strong>Related Patient ID:</strong> For family/related person data
                </small>
              </div>

              <!-- Custom Settings Checkbox -->
              <div class="form-group">
                <div class="checkbox-wrapper">
                  {{ variable_form.form.use_custom_settings }}
                  <label for="{{ variable_form.form.use_custom_settings.id_for_label }}" class="checkbox-label-horizontal">
                    <i class="fas fa-cogs"></i> Use custom settings
                  </label>
                </div>
                <small class="help-text">{{ variable_form.form.use_custom_settings.help_text }}</small>
              </div>

              <!-- Custom Settings (override universal settings) -->
              <div class="advanced-options" id="custom-settings-{{ variable_form.attribute.id }}" style="{% if not variable_form.form.use_custom_settings.value %}display: none;{% endif %}">
                <h5 class="advanced-title">
                  <i class="fas fa-cog"></i> Custom Settings (Override Universal)
                </h5>
                
                <div class="form-group">
                  <label class="form-label">Custom Patient ID</label>
                  {{ variable_form.form.patient_id_attribute }}
                  {% if variable_form.form.patient_id_attribute.errors %}
                    <div class="error-message">
                      {% for error in variable_form.form.patient_id_attribute.errors %}
                        <span>{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <small class="help-text">Override universal patient ID setting for this specific mapping</small>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Custom DateTime</label>
                  {{ variable_form.form.datetime_attribute }}
                  {% if variable_form.form.datetime_attribute.errors %}
                    <div class="error-message">
                      {% for error in variable_form.form.datetime_attribute.errors %}
                        <span>{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <small class="help-text">Override universal datetime setting for this specific mapping</small>
                </div>
                
                <!-- Relationship Type (only for related patient role) -->
                <div class="form-group" id="relationship-{{ variable_form.attribute.id }}" style="{% if variable_form.form.role.value != 'related_patient_id' %}display: none;{% endif %}">
                  <label class="form-label">Relationship Type</label>
                  {{ variable_form.form.related_relation_type }}
                  {% if variable_form.form.related_relation_type.errors %}
                    <div class="error-message">
                      {% for error in variable_form.form.related_relation_type.errors %}
                        <span>{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <small class="help-text">Required when role is 'Related Patient ID'</small>
                </div>
              </div>
              
              <!-- Transform Code -->
              <div class="form-group full-width">
                <label class="form-label">
                  <i class="fas fa-code"></i> Transform Code (Optional)
                </label>
                {{ variable_form.form.transform_code }}
                {% if variable_form.form.transform_code.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.transform_code.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="code-help">
                  <small class="help-text">
                    <strong>Transform Examples:</strong><br>
                    Text: <code>lambda value: value.upper().strip()</code><br>
                    Split: <code>lambda value: value.split(',')[0] if value else None</code><br>
                    Units: <code>lambda value: float(value) * 2.54 if value else None</code><br>
                    Replace: <code>lambda value: value.replace('old', 'new')</code><br>
                    Complex: Use <code>def transform(value): ...</code> for multi-line logic<br>
                    <strong>Safe methods:</strong> <code>.upper()</code>, <code>.lower()</code>, <code>.strip()</code>, <code>.split()</code>, <code>.replace()</code>, <code>.join()</code>, and more string/list methods
                  </small>
                </div>
              </div>
              
              <!-- Comments -->
              <div class="form-group full-width">
                <label class="form-label">
                  <i class="fas fa-comment"></i> Comments (Optional)
                </label>
                {{ variable_form.form.comments }}
                {% if variable_form.form.comments.errors %}
                  <div class="error-message">
                    {% for error in variable_form.form.comments.errors %}
                      <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="help-text">Optional notes about this mapping</small>
              </div>
            </div>
          </div>

          <div class="variable-actions">
            <button type="button" class="btn btn-warning btn-small" onclick="clearMapping({{ variable_form.attribute.id }})">
              <i class="fas fa-times"></i>
              Clear
            </button>
            <button type="button" class="btn btn-success btn-small" onclick="saveMapping({{ variable_form.attribute.id }})">
              <i class="fas fa-save"></i>
              Save
            </button>
          </div>

          <!-- Not Mappable Option - Horizontal Layout at Bottom -->
          <div class="not-mappable-section-bottom">
            <div class="checkbox-wrapper-horizontal">
              {{ variable_form.form.not_mappable }}
              <label for="{{ variable_form.form.not_mappable.id_for_label }}" class="checkbox-label-horizontal">
                <i class="fas fa-ban"></i> Mark as not mappable
              </label>
              <small class="help-text-inline">This variable cannot be mapped to any target variable</small>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </form>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Progress Stats -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">Progress</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">Total Variables</span>
          <span class="stat-value">{{ total_variables }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Mapped</span>
          <span class="stat-value">{{ completed_rules|add:"-"|add:not_mappable_count }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Not Mappable</span>
          <span class="stat-value">{{ not_mappable_count }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Remaining</span>
          <span class="stat-value">{{ total_variables|add:"-"|add:completed_rules }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Completion</span>
          <span class="stat-value">{{ progress_percent }}%</span>
        </div>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">Bulk Actions</h3>
      <div class="bulk-actions">
        <button type="button" class="btn btn-outline action-btn" onclick="applyUniversalSettings()">
          <i class="fas fa-magic"></i>
          Apply Universal Settings
        </button>
        <button type="button" class="btn btn-outline action-btn" onclick="clearAllMappings()">
          <i class="fas fa-trash"></i>
          Clear All Mappings
        </button>
        <button type="button" class="btn btn-primary action-btn" onclick="validateAllMappings()">
          <i class="fas fa-check-circle"></i>
          Validate All
        </button>
      </div>
    </div>

    <!-- Navigation -->
    <div class="sidebar-section">
      <h3 class="sidebar-title">Navigation</h3>
      <div class="bulk-actions">
        <!--greyed out until 100%-->
        {% if progress_percent < 100 %}
          <button type="button" class="btn btn-secondary action-btn" disabled>
            <i class="fas fa-check"></i>
            Approve & Finalize
          </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
<!-- Auto-save indicator -->
<div class="auto-save-indicator" id="auto-save-indicator">
  <i class="fas fa-save"></i> Saving...
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize role-dependent sections
    initializeRoleDependentSections();
    
    // Initialize filters
    initializeFilters();
    
    // Initialize auto-save
    initializeAutoSave();
});

function initializeRoleDependentSections() {
    document.querySelectorAll('select[name$="-role"]').forEach(select => {
        const variableId = select.name.match(/variable_(\d+)-role/)[1];
        const relationshipSection = document.getElementById(`relationship-${variableId}`);
        
        function toggleRelationshipSection() {
            if (select.value === 'related_patient_id') {
                relationshipSection.style.display = 'block';
            } else {
                relationshipSection.style.display = 'none';
            }
        }
        
        // Initialize state
        toggleRelationshipSection();
        
        // Listen for changes
        select.addEventListener('change', toggleRelationshipSection);
    });
}

function initializeFilters() {
    const completionFilter = document.getElementById('completion-filter');
    const searchInput = document.getElementById('search-variables');
    
    function filterVariables() {
        const completionValue = completionFilter.value;
        const searchValue = searchInput.value.toLowerCase();
        
        document.querySelectorAll('.variable-card').forEach(card => {
            const completion = card.dataset.completion;
            const variableName = card.dataset.variableName;
            
            let showCompletion = completionValue === 'all' || completion === completionValue;
            let showSearch = !searchValue || variableName.includes(searchValue);
            
            if (showCompletion && showSearch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    completionFilter.addEventListener('change', filterVariables);
    searchInput.addEventListener('input', filterVariables);
}

function initializeAutoSave() {
    let autoSaveTimeout;
    const indicator = document.getElementById('auto-save-indicator');
    
    function showSaveIndicator() {
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
    }
    
    function triggerAutoSave(variableId) {
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        autoSaveTimeout = setTimeout(() => {
            saveMapping(variableId, true);
        }, 2000);
    }
    
    // Listen for form changes
    document.querySelectorAll('select, textarea, input').forEach(element => {
        if (element.name && element.name.startsWith('variable_')) {
            element.addEventListener('change', function() {
                const variableId = element.name.match(/variable_(\d+)/)[1];
                triggerAutoSave(variableId);
            });
        }
    });
}

function toggleSettingsForm() {
    const form = document.getElementById('universal-settings-form');
    const display = document.getElementById('settings-display');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        display.style.display = 'none';
    } else {
        form.style.display = 'none';
        display.style.display = 'block';
    }
}

function saveMapping(variableId, isAutoSave = false) {
    const form = document.getElementById('mappings-form');
    const formData = new FormData(form);
    
    // Only include data for this specific variable
    const newFormData = new FormData();
    newFormData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));
    
    for (const [key, value] of formData.entries()) {
        if (key.startsWith(`variable_${variableId}-`)) {
            newFormData.append(key, value);
        }
    }
    
    if (!isAutoSave) {
        document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-save"></i> Saving...';
        document.getElementById('auto-save-indicator').classList.add('show');
    }
    
    fetch(window.location.href, {
        method: 'POST',
        body: newFormData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (!isAutoSave) {
                document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-check"></i> Saved!';
                setTimeout(() => {
                    document.getElementById('auto-save-indicator').classList.remove('show');
                }, 2000);
            }
            
            // Update completion status
            const card = document.querySelector(`[data-variable-name="${data.variable_name.toLowerCase()}"]`);
            if (card && data.is_complete) {
                card.classList.remove('incomplete');
                card.classList.add('complete');
                card.dataset.completion = 'complete';
                
                const badge = card.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-complete';
                badge.innerHTML = '<i class="fas fa-check"></i> Mapped';
            }
        } else {
            console.error('Save failed:', data.errors);
            
            // Show specific errors to the user
            if (data.errors && Array.isArray(data.errors)) {
                data.errors.forEach(error => {
                    showErrorNotification(error);
                });
            } else if (data.errors) {
                showErrorNotification(`Save failed: ${JSON.stringify(data.errors)}`);
            } else {
                showErrorNotification('Save failed: Unknown error occurred');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (!isAutoSave) {
            // Show more detailed error message
            const errorMsg = error.message || 'Network error occurred';
            document.getElementById('auto-save-indicator').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${errorMsg}`;
            document.getElementById('auto-save-indicator').style.color = '#dc3545';
            setTimeout(() => {
                document.getElementById('auto-save-indicator').classList.remove('show');
                document.getElementById('auto-save-indicator').style.color = '';
            }, 5000);
        }
        
        // Also show a notification at the top of the page
        showErrorNotification(`Save failed: ${error.message || 'Network error'}`);
    });
}

function saveAllMappings() {
    const form = document.getElementById('mappings-form');
    const formData = new FormData(form);
    
    document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-save"></i> Saving all...';
    document.getElementById('auto-save-indicator').classList.add('show');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-check"></i> All saved!';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error('Save failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('auto-save-indicator').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error!';
        setTimeout(() => {
            document.getElementById('auto-save-indicator').classList.remove('show');
        }, 2000);
    });
}

function clearMapping(variableId) {
    if (confirm('Are you sure you want to clear this mapping?')) {
        // Clear form fields for this variable
        document.querySelectorAll(`[name^="variable_${variableId}-"]`).forEach(field => {
            if (field.type === 'select-one') {
                field.selectedIndex = 0;
            } else {
                field.value = '';
            }
        });
        
        // Save the cleared mapping
        saveMapping(variableId);
    }
}

function applyUniversalSettings() {
    if (confirm('Apply universal settings to all unmapped variables?')) {
        // This would trigger a special form submission
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.href;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'apply_universal_settings';
        actionInput.value = 'true';
        
        form.appendChild(csrfInput);
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function clearAllMappings() {
    if (confirm('Are you sure you want to clear ALL mappings? This cannot be undone.')) {
        // Clear all form fields
        document.querySelectorAll('select, textarea, input[type="text"]').forEach(field => {
            if (field.name && field.name.startsWith('variable_')) {
                if (field.type === 'select-one') {
                    field.selectedIndex = 0;
                } else {
                    field.value = '';
                }
            }
        });
        
        saveAllMappings();
    }
}

function validateAllMappings() {
    // This could check for required fields, validate transforms, etc. TO DO
    const incompleteVariables = document.querySelectorAll('.variable-card.incomplete').length;
    
    if (incompleteVariables > 0) {
        alert(`There are ${incompleteVariables} variables that still need mapping before validation.`);
    } else {
        alert('All variables are mapped! You can now proceed to approval.');
    }
}

function showErrorNotification(message) {
    // Create or get the notification container
    let container = document.querySelector('.error-notifications');
    if (!container) {
        container = document.createElement('div');
        container.className = 'error-notifications';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        `;
        document.body.appendChild(container);
    }
    
    // Create the notification element
    const notification = document.createElement('div');
    notification.className = 'error-notification';
    notification.style.cssText = `
        background-color: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 1rem 1.5rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInRight 0.3s ease-out;
        cursor: pointer;
    `;
    notification.innerHTML = `
        <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> ${message}
        <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">Click to dismiss</div>
    `;
    
    // Add click to dismiss
    notification.addEventListener('click', () => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    });
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 10000);
    
    container.appendChild(notification);
}

// Add CSS animations for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
`;
document.head.appendChild(style);
// Enhanced functionality for improved harmonization cards

// Handle not mappable checkbox changes
document.addEventListener('DOMContentLoaded', function() {
    // Initialize target details for existing selections
    document.querySelectorAll('select[name*="target_attribute"]').forEach(targetSelect => {
        if (targetSelect.value) {
            // Trigger change event to populate details for existing selections
            targetSelect.dispatchEvent(new Event('change'));
        }
    });
    
    // Add event listeners for not mappable checkboxes
    document.querySelectorAll('.not-mappable-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const mappingFields = variableCard.querySelector('.mapping-fields');
            
            if (this.checked) {
                // Hide mapping fields and grey out card when not mappable is checked
                mappingFields.style.display = 'none';
                variableCard.classList.remove('complete', 'incomplete');
                variableCard.classList.add('not-mappable');
                
                // Update badge
                const badge = variableCard.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-not-mappable';
                badge.innerHTML = '<i class="fas fa-ban"></i> Not Mappable';
                
                // Clear target attribute selection
                const targetSelect = variableCard.querySelector('select[name*="target_attribute"]');
                if (targetSelect) targetSelect.selectedIndex = 0;
                
            } else {
                // Show mapping fields and remove grey-out when not mappable is unchecked
                mappingFields.style.display = 'block';
                variableCard.classList.remove('not-mappable');
                variableCard.classList.add('incomplete');
                
                // Update badge
                const badge = variableCard.querySelector('.completion-badge');
                badge.className = 'completion-badge badge-incomplete';
                badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Needs Mapping';
            }
        });
    });
    
    // Add event listeners for role changes
    document.querySelectorAll('select[name*="role"]').forEach(roleSelect => {
        roleSelect.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const relationshipSection = variableCard.querySelector('[id^="relationship-"]');
            
            if (this.value === 'related_patient_id') {
                // Show relationship type for related patient ID role
                relationshipSection.style.display = 'block';
            } else {
                // Hide relationship type for other roles
                relationshipSection.style.display = 'none';
            }
        });
    });
    
    // Add event listeners for custom settings checkbox
    document.querySelectorAll('input[name*="use_custom_settings"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const customSettingsSection = variableCard.querySelector('[id^="custom-settings-"]');
            
            if (this.checked) {
                // Show custom settings when checkbox is checked
                customSettingsSection.style.display = 'block';
            } else {
                // Hide custom settings when checkbox is unchecked
                customSettingsSection.style.display = 'none';
            }
        });
    });
    
    // Add event listeners for custom settings checkbox
    document.querySelectorAll('.custom-settings-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const customSettingsSection = variableCard.querySelector('[id^="custom-settings-"]');
            
            if (this.checked) {
                // Show custom settings when checkbox is checked
                customSettingsSection.style.display = 'block';
            } else {
                // Hide custom settings when checkbox is unchecked
                customSettingsSection.style.display = 'none';
                
                // Clear the custom settings fields when hiding
                const patientIdField = customSettingsSection.querySelector('select[name*="patient_id_attribute"]');
                const datetimeField = customSettingsSection.querySelector('select[name*="datetime_attribute"]');
                const relationField = customSettingsSection.querySelector('select[name*="related_relation_type"]');
                
                if (patientIdField) patientIdField.selectedIndex = 0;
                if (datetimeField) datetimeField.selectedIndex = 0;
                if (relationField) relationField.selectedIndex = 0;
            }
        });
    });
    
    // Add event listeners for target attribute changes
    document.querySelectorAll('select[name*="target_attribute"]').forEach(targetSelect => {
        targetSelect.addEventListener('change', function() {
            const variableCard = this.closest('.variable-card');
            const targetDetails = variableCard.querySelector('.target-attribute-details');
            
            if (this.value) {
                // Show target details and populate them with actual metadata
                targetDetails.style.display = 'block';
                
                // Get selected option details
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    // Extract data attributes from the option if available
                    const infoGrid = targetDetails.querySelector('.target-info-grid');
                    
                    // Get target variable data from the option's data attributes or text
                    const variableName = selectedOption.text;
                    const displayName = selectedOption.getAttribute('data-display-name') || '';
                    const unit = selectedOption.getAttribute('data-unit') || '';
                    const variableType = selectedOption.getAttribute('data-variable-type') || '';
                    const description = selectedOption.getAttribute('data-description') || '';
                    const ontologyCode = selectedOption.getAttribute('data-ontology-code') || '';
                    
                    let infoHtml = `
                        <div class="info-item">
                            <span class="info-label">Variable Name:</span>
                            <span class="info-value">${variableName}</span>
                        </div>`;
                    
                    if (displayName) {
                        infoHtml += `
                        <div class="info-item">
                            <span class="info-label">Display Name:</span>
                            <span class="info-value">${displayName}</span>
                        </div>`;
                    }
                    
                    if (variableType) {
                        infoHtml += `
                        <div class="info-item">
                            <span class="info-label">Data Type:</span>
                            <span class="info-value">${variableType}</span>
                        </div>`;
                    }
                    
                    if (unit) {
                        infoHtml += `
                        <div class="info-item">
                            <span class="info-label">Unit:</span>
                            <span class="info-value">${unit}</span>
                        </div>`;
                    }
                    
                    if (ontologyCode) {
                        infoHtml += `
                        <div class="info-item">
                            <span class="info-label">Ontology Code:</span>
                            <span class="info-value">${ontologyCode}</span>
                        </div>`;
                    }
                    
                    if (description) {
                        infoHtml += `
                        <div class="info-item full-width">
                            <span class="info-label">Description:</span>
                            <span class="info-value">${description}</span>
                        </div>`;
                    }
                    
                    infoGrid.innerHTML = infoHtml;
                }
                
                // Update completion status
                updateVariableCompletionStatus(variableCard);
            } else {
                // Hide target details if no target selected
                targetDetails.style.display = 'none';
            }
        });
    });
});

// Function to update variable completion status
function updateVariableCompletionStatus(variableCard) {
    const notMappableCheck = variableCard.querySelector('.not-mappable-checkbox');
    const targetSelect = variableCard.querySelector('select[name*="target_attribute"]');
    const badge = variableCard.querySelector('.completion-badge');
    
    if (notMappableCheck && notMappableCheck.checked) {
        // Already handled in the checkbox event listener
        return;
    }
    
    if (targetSelect && targetSelect.value) {
        // Variable is mapped
        variableCard.classList.remove('incomplete', 'not-mappable');
        variableCard.classList.add('complete');
        badge.className = 'completion-badge badge-complete';
        badge.innerHTML = '<i class="fas fa-check"></i> Mapped';
    } else {
        // Variable needs mapping
        variableCard.classList.remove('complete', 'not-mappable');
        variableCard.classList.add('incomplete');
        badge.className = 'completion-badge badge-incomplete';
        badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Needs Mapping';
    }
}

// Enhanced clear mapping function
function clearMapping(variableId) {
    if (confirm('Are you sure you want to clear this mapping?')) {
        // Clear form fields for this variable
        const variableCard = document.querySelector(`[data-variable-name*="${variableId}"]`).closest('.variable-card');
        
        // Clear all form inputs
        variableCard.querySelectorAll('select, textarea, input[type="text"]').forEach(field => {
            if (field.type === 'select-one') {
                field.selectedIndex = 0;
            } else if (field.type === 'checkbox') {
                field.checked = false;
            } else {
                field.value = '';
            }
        });
        
        // Hide custom settings and relationship sections when cleared
        const customSettingsSection = variableCard.querySelector('[id^="custom-settings-"]');
        const relationshipSection = variableCard.querySelector('[id^="relationship-"]');
        const mappingFields = variableCard.querySelector('.mapping-fields');
        
        if (customSettingsSection) customSettingsSection.style.display = 'none';
        if (relationshipSection) relationshipSection.style.display = 'none';
        if (mappingFields) mappingFields.style.display = 'block';
        
        // Hide target details
        const targetDetails = variableCard.querySelector('.target-attribute-details');
        if (targetDetails) targetDetails.style.display = 'none';
        
        // Update completion status
        updateVariableCompletionStatus(variableCard);
        
        // Save the cleared mapping
        saveMapping(variableId);
    }
}

</script>
{% endblock %}
