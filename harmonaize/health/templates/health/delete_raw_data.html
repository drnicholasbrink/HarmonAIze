{% extends "base.html" %}
{% load static %}

{% block title %}Delete Raw Data File - {{ raw_data_file.original_filename }}{% endblock %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary-color: #007AFF;
    --secondary-color: #5AC8FA;
    --accent-color: #34C759;
    --warning-color: #FF9500;
    --error-color: #FF3B30;
    --background-color: #F2F2F7;
    --card-background: #FFFFFF;
    --text-primary: #1C1C1E;
    --text-secondary: #8E8E93;
    --border-color: #C6C6C8;
    --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    --border-radius: 12px;
    --danger-color: var(--error-color);
    --light-danger: rgba(255, 59, 48, 0.1);
    --light-warning: rgba(255, 149, 0, 0.1);
  }

  body {
    background-color: var(--background-color);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: var(--text-primary);
  }

  .delete-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .breadcrumb {
    background: transparent;
    padding: 0 0 1rem 0;
    margin: 0;
    font-size: 0.9rem;
  }

  .breadcrumb-item + .breadcrumb-item::before {
    content: "â€º";
    color: var(--text-secondary);
  }

  .breadcrumb-item a {
    color: var(--primary-color);
    text-decoration: none;
  }

  .breadcrumb-item.active {
    color: var(--text-secondary);
  }

  .danger-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem;
    background: var(--light-danger);
    border: 2px solid var(--danger-color);
    border-radius: var(--border-radius);
  }

  .danger-icon {
    font-size: 3rem;
    color: var(--danger-color);
    margin-bottom: 1rem;
  }

  .danger-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--danger-color);
    margin-bottom: 0.5rem;
  }

  .danger-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin: 0;
  }

  .delete-content {
    background: var(--card-background);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .file-info {
    padding: 2rem;
    border-bottom: 1px solid var(--border-color);
  }

  .file-info h4 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .info-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: var(--background-color);
    border-radius: 8px;
  }

  .info-icon {
    font-size: 1.2rem;
    margin-right: 0.75rem;
    width: 1.5rem;
    text-align: center;
  }

  .info-text {
    flex: 1;
  }

  .info-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.2rem;
  }

  .info-value {
    font-weight: 600;
    color: var(--text-primary);
  }

  .impact-section {
    padding: 2rem;
    border-bottom: 1px solid var(--border-color);
  }

  .impact-section h4 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .warning-box {
    background: var(--light-warning);
    border-left: 4px solid var(--warning-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
  }

  .warning-box h5 {
    color: var(--warning-color);
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .impact-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .impact-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .impact-item:last-child {
    border-bottom: none;
  }

  .impact-icon {
    font-size: 1.2rem;
    margin-right: 1rem;
    color: var(--warning-color);
    width: 1.5rem;
    text-align: center;
  }

  .impact-text {
    flex: 1;
  }

  .impact-count {
    font-weight: 700;
    color: var(--warning-color);
    background: rgba(255, 149, 0, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
  }

  .confirmation-section {
    padding: 2rem;
  }

  .confirmation-section h5 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    font-weight: 600;
  }

  .confirmation-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--card-background);
    border-radius: 8px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .confirmation-checkbox:hover {
    border-color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
  }

  .confirmation-checkbox.confirmed {
    background: rgba(52, 199, 89, 0.05);
    border-color: var(--accent-color);
  }

  .confirmation-checkbox input[type="checkbox"] {
    margin-top: 0.2rem;
    transform: scale(1.3);
    accent-color: var(--accent-color);
    cursor: pointer;
  }

  .confirmation-text {
    font-size: 0.95rem;
    line-height: 1.4;
    color: var(--text-primary);
    cursor: pointer;
  }

  .confirmation-text strong {
    color: var(--error-color);
  }

  .confirmation-text em {
    color: var(--primary-color);
    font-style: normal;
    font-weight: 600;
  }

  .study-name-confirmation {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: var(--card-background);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
  }

  .study-name-confirmation .form-label {
    display: block;
    margin-bottom: 0.75rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .study-name-confirmation code {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.9rem;
    color: var(--primary-color);
  }

  .study-name-confirmation .form-control {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    background: var(--card-background);
  }

  .study-name-confirmation .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    transform: translateY(-1px);
  }

  .study-name-confirmation .form-control.valid {
    border-color: var(--accent-color);
    background-color: rgba(52, 199, 89, 0.05);
    box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
  }

  .study-name-confirmation .form-control.invalid {
    border-color: var(--error-color);
    background-color: rgba(255, 59, 48, 0.05);
    box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1);
  }

  .study-name-feedback {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .study-name-feedback.valid {
    color: var(--accent-color);
  }

  .study-name-feedback.invalid {
    color: var(--error-color);
  }

  .study-name-feedback i {
    margin-right: 0.5rem;
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    padding: 2rem;
    background: var(--background-color);
  }

  .btn-secondary,
  .btn-danger-confirm {
    padding: 0.875rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
  }

  .btn-secondary {
    background: var(--text-secondary);
    color: white;
  }

  .btn-secondary:hover {
    background: #6c757d;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .btn-danger-confirm {
    background: var(--text-secondary);
    color: white;
    opacity: 0.7;
    cursor: not-allowed;
    min-width: 220px;
    justify-content: center;
    transition: all 0.3s ease !important;
  }

  .btn-danger-confirm.enabled,
  .btn-danger-confirm:not(:disabled) {
    background: linear-gradient(135deg, var(--error-color), #ff4757) !important;
    opacity: 1 !important;
    cursor: pointer !important;
  }

  .btn-danger-confirm.enabled:hover,
  .btn-danger-confirm:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 59, 48, 0.4);
  }

  .btn-danger-confirm.disabled,
  .btn-danger-confirm:disabled {
    background: var(--text-secondary) !important;
    opacity: 0.7 !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
  }

  .btn-danger-confirm i {
    margin-right: 0.5rem;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  .info-note {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(13, 202, 240, 0.1);
    border-left: 4px solid var(--secondary-color);
    border-radius: 4px;
  }

  .info-note small {
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .info-note strong {
    color: var(--text-primary);
  }
</style>
{% endblock css %}

{% block content %}
<div class="delete-container">
  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'health:raw_data_list' %}">Raw Data Files</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'health:raw_data_detail' raw_data_file.id %}">{{ raw_data_file.original_filename }}</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Delete</li>
    </ol>
  </nav>

  <!-- Danger Header -->
  <div class="danger-header">
    <div class="danger-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h2 class="danger-title">Permanent Deletion Warning</h2>
    <p class="danger-subtitle">This action cannot be undone and will remove all associated data</p>
  </div>

  <div class="delete-content">
    <!-- File Information -->
    <div class="file-info">
      <h4><i class="fas fa-file-csv me-2"></i>File Details</h4>
      <div class="info-grid">
        <div class="info-item">
          <i class="fas fa-file info-icon" style="color: var(--primary-color);"></i>
          <div class="info-text">
            <div class="info-label">Filename</div>
            <div class="info-value">{{ raw_data_file.original_filename }}</div>
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-microscope info-icon" style="color: var(--secondary-color);"></i>
          <div class="info-text">
            <div class="info-label">Study</div>
            <div class="info-value">{{ raw_data_file.study.name }}</div>
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-calendar info-icon" style="color: var(--warning-color);"></i>
          <div class="info-text">
            <div class="info-label">Uploaded</div>
            <div class="info-value">{{ raw_data_file.uploaded_at|date:"M d, Y" }}</div>
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-database info-icon" style="color: var(--accent-color);"></i>
          <div class="info-text">
            <div class="info-label">Columns</div>
            <div class="info-value">{{ deletion_impact.columns_count }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Impact Analysis -->
    <div class="impact-section">
      <h4><i class="fas fa-impact me-2"></i>Deletion Impact</h4>
      
      <div style="background: rgba(255, 59, 48, 0.1); border: 1px solid var(--error-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
        <h5 style="color: var(--error-color); margin-bottom: 1rem;">
          <i class="fas fa-trash-alt"></i> What will be permanently deleted:
        </h5>
        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-primary);">
          <li>Raw data file: <strong>{{ raw_data_file.original_filename }}</strong></li>
          <li>All column mappings ({{ deletion_impact.columns_count }} columns)</li>
          <li>File processing history and metadata</li>
        </ul>
      </div>

      {% if deletion_impact.observations_count > 0 %}
      <div class="warning-box">
        <h5><i class="fas fa-chart-line"></i> Data created from this file:</h5>
        <ul class="impact-list">
          <li class="impact-item">
            <i class="fas fa-chart-bar impact-icon"></i>
            <div class="impact-text">
              <strong>Observations will remain</strong><br>
              <small>{{ deletion_impact.observations_count }} observations created from this file will NOT be deleted</small>
            </div>
            <span class="impact-count">{{ deletion_impact.observations_count }}</span>
          </li>
          {% if deletion_impact.patients_count > 0 %}
          <li class="impact-item">
            <i class="fas fa-users impact-icon"></i>
            <div class="impact-text">
              <strong>Patients will remain</strong><br>
              <small>{{ deletion_impact.patients_count }} patients created during ingestion will NOT be deleted</small>
            </div>
            <span class="impact-count">{{ deletion_impact.patients_count }}</span>
          </li>
          {% endif %}
        </ul>
        <div class="info-note">
          <small><strong>Note:</strong> Observations and patients are not directly linked to raw data files, so they will remain in the system even after deletion. If you need to remove observations, you'll need to do that separately.</small>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Confirmation Form -->
    <form method="post" id="delete-form">
      {% csrf_token %}
      
      <div class="confirmation-section">
        <h5>Confirm Deletion</h5>
        
        <div class="confirmation-checkbox">
          <input type="checkbox" id="confirm-understand" name="confirm_understand" class="js-confirm" required>
          <label for="confirm-understand" class="confirmation-text">
            I understand that this action will <strong>permanently delete</strong> the raw data file 
            <em>"{{ raw_data_file.original_filename }}"</em> and all its associated column mappings.
          </label>
        </div>

        <div class="confirmation-checkbox">
          <input type="checkbox" id="confirm-no-undo" name="confirm_no_undo" class="js-confirm" required>
          <label for="confirm-no-undo" class="confirmation-text">
            I understand that this action <strong>cannot be undone</strong> and I will need to re-upload 
            and re-process the file if I need it again.
          </label>
        </div>

        {% if deletion_impact.observations_count > 0 %}
        <div class="confirmation-checkbox">
          <input type="checkbox" id="confirm-observations" name="confirm_observations" class="js-confirm" required>
          <label for="confirm-observations" class="confirmation-text">
            I understand that <strong>{{ deletion_impact.observations_count }} observations</strong> 
            created from this file will remain in the system and are not affected by this deletion.
          </label>
        </div>
        {% endif %}

        <!-- Study Name Confirmation -->
        <div class="study-name-confirmation">
          <label for="study-name-input" class="form-label">
            <strong>Type the study name to confirm:</strong> 
            <code>{{ raw_data_file.study.name }}</code>
          </label>
          <input type="text" 
                 id="study-name-input" 
                 name="study_name_confirmation" 
                 class="form-control" 
                 placeholder="Enter study name exactly as shown above"
                 autocomplete="off"
                 required>
          <div id="study-name-feedback" class="study-name-feedback"></div>
        </div>
      </div>

      <div class="action-buttons">
        <a href="{% url 'health:raw_data_detail' raw_data_file.id %}" class="btn-secondary">
          <i class="fas fa-arrow-left me-2"></i>Cancel
        </a>
        <button type="submit" class="btn-danger-confirm" id="delete-btn" disabled>
          <i class="fas fa-lock me-2"></i>Complete All Confirmations
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const studyNameInput = document.getElementById('study-name-input');
  const studyNameFeedback = document.getElementById('study-name-feedback');
  const deleteBtn = document.getElementById('delete-btn');
  const deleteForm = document.getElementById('delete-form');
  // Only consider the intended confirmation checkboxes inside this form
  const checkboxes = deleteForm.querySelectorAll('input.js-confirm[type="checkbox"]');
  
  // Get the expected study name from the template
  const expectedStudyName = '{{ raw_data_file.study.name|escapejs }}';
  
  console.log('Expected study name:', expectedStudyName);
  console.log('Initial button state:', deleteBtn.disabled);
  console.log('Found confirmation checkboxes in form:', checkboxes.length);
  console.log('Button element:', deleteBtn);
  
  function updateDeleteButton() {
    // Check checkboxes
    const allCheckboxesChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    // Check study name
    const studyNameValue = studyNameInput.value.trim();
    const studyNameValid = studyNameValue === expectedStudyName;
    
    // Update study name feedback
    if (studyNameValue === '') {
      studyNameInput.classList.remove('valid', 'invalid');
      studyNameFeedback.textContent = '';
      studyNameFeedback.className = 'study-name-feedback';
    } else if (studyNameValid) {
      studyNameInput.classList.remove('invalid');
      studyNameInput.classList.add('valid');
      studyNameFeedback.innerHTML = '<i class="fas fa-check-circle"></i> Study name matches';
      studyNameFeedback.className = 'study-name-feedback valid';
    } else {
      studyNameInput.classList.remove('valid');
      studyNameInput.classList.add('invalid');
      studyNameFeedback.innerHTML = '<i class="fas fa-times-circle"></i> Study name does not match';
      studyNameFeedback.className = 'study-name-feedback invalid';
    }
    
    // Update checkbox visual feedback
    checkboxes.forEach(cb => {
      const parent = cb.closest('.confirmation-checkbox');
      if (cb.checked) {
        parent.classList.add('confirmed');
      } else {
        parent.classList.remove('confirmed');
      }
    });
    
    // Update button state
    const canDelete = allCheckboxesChecked && studyNameValid;
    
    console.log('Validation status:', {
      allCheckboxesChecked,
      studyNameValid,
      studyNameValue,
      expectedStudyName,
      canDelete
    });
    
    // Force update the button DOM properties
    if (canDelete) {
      deleteBtn.disabled = false;
      deleteBtn.removeAttribute('disabled');
      deleteBtn.style.opacity = '1';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.style.background = 'linear-gradient(135deg, var(--error-color), #ff4757)';
      deleteBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Ready to Delete File';
      deleteBtn.classList.add('enabled');
      deleteBtn.classList.remove('disabled');
    } else {
      deleteBtn.disabled = true;
      deleteBtn.setAttribute('disabled', 'disabled');
      deleteBtn.style.opacity = '0.7';
      deleteBtn.style.cursor = 'not-allowed';
      deleteBtn.style.background = 'var(--text-secondary)';
      deleteBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Complete All Confirmations';
      deleteBtn.classList.add('disabled');
      deleteBtn.classList.remove('enabled');
    }
  }
  
  // Add event listeners
  checkboxes.forEach(cb => {
    const parent = cb.closest('.confirmation-checkbox');
    if (parent) {
      // Make entire checkbox container clickable
      parent.addEventListener('click', function(e) {
        if (e.target !== cb && e.target.tagName !== 'LABEL') {
          cb.checked = !cb.checked;
          updateDeleteButton();
        }
      });
    }
    cb.addEventListener('change', updateDeleteButton);
  });
  
  // Study name input listeners
  studyNameInput.addEventListener('input', updateDeleteButton);
  studyNameInput.addEventListener('blur', updateDeleteButton);
  
  // Form submission
  deleteForm.addEventListener('submit', function(e) {
    const allCheckboxesChecked = Array.from(checkboxes).every(cb => cb.checked);
    const studyNameValid = studyNameInput.value.trim() === expectedStudyName;
    
    if (!allCheckboxesChecked || !studyNameValid) {
      e.preventDefault();
      alert('Please complete all confirmation requirements before deleting.');
      return;
    }
    
    const confirmMessage = `Are you absolutely sure you want to permanently delete this raw data file?\n\nThis action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
      e.preventDefault();
    }
  });
  
  // Initial validation
  updateDeleteButton();
});
</script>
{% endblock content %}
