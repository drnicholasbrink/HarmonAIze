{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Start Harmonisation" }}{% endblock %}

{% block content %}
<div class="content-wrapper" style="max-width: 900px; margin: 2rem auto;">
  <div class="info-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 20px rgba(0,0,0,0.06);">
    <div style="padding:1.25rem 1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;">
      <div>
        <h2 style="margin:0;font-size:1.25rem;font-weight:700;">Start Harmonisation</h2>
        <p style="margin:.25rem 0 0;color:#6b7280;font-size:.85rem;">Source study: <strong>{{ study.name }}</strong></p>
      </div>
      <div style="display:flex;gap:.5rem;">
        <a href="{% url 'health:mapping_schemas' study.id %}" class="btn btn-secondary btn-sm">Schemas</a>
        <a href="{% url 'core:study_detail' study.id %}" class="btn btn-secondary btn-sm">← Back</a>
      </div>
    </div>
    <div style="padding:1.2rem 1.5rem 1.4rem;">
      <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:.8rem 1rem;font-size:.72rem;line-height:1.25;margin:0 0 1rem;">
        <strong>How this works.</strong>
        <ul style="margin:.4rem 0 0;padding-left:1.1rem;">
          <li>Select the <em>Target Study</em> that already defines the harmonised attributes.</li>
          <li>On the next screen map each source attribute to a target attribute and assign roles (patient id, datetime, etc.).</li>
          <li>You can add optional transforms per attribute to normalise values.</li>
          <li>Approve when at least one mapping rule is defined.</li>
        </ul>
      </div>
      <form method="post">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div role="alert" style="background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:8px;padding:.6rem .75rem;font-size:.75rem;margin:0 0 1rem;">{{ form.non_field_errors }}</div>
        {% endif %}
        <div class="form-group" style="margin:0 0 1rem;">
          <label for="id_target_study" style="font-weight:600;">Target Study</label>
          {{ form.target_study }}
          {% if form.target_study.errors %}<div style="color:#991b1b;font-size:.7rem;margin-top:.2rem;" role="alert">{{ form.target_study.errors }}</div>{% endif %}
          <small class="text-muted" style="display:block;margin-top:.25rem;">The study containing the canonical attribute definitions.</small>
        </div>
        <div class="form-group" style="margin:0 0 1rem;">
          <label for="id_comments" style="font-weight:600;">Comments (optional)</label>
          {{ form.comments }}
          {% if form.comments.errors %}<div style="color:#991b1b;font-size:.7rem;margin-top:.2rem;" role="alert">{{ form.comments.errors }}</div>{% endif %}
        </div>
        <div style="display:flex;gap:.75rem;margin-top:.5rem;">
          <button type="submit" class="btn btn-primary">Continue to Mapping →</button>
          <a href="{% url 'core:study_detail' study.id %}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
