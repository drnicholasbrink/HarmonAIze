{% comment %}
Shared JavaScript for variable card functionality.

This script provides:
- toggleVariableSelection(): Click card to toggle checkbox
- updateSelectedCount(): Update selection counter and submit button state
- selectAll(), selectNone(): Bulk selection actions
- openEditModal(), closeEditModal(), saveEdit(): Edit modal functionality
- getHiddenFieldValue(), setHiddenFieldValue(): Helper functions
- updateVariableDisplay(): Update card display after edit
- showNotification(): Show success/error messages

Parent template must have:
- Element with id="selected-count" for displaying selection count
- Element with id="submit-btn" for the submit button
- Element with id="editModal" for the edit modal
{% endcomment %}

<script>
  let currentEditIndex = -1;

  function toggleVariableSelection(element) {
    // Don't toggle if clicking on the edit button or checkbox itself
    if (event.target.closest('.btn-edit') || event.target.type === 'checkbox') {
      return;
    }
    
    const checkbox = element.querySelector('input[type="checkbox"]');
    if (checkbox) {
      checkbox.checked = !checkbox.checked;
      updateSelectedCount();
    }
  }

  function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.variable-item input[type="checkbox"]:checked');
    const count = checkboxes.length;
    
    // Update all count displays
    const countElements = document.querySelectorAll('#selected-count, #inline-selected-count');
    countElements.forEach(el => {
      if (el) el.textContent = count;
    });
    
    // Enable/disable submit buttons
    const submitButtons = document.querySelectorAll('#submit-btn, #submit-btn-bottom');
    submitButtons.forEach(btn => {
      if (btn) btn.disabled = count === 0;
    });
    
    // Update visual state of selected items
    document.querySelectorAll('.variable-item').forEach(item => {
      const checkbox = item.querySelector('input[type="checkbox"]');
      if (checkbox && checkbox.checked) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    });
  }

  function selectAll() {
    const visibleCheckboxes = document.querySelectorAll('.variable-item:not([style*="display: none"]) input[type="checkbox"]');
    visibleCheckboxes.forEach(cb => cb.checked = true);
    updateSelectedCount();
  }

  function selectNone() {
    document.querySelectorAll('.variable-item input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateSelectedCount();
  }

  function openEditModal(event, formIndex) {
    event.stopPropagation(); // Prevent variable selection toggle
    
    currentEditIndex = formIndex;
    const modal = document.getElementById('editModal');
    
    // Get form data
    const variableItem = document.querySelector(`[data-form-index="${formIndex}"]`);
    const hiddenInputs = variableItem.querySelectorAll('input[type="hidden"]');
    
    // Populate modal fields
    document.getElementById('editVariableName').value = getHiddenFieldValue(hiddenInputs, 'variable_name');
    document.getElementById('editDisplayName').value = getHiddenFieldValue(hiddenInputs, 'display_name');
    document.getElementById('editDescription').value = getHiddenFieldValue(hiddenInputs, 'description');
    document.getElementById('editVariableType').value = getHiddenFieldValue(hiddenInputs, 'variable_type');
    document.getElementById('editUnit').value = getHiddenFieldValue(hiddenInputs, 'unit');
    document.getElementById('editOntologyCode').value = getHiddenFieldValue(hiddenInputs, 'ontology_code');
    
    // Category field (if it exists)
    const categoryField = document.getElementById('editCategory');
    if (categoryField) {
      categoryField.value = getHiddenFieldValue(hiddenInputs, 'category');
    }
    
    modal.style.display = 'block';
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  function getHiddenFieldValue(hiddenInputs, fieldName) {
    for (let input of hiddenInputs) {
      if (input.name.includes(fieldName)) {
        return input.value || '';
      }
    }
    return '';
  }

  function saveEdit() {
    if (currentEditIndex === -1) return;
    
    const variableItem = document.querySelector(`[data-form-index="${currentEditIndex}"]`);
    const hiddenInputs = variableItem.querySelectorAll('input[type="hidden"]');
    
    // Update hidden field values
    setHiddenFieldValue(hiddenInputs, 'display_name', document.getElementById('editDisplayName').value);
    setHiddenFieldValue(hiddenInputs, 'description', document.getElementById('editDescription').value);
    setHiddenFieldValue(hiddenInputs, 'variable_type', document.getElementById('editVariableType').value);
    setHiddenFieldValue(hiddenInputs, 'unit', document.getElementById('editUnit').value);
    setHiddenFieldValue(hiddenInputs, 'ontology_code', document.getElementById('editOntologyCode').value);
    
    // Category field (if it exists)
    const categoryField = document.getElementById('editCategory');
    if (categoryField) {
      setHiddenFieldValue(hiddenInputs, 'category', categoryField.value);
    }
    
    // Update display values
    updateVariableDisplay(variableItem);
    
    closeEditModal();
    
    // Show success message
    showNotification('Variable updated successfully!', 'success');
  }

  function setHiddenFieldValue(hiddenInputs, fieldName, value) {
    for (let input of hiddenInputs) {
      if (input.name.includes(fieldName)) {
        input.value = value;
        break;
      }
    }
  }

  function updateVariableDisplay(variableItem) {
    const hiddenInputs = variableItem.querySelectorAll('input[type="hidden"]');
    
    // Update display name
    const displayName = getHiddenFieldValue(hiddenInputs, 'display_name');
    const variableName = getHiddenFieldValue(hiddenInputs, 'variable_name');
    const nameElement = variableItem.querySelector('.variable-name strong');
    if (nameElement) {
      nameElement.textContent = displayName || variableName || 'Unknown Variable';
    }
    
    // Update description
    const description = getHiddenFieldValue(hiddenInputs, 'description');
    const descElement = variableItem.querySelector('.variable-description');
    if (descElement) {
      descElement.textContent = description || 'No description available';
    }
    
    // Update variable type badge
    const variableType = getHiddenFieldValue(hiddenInputs, 'variable_type');
    const typeElement = variableItem.querySelector('.variable-type');
    if (typeElement) {
      typeElement.textContent = variableType || 'Unknown';
    }
    
    // Update meta information
    const unit = getHiddenFieldValue(hiddenInputs, 'unit');
    const ontologyCode = getHiddenFieldValue(hiddenInputs, 'ontology_code');
    const category = getHiddenFieldValue(hiddenInputs, 'category');
    
    const metaElement = variableItem.querySelector('.variable-meta');
    if (metaElement) {
      let metaHTML = '';
      if (unit) {
        metaHTML += `<span class="variable-unit"><strong>Unit:</strong> ${unit}</span>`;
      }
      if (ontologyCode) {
        metaHTML += `<span class="variable-ontology"><strong>Code:</strong> ${ontologyCode}</span>`;
      }
      if (category) {
        metaHTML += `<span class="variable-category"><strong>Category:</strong> ${category}</span>`;
      }
      metaHTML += `<span class="variable-type-detail"><strong>Type:</strong> ${variableType || 'Unknown'}</span>`;
      metaElement.innerHTML = metaHTML;
    }
    
    // Update data attribute for filtering
    variableItem.dataset.type = (variableType || 'unknown').toLowerCase();
  }

  function showNotification(message, type = 'success') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: ${type === 'success' ? '#34C759' : '#FF3B30'};
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    
    // Add animation styles if not already present
    if (!document.getElementById('notification-animations')) {
      const style = document.createElement('style');
      style.id = 'notification-animations';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
  });
</script>
