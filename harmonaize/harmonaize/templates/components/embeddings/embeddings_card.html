{% comment %}
Embeddings Management Card Component

This component displays embedding generation status and controls for a study.
Includes dynamic progress tracking and status management, plus t-SNE visualization controls.

Usage:
  {% include 'components/embeddings/embeddings_card.html' with study=study %}
  
Parameters:
- study: Study object to manage embeddings for
{% endcomment %}
{% load static %}

<div class="info-card embeddings-card">
  <h2 class="card-title">
    <i class="fas fa-vector-square" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
    Variable Embeddings & Visualization
  </h2>
  
  <!-- Embedding Status Grid -->
  <div class="info-grid" style="margin-bottom: 1.5rem;">
    <div class="info-item">
      <div class="info-label">Generation Status</div>
      <div class="info-value">
        {% if variables_with_embeddings == total_variables and total_variables > 0 %}
          <span class="status-badge status-completed" style="background: rgba(52, 199, 89, 0.2); color: #155724; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
            <i class="fas fa-check-circle" style="margin-right: 0.25rem;"></i>Complete
          </span>
        {% elif variables_with_embeddings > 0 %}
          <span class="status-badge status-partial" style="background: rgba(255, 193, 7, 0.2); color: #856404; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
            <i class="fas fa-clock" style="margin-right: 0.25rem;"></i>In Progress
          </span>
        {% else %}
          <span class="status-badge status-pending" style="background: rgba(142, 142, 147, 0.2); color: #3a3a3c; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
            <i class="fas fa-circle" style="margin-right: 0.25rem;"></i>Not Started
          </span>
        {% endif %}
      </div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Progress</div>
      <div class="info-value">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <div class="progress-bar" style="
            width: 120px; 
            height: 10px; 
            background-color: var(--background-color); 
            border-radius: 5px; 
            overflow: hidden;
            border: 1px solid var(--border-color);
          ">
            <div class="progress-fill" style="
              width: {{ embedding_progress }}%; 
              height: 100%; 
              background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); 
              transition: width 0.5s ease;
            "></div>
          </div>
          <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">
            {{ variables_with_embeddings }}/{{ total_variables }}
          </span>
          <span style="color: var(--text-secondary); font-size: 0.85rem;">
            ({{ embedding_progress }}%)
          </span>
        </div>
      </div>
    </div>
    
    <div class="info-item">
      <div class="info-label">AI Model</div>
      <div class="info-value">
        <small style="color: var(--text-secondary);">OpenAI text-embedding-3-large</small>
      </div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Vector Dimensions</div>
      <div class="info-value">
        <small style="color: var(--text-secondary);">3,072 dimensions</small>
      </div>
    </div>
  </div>

  <!-- Action Controls -->
  <div class="embedding-controls" style="margin-bottom: 1.5rem;">
    {% if variables_with_embeddings == total_variables and total_variables > 0 %}
      <!-- All embeddings complete -->
      <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <form id="regenerateAllEmbeddingsForm" method="post" action="{% url 'core:generate_study_embeddings' study_id=study.id %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" id="regenerateAllBtn" class="btn btn-secondary" onclick="return handleRegenerateAllEmbeddings(event, {{ study.variables.count }})">
            <i class="fas fa-redo" style="margin-right: 0.5rem;"></i>
            Regenerate All Embeddings
          </button>
        </form>
        <div style="color: var(--text-secondary); font-size: 0.9rem;">
          <i class="fas fa-info-circle" style="margin-right: 0.25rem;"></i>
          All embeddings complete - ready for harmonisation
        </div>
      </div>
    {% elif variables_with_embeddings > 0 %}
      <!-- Partial embeddings -->
      <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <form id="continueAllEmbeddingsForm" method="post" action="{% url 'core:generate_study_embeddings' study_id=study.id %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" id="continueAllBtn" class="btn btn-primary" onclick="return handleContinueAllEmbeddings(event, {{ study.variables.count }})">
            <i class="fas fa-play" style="margin-right: 0.5rem;"></i>
            Continue Generation
          </button>
        </form>
        <form id="redoAllEmbeddingsForm" method="post" action="{% url 'core:generate_study_embeddings' study_id=study.id %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" id="redoAllBtn" class="btn btn-secondary" onclick="return handleRedoAllEmbeddings(event, {{ study.variables.count }})">
            <i class="fas fa-redo" style="margin-right: 0.5rem;"></i>
            Restart All
          </button>
        </form>
      </div>
    {% else %}
      <!-- No embeddings -->
      <form id="generateAllEmbeddingsForm" method="post" action="{% url 'core:generate_study_embeddings' study_id=study.id %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" id="generateAllBtn" class="btn btn-primary" onclick="return handleGenerateAllEmbeddings(event, {{ study.variables.count }})">
          <i id="generateAllIcon" class="fas fa-magic" style="margin-right: 0.5rem;"></i>
          <span id="generateAllText">Generate All Embeddings</span>
        </button>
      </form>
    {% endif %}
  </div>

  <!-- Progress Indicator (hidden by default) -->
  <div id="embeddingProgress" class="embedding-progress" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: var(--background-color); border-radius: 8px; border: 1px solid var(--border-color);">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
      <i class="fas fa-spinner fa-spin" style="color: var(--primary-color);"></i>
      <span style="font-weight: 500; color: var(--text-primary);">Generating embeddings in background...</span>
    </div>
    <div style="font-size: 0.85rem; color: var(--text-secondary);">
      Processing {{ study.variables.count }} variables. This may take a few minutes. You can continue working while embeddings are generated.
    </div>
  </div>

  <!-- t-SNE Visualization Section -->
  {% if variables_with_embeddings > 0 %}
  <div class="tsne-section" style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(0, 122, 255, 0.05); border-radius: 8px; border: 1px solid rgba(0, 122, 255, 0.15);">
    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
      <i class="fas fa-project-diagram" style="color: var(--primary-color);"></i>
      2D Visualization (t-SNE)
    </h3>
    
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
      <form method="post" action="{% url 'core:generate_project_tsne' project_id=study.project.id %}" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="embedding_type" value="both">
        <button type="submit" class="btn btn-outline-primary" style="font-size: 0.9rem;">
          <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>
          Generate t-SNE Projections
        </button>
      </form>
      
      {% if study.project %}
      <a href="{% url 'core:tsne_visualization' project_id=study.project.id %}?type=name" class="btn btn-primary" style="font-size: 0.9rem;">
        <i class="fas fa-eye" style="margin-right: 0.5rem;"></i>
        View Name Visualization
      </a>
      
      <a href="{% url 'core:tsne_visualization' project_id=study.project.id %}?type=description" class="btn btn-primary" style="font-size: 0.9rem;">
        <i class="fas fa-eye" style="margin-right: 0.5rem;"></i>
        View Description Visualization
      </a>
      {% endif %}
    </div>
    
    <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
      <strong>t-SNE</strong> (t-distributed Stochastic Neighbor Embedding) creates 2D maps of your high-dimensional embeddings, 
      helping you visually explore relationships between variables. Similar variables cluster together in the visualization.
    </div>
  </div>
  {% endif %}

  <!-- Information Panel -->
  <div class="alert alert-info" style="background: rgba(0, 122, 255, 0.1); border: 1px solid rgba(0, 122, 255, 0.2); border-radius: 8px; padding: 1rem;">
    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
      <i class="fas fa-info-circle" style="color: var(--primary-color); margin-top: 0.1rem;"></i>
      <div>
        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
          What are Variable Embeddings?
        </div>
        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.4;">
          AI embeddings convert variable names and descriptions into numerical vectors that capture semantic meaning. 
          This enables intelligent variable matching and similarity detection during harmonisation, making it easier 
          to find related variables across different studies.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  // Enhanced embedding generation handlers
  function handleGenerateAllEmbeddings(event, variableCount) {
    if (!confirm(`This will generate embeddings for all ${variableCount} variables. Continue?`)) {
      return false;
    }
    // Delay the UI updates to allow form submission to happen first
    setTimeout(() => startEmbeddingProcess('generate'), 100);
    return true;
  }

  function handleContinueAllEmbeddings(event, variableCount) {
    if (!confirm(`This will continue generating embeddings for remaining variables. Continue?`)) {
      return false;
    }
    // Delay the UI updates to allow form submission to happen first
    setTimeout(() => startEmbeddingProcess('continue'), 100);
    return true;
  }

  function handleRegenerateAllEmbeddings(event, variableCount) {
    if (!confirm(`This will regenerate embeddings for all ${variableCount} variables. Continue?`)) {
      return false;
    }
    // Delay the UI updates to allow form submission to happen first
    setTimeout(() => startEmbeddingProcess('regenerate'), 100);
    return true;
  }

  function handleRedoAllEmbeddings(event, variableCount) {
    if (!confirm(`This will restart embedding generation from the beginning for all ${variableCount} variables. Continue?`)) {
      return false;
    }
    // Delay the UI updates to allow form submission to happen first
    setTimeout(() => startEmbeddingProcess('redo'), 100);
    return true;
  }

  function startEmbeddingProcess(mode) {
    // Get the appropriate button based on mode
    let button, icon, text;
    
    switch(mode) {
      case 'generate':
        button = document.getElementById('generateAllBtn');
        icon = document.getElementById('generateAllIcon');
        text = document.getElementById('generateAllText');
        break;
      case 'continue':
        button = document.getElementById('continueAllBtn');
        icon = button.querySelector('i');
        text = button.querySelector('span') || button.lastChild;
        break;
      case 'regenerate':
        button = document.getElementById('regenerateAllBtn');
        icon = button.querySelector('i');
        text = button.querySelector('span') || button.lastChild;
        break;
      case 'redo':
        button = document.getElementById('redoAllBtn');
        icon = button.querySelector('i');
        text = button.querySelector('span') || button.lastChild;
        break;
    }
    
    if (!button) return;
    
    // Update button state
    button.disabled = true;
    if (icon) icon.className = 'fas fa-spinner fa-spin';
    if (text) text.textContent = 'Processing...';
    button.style.opacity = '0.7';
    
    // Show progress section
    const progress = document.getElementById('embeddingProgress');
    if (progress) progress.style.display = 'block';
    
    // Start polling for progress after a short delay
    setTimeout(() => {
      startProgressPolling({{ study.id }});
    }, 2000);
  }

  // Progress polling function (reused from main template)
  function startProgressPolling(studyId) {
    const pollInterval = setInterval(() => {
      fetch(`/app/studies/${studyId}/embedding-progress/`)
        .then(response => response.json())
        .then(data => {
          updateProgressBar(data);
          
          // Stop polling when complete
          if (data.is_complete) {
            clearInterval(pollInterval);
            onProgressComplete();
          }
        })
        .catch(error => {
          console.error('Error polling progress:', error);
          clearInterval(pollInterval);
        });
    }, 3000); // Poll every 3 seconds
  }

  // Update progress display
  function updateProgressBar(data) {
    // Update the progress bar
    const progressBar = document.querySelector('.embeddings-card .progress-fill');
    if (progressBar) {
      progressBar.style.width = `${data.percentage}%`;
    }
    
    // Update counts
    const progressText = document.querySelector('.embeddings-card [style*="font-weight: 600"]');
    if (progressText) {
      progressText.textContent = `${data.completed}/${data.total}`;
    }
    
    // Update percentage
    const percentageText = document.querySelector('.embeddings-card [style*="color: var(--text-secondary)"]');
    if (percentageText && percentageText.textContent.includes('%')) {
      percentageText.textContent = `(${data.percentage}%)`;
    }
    
    // Update progress indicator text
    const progressDiv = document.getElementById('embeddingProgress');
    if (progressDiv) {
      const statusText = progressDiv.querySelector('[style*="font-weight: 500"]');
      if (statusText) {
        statusText.textContent = `Generating embeddings... ${data.completed}/${data.total} complete`;
      }
    }
  }

  // Handle completion
  function onProgressComplete() {
    const progress = document.getElementById('embeddingProgress');
    
    // Update progress section
    if (progress) {
      progress.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
          <i class="fas fa-check-circle" style="color: var(--accent-color);"></i>
          <span style="font-weight: 500; color: var(--text-primary);">All embeddings generated successfully!</span>
        </div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
          Variable cards will now show embedding status. You can proceed with harmonisation.
        </div>
      `;
    }
    
    // Refresh page to show updated status
    setTimeout(() => {
      location.reload();
    }, 2000);
  }
</script>