{% extends "base.html" %}
{% load static %}

{% block title %}Geolocation Validation Dashboard - HarmonAIze{% endblock title %}

{% block css %}
  {{ block.super }}
  <style>
    :root {
      --primary-color: #007AFF;
      --secondary-color: #5AC8FA;
      --accent-color: #34C759;
      --health-color: #FF6B6B;
      --background-color: #F2F2F7;
      --card-background: #FFFFFF;
      --text-primary: #1C1C1E;
      --text-secondary: #8E8E93;
      --border-color: #C6C6C8;
      --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
    }

    body {
      background-color: var(--background-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .hero-section {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 3rem 0;
      margin: -1rem -15px 0 -15px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      opacity: 0.5;
    }

    .hero-content {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .hero-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .hero-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: white;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-description {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .action-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .action-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .action-header {
      padding: 2rem;
      color: white;
      text-align: center;
    }

    .action-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .action-content {
      padding: 2rem;
    }

    .feature-list {
      list-style: none;
      padding: 0;
      margin-bottom: 2rem;
    }

    .feature-list li {
      padding: 0.5rem 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      text-align: center;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--accent-color) 0%, #2ecc71 100%);
      color: white;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
      color: white;
    }

    .btn-tertiary {
      background: #6c757d;
      color: white;
    }

    .btn-tertiary:hover {
      background: #5a6268;
      transform: translateY(-2px);
      color: white;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .status-table {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .table-header {
      background: linear-gradient(135deg, var(--text-primary) 0%, #495057 100%);
      color: white;
      padding: 1.5rem;
    }

    .table-header h3 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .table tr:hover {
      background-color: #f8f9fa;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-awaiting_geocoding {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .status-geocoded {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .status-needs_review {
      background-color: #fef3c7;
      color: #92400e;
    }

    .status-pending {
      background-color: #fed7aa;
      color: #9a3412;
    }

    .status-validated {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-rejected {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .confidence-bar {
      width: 60px;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-right: 0.5rem;
    }

    .confidence-fill {
      height: 100%;
      transition: width 0.3s ease;
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s ease;
    }

    .inline-icon {
      display: inline-block;
      vertical-align: middle;
      margin-right: 0.5rem;
    }

    @media (max-width: 768px) {
      .hero-title {
        font-size: 2rem;
      }

      .main-content {
        padding: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .action-section {
        grid-template-columns: 1fr;
      }
    }

    /* Django Messages/Alerts Styling */
    .error-messages-section {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .alert {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      font-weight: 500;
      border-left: 4px solid;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .alert-error {
      background: #fee;
      border-left-color: #dc3545;
      color: #721c24;
    }

    .alert-success {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }

    .alert-info {
      background: #d1ecf1;
      border-left-color: #0c5460;
      color: #0c5460;
    }

    .alert-warning {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }

    .error-icon, .success-icon, .info-icon, .warning-icon {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .error-text, .success-text, .info-text, .warning-text {
      flex: 1;
    }
  </style>
{% endblock css %}

{% block content %}
  <div class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Geolocation Dashboard</h1>
      <p class="hero-subtitle">From Location Names to Coordinates — Validating Place, Illuminating Climate-Health Insights </p>
    </div>
  </div>

  <!-- Django Messages/Alerts -->
  {% if messages %}
    <div class="error-messages-section">
      {% for message in messages %}
        {% if message.tags == 'error' %}
          <div class="alert alert-error">
            <span class="error-icon">{% include 'components/svg_icon.html' with icon='alert-circle' size='20' %}</span>
            <span class="error-text">{{ message }}</span>
          </div>
        {% elif message.tags == 'success' %}
          <div class="alert alert-success">
            <span class="success-icon">{% include 'components/svg_icon.html' with icon='check' size='20' %}</span>
            <span class="success-text">{{ message }}</span>
          </div>
        {% elif message.tags == 'info' %}
          <div class="alert alert-info">
            <span class="info-icon">{% include 'components/svg_icon.html' with icon='info' size='20' %}</span>
            <span class="info-text">{{ message }}</span>
          </div>
        {% elif message.tags == 'warning' %}
          <div class="alert alert-warning">
            <span class="warning-icon">{% include 'components/svg_icon.html' with icon='zap' size='20' %}</span>
            <span class="warning-text">{{ message }}</span>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <div class="main-content">
    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
          {% include 'components/svg_icon.html' with icon='clipboard' size='32' %}
        </div>
        <div class="stat-number" id="totalLocations">-</div>
        <div class="stat-label">Total Location Names</div>
        <div class="stat-description">From study documents</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
          {% include 'components/svg_icon.html' with icon='alert-circle' size='32' %}
        </div>
        <div class="stat-number" id="awaitingGeocoding" style="color: #dc3545;">-</div>
        <div class="stat-label">Awaiting Geocoding</div>
        <div class="stat-description">No coordinates values yet</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
          {% include 'components/svg_icon.html' with icon='refresh' size='32' %}
        </div>
        <div class="stat-number" id="pendingValidation" style="color: #ffc107;">-</div>
        <div class="stat-label">Pending Validation</div>
        <div class="stat-description">Coordinates found - need review</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-color) 0%, #2ecc71 100%);">
          {% include 'components/svg_icon.html' with icon='check' size='32' %}
        </div>
        <div class="stat-number" id="validatedComplete" style="color: var(--accent-color);">-</div>
        <div class="stat-label">Validated & Complete</div>
        <div class="stat-description">Ready for climate integration</div>
      </div>
    </div>

    <!-- Action Cards -->
    <div class="action-section">
      <div class="action-card">
        <div class="action-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
          <h3>{% include 'components/svg_icon.html' with icon='map-pin' size='24' class='inline-icon' %} Step 1: Find Coordinates</h3>
          <p>Search multiple databases for precise location data</p>
        </div>
        <div class="action-content">
          <ul class="feature-list">
            <li>• Google Maps API integration</li>
            <li>• OpenStreetMap database search</li>
            <li>• ArcGIS World Geocoding Service</li>
            <li>• HDX Health Facilities database</li>
          </ul>

          <div class="progress-container" id="geocodingProgress">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="loading-spinner"></div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Searching for coordinates...</div>
                <div id="geocodingStatus" style="color: var(--text-secondary); font-size: 0.9rem;">Querying location databases</div>
              </div>
            </div>
            <div class="progress-bar">
              <div id="geocodingProgressBar" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>

          <button onclick="runGeocoding()" id="geocodingBtn" class="btn btn-primary">
            {% include 'components/svg_icon.html' with icon='search' size='16' class='inline-icon' %}
            Start Coordinate Search
          </button>
        </div>
      </div>

      <div class="action-card">
        <div class="action-header" style="background: linear-gradient(135deg, var(--accent-color) 0%, #2ecc71 100%);">
          <h3>{% include 'components/svg_icon.html' with icon='shield' size='24' class='inline-icon' %} Step 2: Auto Validation</h3>
          <p>AI-powered coordinate validation and quality checks</p>
        </div>
        <div class="action-content">
          <ul class="feature-list">
            <li>• Automated quality checks</li>
            <li>• Address verification</li>
            <li>• Source comparison</li>
            <li>• Best match recommendation</li>
          </ul>

          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button onclick="runSmartValidation()" id="aiAnalysisBtn" class="btn btn-secondary">
              {% include 'components/svg_icon.html' with icon='robot' size='16' class='inline-icon' %}
              Run Auto-validation
            </button>

            <a href="{% url 'geolocation:validation_map' %}" class="btn btn-tertiary">
              {% include 'components/svg_icon.html' with icon='map' size='16' class='inline-icon' %}
              Manual Validation Interface
            </a>

            <button onclick="autoValidateHighConfidence()" id="autoValidateBtn" class="btn btn-small btn-tertiary">
              {% include 'components/svg_icon.html' with icon='zap' size='14' class='inline-icon' %} Auto-approve High Confidence (≥80%)
            </button>
            <button onclick="updateCoordinatesFromValidation()" id="updateCoordsBtn" class="btn btn-small btn-secondary">
              {% include 'components/svg_icon.html' with icon='map-pin' size='14' class='inline-icon' %} Update Location Coordinates
            </button>

            <a href="{% url 'geolocation:validated_locations_map' %}" class="btn btn-small btn-secondary">
              {% include 'components/svg_icon.html' with icon='map' size='16' class='inline-icon' %}
              View Validated Locations Map
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Status Table -->
    <div class="status-table">
      <div class="table-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3>{% include 'components/svg_icon.html' with icon='list' size='20' class='inline-icon' %} Location Status Overview</h3>
            <p style="margin: 0; opacity: 0.9;">Complete validation status for all locations</p>
          </div>
          <button onclick="refreshLocationStatus()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem; width: auto;">
            <svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;"><polyline points="23,4 23,10 17,10"/><polyline points="1,20 1,14 7,14"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> Refresh
          </button>
        </div>
      </div>

      <div style="background: #f8f9fa; padding: 1rem; border-bottom: 1px solid var(--border-color);">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.8rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-awaiting_geocoding">Awaiting Geocoding</span>
            <span style="color: var(--text-secondary);">- No coordinates found yet</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-geocoded">Awaiting Validation</span>
            <span style="color: var(--text-secondary);">- Coordinates found, awaiting Validation</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-needs_review"><svg class="svg-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg> Quick Review</span>
            <span style="color: var(--text-secondary);">- Good quality (≥60%), quick review</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-pending">Detailed Review</span>
            <span style="color: var(--text-secondary);">- Lower quality (<60%), needs investigation</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-validated">Validated</span>
            <span style="color: var(--text-secondary);">- Complete and ready for climate linkage</span>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Location Name</th>
              <th>Status</th>
              <th>Confidence</th>
              <th>Data Sources</th>
              <th>Coordinates</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="locationStatusTable">
            <tr>
              <td colspan="6" style="text-align: center; padding: 2rem;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                  <div class="loading-spinner"></div>
                  <span>Loading location status...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

  <script>
    function updateLocationStatusTable(locations) {
      const tableBody = document.getElementById('locationStatusTable');

      if (!locations || locations.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 2rem;">
              <div style="color: var(--text-secondary);">
                <div style="font-size: 2rem; margin-bottom: 1rem; font-weight: bold;">•</div>
                <div>No locations found. Import location data to get started.</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = '';
      locations.forEach(location => {
        const row = document.createElement('tr');

        const confidenceColor = location.confidence >= 80 ? '#28a745' :
                               location.confidence >= 60 ? '#ffc107' : '#dc3545';

        const statusClass = `status-${location.status}`;

        row.innerHTML = `
          <td>
            <div style="font-weight: 600;">${location.name}</div>
          </td>
          <td>
            <span class="status-badge ${statusClass}">${location.status_display}</span>
          </td>
          <td>
            <div style="display: flex; align-items: center;">
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${location.confidence}%; background-color: ${confidenceColor};"></div>
              </div>
              <span style="font-size: 0.9rem;">${location.confidence}%</span>
            </div>
          </td>
          <td>
            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
              ${location.sources.map(source =>
                `<span style="background: #e9ecef; color: #495057; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${source}</span>`
              ).join('')}
            </div>
          </td>
          <td>
            <div style="font-family: monospace; font-size: 0.9rem;">
              ${location.coordinates ?
                `${location.coordinates.lat.toFixed(5)}, ${location.coordinates.lng.toFixed(5)}` :
                '<span style="color: var(--text-secondary);">No coordinates</span>'
              }
            </div>
          </td>
          <td>
            ${location.status === 'needs_review' || location.status === 'pending' ?
              `<a href="{% url 'geolocation:validation_map' %}?location_id=${location.geocoding_result_id}"
                 style="color: var(--primary-color); text-decoration: none; font-weight: 500;">
                 {% include 'components/svg_icon.html' with icon='eye' size='14' class='inline-icon' %} Review
               </a>` :
              location.status === 'validated' ?
                '<span style="color: var(--accent-color); font-weight: 500;">Complete</span>' :
                '<span style="color: var(--text-secondary);">-</span>'
            }
          </td>
        `;

        tableBody.appendChild(row);
      });
    }

    function refreshLocationStatus() {
      const refreshButton = document.querySelector('button[onclick="refreshLocationStatus()"]');
      if (refreshButton) {
        refreshButton.innerHTML = '<svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;"><polyline points="23,4 23,10 17,10"/><polyline points="1,20 1,14 7,14"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> Refreshing...';
        refreshButton.disabled = true;
      }

      fetch('{% url "geolocation:location_status_api" %}', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          updateLocationStatusTable(data.locations);
        } else {
          showMessage('Failed to load location status: ' + (data.error || 'Unknown error'), 'error');

          const tableBody = document.getElementById('locationStatusTable');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" style="text-align: center; padding: 2rem;">
                  <div style="color: #dc3545;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                    <span>Failed to load location status</span>
                    <br><br>
                    <button onclick="refreshLocationStatus()" class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;">
                      Try Again
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }
        }
      })
      .catch(error => {
        showMessage('Connection error while refreshing location status', 'error');

        const tableBody = document.getElementById('locationStatusTable');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 2rem;">
                <div style="color: #ffc107;">
                  <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                  <span>Connection error - please check your internet connection</span>
                  <br><br>
                  <button onclick="refreshLocationStatus()" class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;">
                    Retry
                  </button>
                </div>
              </td>
            </tr>
          `;
        }
      })
      .finally(() => {
        if (refreshButton) {
          refreshButton.innerHTML = '<svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;"><polyline points="23,4 23,10 17,10"/><polyline points="1,20 1,14 7,14"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> Refresh';
          refreshButton.disabled = false;
        }
      });
    }

    function refreshStats() {
      fetch('{% url "geolocation:geocoding_api" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'get_geocoding_stats'})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const stats = data.stats;

          // Update the stats as received from backend
          document.getElementById('totalLocations').textContent = stats.total_locations;
          document.getElementById('awaitingGeocoding').textContent = stats.awaiting_geocoding;
          document.getElementById('validatedComplete').textContent = stats.validated_complete;

          // Calculate pending validation correctly: Total - Awaiting - Validated
          const pendingValidation = stats.total_locations - stats.awaiting_geocoding - stats.validated_complete;
          document.getElementById('pendingValidation').textContent = pendingValidation;
        }
      })
      .catch(error => {
        showMessage('Unable to refresh statistics. Please check your connection.', 'error');
      });
    }

    function runGeocoding() {
      const force = document.getElementById('forceGeocode') ? document.getElementById('forceGeocode').checked : false;
      const btn = document.getElementById('geocodingBtn');

      document.getElementById('geocodingProgress').style.display = 'block';
      btn.disabled = true;
      btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div><span>Processing...</span></div>';
      document.getElementById('geocodingStatus').textContent = 'Starting batch geocoding with Celery...';

      // Use modern Celery-based batch processing instead of old API
      fetch('{% url "geolocation:start_batch_geocoding" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          force_reprocess: force,
          batch_size: 50
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Start monitoring Celery task progress
          monitorGeocodingTask(data.task_id, btn);
          showMessage('Batch geocoding started successfully!', 'success');
        } else {
          resetGeocodingUI(btn);
          showMessage('Error: Failed to start geocoding - ' + (data.error || 'Unknown error occurred'), 'error');
        }
      })
      .catch(error => {
        resetGeocodingUI(btn);
        showMessage('Error: Connection error during geocoding start', 'error');
      });
    }

    function runSmartValidation() {
      const btn = document.getElementById('aiAnalysisBtn');

      if (confirm('Validate all pending locations automatically?')) {
        btn.disabled = true;
        btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div><span>Analyzing...</span></div>';

        // Use modern Celery-based batch validation instead of old API
        fetch('{% url "geolocation:start_batch_validation" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            batch_size: 50
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Start monitoring Celery task progress
            monitorValidationTask(data.task_id, btn);
            showMessage('Batch validation started successfully!', 'success');
          } else {
            btn.disabled = false;
            btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg><span>Run Auto-validation</span></span>';
            showMessage('Error: Failed to start validation - ' + (data.error || 'Unknown error occurred'), 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg><span>Run Auto-validation</span></span>';
          showMessage('Error: Connection error during validation start', 'error');
        });
      }
    }

    function autoValidateHighConfidence() {
      const btn = document.getElementById('autoValidateBtn');

      if (confirm('Auto-approve all high-confidence locations (≥80%)?')) {
        btn.disabled = true;
        btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 12px; height: 12px; border-width: 2px;"></div><span>Processing...</span></div>';

        fetch('{% url "geolocation:bulk_validation_actions" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'auto_validate_high_confidence'})
        })
        .then(response => response.json())
        .then(data => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/></svg><span>Auto-approve High Confidence (≥80%)</span></span>';

          if (data.success) {
            showMessage('Auto-validation completed: ' + data.message, 'success');
            setTimeout(() => {
              refreshStats();
              refreshLocationStatus();
            }, 2000);
          } else {
            showMessage('Error: Auto-validation failed: ' + (data.error || 'Processing error occurred'), 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/></svg><span>Auto-approve High Confidence (≥80%)</span></span>';
          showMessage('Error: Connection error during auto-validation', 'error');
        });
      }
    }

    function updateCoordinatesFromValidation() {
      const btn = document.getElementById('updateCoordsBtn');

      if (confirm('Update location coordinates from validated results?')) {
        btn.disabled = true;
        btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 12px; height: 12px; border-width: 2px;"></div><span>Updating...</span></div>';

        fetch('{% url "geolocation:validation_dashboard" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'update_coordinates'})
        })
        .then(response => response.json())
        .then(data => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Update Location Coordinates</span></span>';

          if (data.success) {
            showMessage('Coordinates updated: ' + data.message, 'success');
            setTimeout(() => {
              refreshStats();
              refreshLocationStatus();
            }, 2000);
          } else {
            showMessage('Error: Coordinate update failed: ' + (data.error || 'Update error occurred'), 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Update Location Coordinates</span></span>';
          showMessage('Error: Connection error during coordinate update', 'error');
        });
      }
    }

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      const colors = {
        'success': { bg: '#d4edda', text: '#155724', border: '#c3e6cb' },
        'error': { bg: '#f8d7da', text: '#721c24', border: '#f5c6cb' },
        'info': { bg: '#d1ecf1', text: '#0c5460', border: '#bee5eb' }
      };

      const color = colors[type] || colors.info;

      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        background: ${color.bg};
        color: ${color.text};
        border: 1px solid ${color.border};
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 1rem;
        max-width: 400px;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;

      messageDiv.textContent = message;
      container.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
      }, 10);

      setTimeout(() => {
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => messageDiv.remove(), 300);
      }, 5000);
    }

    // Celery task monitoring functions
    function monitorGeocodingTask(taskId, btn) {
      const poll = async () => {
        try {
          const response = await fetch(`/geolocation/batch-progress/${taskId}/`);
          const data = await response.json();

          updateGeocodingProgress(data);

          if (data.status === 'completed' || data.status === 'failed') {
            resetGeocodingUI(btn);
            if (data.status === 'completed') {
              showMessage('Batch geocoding completed successfully!', 'success');
              setTimeout(() => {
                refreshStats();
                refreshLocationStatus();
              }, 1000);
            } else {
              showMessage('Batch geocoding failed: ' + (data.error || 'Unknown error'), 'error');
            }
            return;
          }

          setTimeout(poll, 2000); // Poll every 2 seconds
        } catch (error) {
          console.error('Error polling geocoding progress:', error);
          resetGeocodingUI(btn);
          showMessage('Error monitoring geocoding progress', 'error');
        }
      };

      poll();
    }

    function updateGeocodingProgress(data) {
      const progress = data.progress || 0;
      const progressBar = document.getElementById('geocodingProgressBar');
      if (progressBar) {
        progressBar.style.width = progress + '%';
      }

      const statusElement = document.getElementById('geocodingStatus');
      if (statusElement) {
        let statusText = `Progress: ${progress}%`;
        if (data.processed) {
          statusText += ` | Processed: ${data.processed}/${data.total || 0}`;
        }
        if (data.successful !== undefined) {
          statusText += ` | Success: ${data.successful} | Failed: ${data.failed || 0}`;
        }
        if (data.current_location) {
          statusText += ` | Current: ${data.current_location}`;
        }
        statusElement.textContent = statusText;
      }
    }

    function resetGeocodingUI(btn) {
      const progressContainer = document.getElementById('geocodingProgress');
      if (progressContainer) {
        progressContainer.style.display = 'none';
      }

      if (btn) {
        btn.disabled = false;
        btn.innerHTML = `
          {% include 'components/svg_icon.html' with icon='search' size='16' class='inline-icon' %}
          Start Coordinate Search
        `;
      }
    }

    function monitorValidationTask(taskId, btn) {
      const poll = async () => {
        try {
          const response = await fetch(`/geolocation/batch-progress/${taskId}/`);
          const data = await response.json();

          // Update progress display if needed

          if (data.status === 'completed' || data.status === 'failed') {
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg><span>Run Auto-validation</span></span>';
            }

            if (data.status === 'completed') {
              showMessage('Batch validation completed successfully!', 'success');
              setTimeout(() => {
                refreshStats();
                refreshLocationStatus();
              }, 1000);
            } else {
              showMessage('Batch validation failed: ' + (data.error || 'Unknown error'), 'error');
            }
            return;
          }

          setTimeout(poll, 2000); // Poll every 2 seconds
        } catch (error) {
          console.error('Error polling validation progress:', error);
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><svg class="svg-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg><span>Run Auto-validation</span></span>';
          }
          showMessage('Error monitoring validation progress', 'error');
        }
      };

      poll();
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      refreshStats();
      refreshLocationStatus();

      // Set up auto-refresh intervals
      setInterval(refreshStats, 10000); // Every 10 seconds
      setInterval(refreshLocationStatus, 15000); // Every 15 seconds
    });
  </script>
{% endblock content %}
