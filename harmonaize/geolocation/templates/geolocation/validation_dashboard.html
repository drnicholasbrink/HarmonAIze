{% extends "base.html" %}
{% load static %}

{% block title %}Geolocation Validation Dashboard - HarmonAIze{% endblock title %}

{% block css %}
  {{ block.super }}
  <style>
    :root {
      --primary-color: #007AFF;
      --secondary-color: #5AC8FA;
      --accent-color: #34C759;
      --health-color: #FF6B6B;
      --background-color: #F2F2F7;
      --card-background: #FFFFFF;
      --text-primary: #1C1C1E;
      --text-secondary: #8E8E93;
      --border-color: #C6C6C8;
      --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
    }

    body {
      background-color: var(--background-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .hero-section {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 3rem 0;
      margin: -1rem -15px 0 -15px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      opacity: 0.5;
    }

    .hero-content {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .hero-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .hero-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: white;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-description {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .action-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .action-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .action-header {
      padding: 2rem;
      color: white;
      text-align: center;
    }

    .action-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .action-content {
      padding: 2rem;
    }

    .feature-list {
      list-style: none;
      padding: 0;
      margin-bottom: 2rem;
    }

    .feature-list li {
      padding: 0.5rem 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      text-align: center;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--accent-color) 0%, #2ecc71 100%);
      color: white;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
      color: white;
    }

    .btn-tertiary {
      background: #6c757d;
      color: white;
    }

    .btn-tertiary:hover {
      background: #5a6268;
      transform: translateY(-2px);
      color: white;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .status-table {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .table-header {
      background: linear-gradient(135deg, var(--text-primary) 0%, #495057 100%);
      color: white;
      padding: 1.5rem;
    }

    .table-header h3 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .table tr:hover {
      background-color: #f8f9fa;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-awaiting_geocoding {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .status-geocoded {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .status-needs_review {
      background-color: #fef3c7;
      color: #92400e;
    }

    .status-pending {
      background-color: #fed7aa;
      color: #9a3412;
    }

    .status-validated {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-rejected {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .confidence-bar {
      width: 60px;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-right: 0.5rem;
    }

    .confidence-fill {
      height: 100%;
      transition: width 0.3s ease;
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s ease;
    }

    .inline-icon {
      display: inline-block;
      vertical-align: middle;
      margin-right: 0.5rem;
    }

    @media (max-width: 768px) {
      .hero-title {
        font-size: 2rem;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .action-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock css %}

{% block content %}
  <div class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Geolocation Dashboard</h1>
      <p class="hero-subtitle">From Location Names to Coordinates ‚Äî Validating Place, Illuminating Climate-Health Insights </p>
    </div>
  </div>

  <div class="main-content">
    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
          üìù
        </div>
        <div class="stat-number" id="totalLocations">-</div>
        <div class="stat-label">Total Location Names</div>
        <div class="stat-description">From study documents</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
          üìç
        </div>
        <div class="stat-number" id="awaitingGeocoding" style="color: #dc3545;">-</div>
        <div class="stat-label">Awaiting Geocoding</div>
        <div class="stat-description">No coordinates values yet</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
          ‚è≥
        </div>
        <div class="stat-number" id="pendingValidation" style="color: #ffc107;">-</div>
        <div class="stat-label">Pending Validation</div>
        <div class="stat-description">Coordinates found - need review</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-color) 0%, #2ecc71 100%);">
          ‚úÖ
        </div>
        <div class="stat-number" id="validatedComplete" style="color: var(--accent-color);">-</div>
        <div class="stat-label">Validated & Complete</div>
        <div class="stat-description">Ready for climate integration</div>
      </div>
    </div>

    <!-- Action Cards -->
    <div class="action-section">
      <div class="action-card">
        <div class="action-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
          <h3>{% include 'components/svg_icon.html' with icon='map-pin' size='24' class='inline-icon' %} Step 1: Find Coordinates</h3>
          <p>Search multiple databases for precise location data</p>
        </div>
        <div class="action-content">
          <ul class="feature-list">
            <li>‚Ä¢ Google Maps API integration</li>
            <li>‚Ä¢ OpenStreetMap database search</li>
            <li>‚Ä¢ ArcGIS World Geocoding Service</li>
            <li>‚Ä¢ HDX Health Facilities database</li>
          </ul>
          
          <div class="progress-container" id="geocodingProgress">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="loading-spinner"></div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Searching for coordinates...</div>
                <div id="geocodingStatus" style="color: var(--text-secondary); font-size: 0.9rem;">Querying location databases</div>
              </div>
            </div>
            <div class="progress-bar">
              <div id="geocodingProgressBar" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          
          <button onclick="runGeocoding()" id="geocodingBtn" class="btn btn-primary">
            {% include 'components/svg_icon.html' with icon='search' size='16' class='inline-icon' %}
            Start Coordinate Search
          </button>
        </div>
      </div>

      <div class="action-card">
        <div class="action-header" style="background: linear-gradient(135deg, var(--accent-color) 0%, #2ecc71 100%);">
          <h3>{% include 'components/svg_icon.html' with icon='shield' size='24' class='inline-icon' %} Step 2: Auto Validation</h3>
          <p>Smart validation with reverse geocoding and distance analysis</p>
        </div>
        <div class="action-content">
          <ul class="feature-list">
            <li>‚Ä¢ Auto coordinates validation </li>
            <li>‚Ä¢ Reverse geocoding analysis</li>
            <li>‚Ä¢ Distance proximity analysis</li>
            <li>‚Ä¢ Best source recommendation</li>
          </ul>
          
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button onclick="runSmartValidation()" id="aiAnalysisBtn" class="btn btn-secondary">
              {% include 'components/svg_icon.html' with icon='brain' size='16' class='inline-icon' %}
              Run Auto-validation
            </button>
            
            <a href="{% url 'geolocation:validation_map' %}" class="btn btn-tertiary">
              {% include 'components/svg_icon.html' with icon='map' size='16' class='inline-icon' %}
              Manual Validation Interface
            </a>

            <button onclick="autoValidateHighConfidence()" id="autoValidateBtn" class="btn btn-small btn-tertiary">
              ‚ö° Auto-approve High Confidence (‚â•80%)
            </button>

            <a href="{% url 'geolocation:validated_locations_map' %}" class="btn btn-small btn-secondary">
              {% include 'components/svg_icon.html' with icon='map' size='16' class='inline-icon' %}
              View Validated Locations Map
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Status Table -->
    <div class="status-table">
      <div class="table-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3>{% include 'components/svg_icon.html' with icon='list' size='20' class='inline-icon' %} Location Status Overview</h3>
            <p style="margin: 0; opacity: 0.9;">Complete validation status for all locations</p>
          </div>
          <button onclick="refreshLocationStatus()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem; width: auto;">
            üîÑ Refresh
          </button>
        </div>
      </div>
      
      <div style="background: #f8f9fa; padding: 1rem; border-bottom: 1px solid var(--border-color);">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.8rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-awaiting_geocoding">üìç Awaiting Geocoding</span>
            <span style="color: var(--text-secondary);">- No coordinates found yet</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-geocoded">üîç Awaiting Validation</span>
            <span style="color: var(--text-secondary);">- Coordinates found, awaiting Validation</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-needs_review">‚ö†Ô∏è Quick Review</span>
            <span style="color: var(--text-secondary);">- Good quality (‚â•60%), quick review</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-pending">üîç Detailed Review</span>
            <span style="color: var(--text-secondary);">- Lower quality (<60%), needs investigation</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="status-badge status-validated">‚úÖ Validated</span>
            <span style="color: var(--text-secondary);">- Complete and ready for climate linkage</span>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Location Name</th>
              <th>Status</th>
              <th>Confidence</th>
              <th>Data Sources</th>
              <th>Coordinates</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="locationStatusTable">
            <tr>
              <td colspan="6" style="text-align: center; padding: 2rem;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                  <div class="loading-spinner"></div>
                  <span>Loading location status...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

  <script>
    function updateLocationStatusTable(locations) {
      const tableBody = document.getElementById('locationStatusTable');
      
      if (!locations || locations.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 2rem;">
              <div style="color: var(--text-secondary);">
                <div style="font-size: 2rem; margin-bottom: 1rem;">üìç</div>
                <div>No locations found. Import location data to get started.</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = '';
      locations.forEach(location => {
        const row = document.createElement('tr');
        
        const confidenceColor = location.confidence >= 80 ? '#28a745' :
                               location.confidence >= 60 ? '#ffc107' : '#dc3545';
        
        const statusClass = `status-${location.status}`;
        
        row.innerHTML = `
          <td>
            <div style="font-weight: 600;">${location.name}</div>
          </td>
          <td>
            <span class="status-badge ${statusClass}">${location.status_display}</span>
          </td>
          <td>
            <div style="display: flex; align-items: center;">
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${location.confidence}%; background-color: ${confidenceColor};"></div>
              </div>
              <span style="font-size: 0.9rem;">${location.confidence}%</span>
            </div>
          </td>
          <td>
            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
              ${location.sources.map(source => 
                `<span style="background: #e9ecef; color: #495057; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${source}</span>`
              ).join('')}
            </div>
          </td>
          <td>
            <div style="font-family: monospace; font-size: 0.9rem;">
              ${location.coordinates ? 
                `${location.coordinates.lat.toFixed(5)}, ${location.coordinates.lng.toFixed(5)}` : 
                '<span style="color: var(--text-secondary);">No coordinates</span>'
              }
            </div>
          </td>
          <td>
            ${location.status === 'needs_review' || location.status === 'pending' ? 
              `<a href="{% url 'geolocation:validation_map' %}?location_id=${location.geocoding_result_id}" 
                 style="color: var(--primary-color); text-decoration: none; font-weight: 500;">
                 {% include 'components/svg_icon.html' with icon='eye' size='14' class='inline-icon' %} Review
               </a>` : 
              location.status === 'validated' ? 
                '<span style="color: var(--accent-color); font-weight: 500;">‚úÖ Complete</span>' : 
                '<span style="color: var(--text-secondary);">-</span>'
            }
          </td>
        `;
        
        tableBody.appendChild(row);
      });
    }

    function refreshLocationStatus() {
      const refreshButton = document.querySelector('button[onclick="refreshLocationStatus()"]');
      if (refreshButton) {
        refreshButton.innerHTML = 'üîÑ Refreshing...';
        refreshButton.disabled = true;
      }

      fetch('{% url "geolocation:location_status_api" %}', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          updateLocationStatusTable(data.locations);
          
          if (data.summary) {
            showMessage(``, 'info');
          }
        } else {
          showMessage('Failed to load location status: ' + (data.error || 'Unknown error'), 'error');
          
          const tableBody = document.getElementById('locationStatusTable');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" style="text-align: center; padding: 2rem;">
                  <div style="color: #dc3545;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                    <span>Failed to load location status</span>
                    <br><br>
                    <button onclick="refreshLocationStatus()" class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;">
                      Try Again
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }
        }
      })
      .catch(error => {
        console.error('Error fetching location status:', error);
        showMessage('Connection error while refreshing location status', 'error');
        
        const tableBody = document.getElementById('locationStatusTable');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 2rem;">
                <div style="color: #ffc107;">
                  <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                  <span>Connection error - please check your internet connection</span>
                  <br><br>
                  <button onclick="refreshLocationStatus()" class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;">
                    Retry
                  </button>
                </div>
              </td>
            </tr>
          `;
        }
      })
      .finally(() => {
        if (refreshButton) {
          refreshButton.innerHTML = 'üîÑ Refresh';
          refreshButton.disabled = false;
        }
      });
    }

    function refreshStats() {
      fetch('{% url "geolocation:geocoding_api" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'get_geocoding_stats'})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const stats = data.stats;
          
          // Update the stats as received from backend
          document.getElementById('totalLocations').textContent = stats.total_locations;
          document.getElementById('awaitingGeocoding').textContent = stats.awaiting_geocoding;
          document.getElementById('validatedComplete').textContent = stats.validated_complete;
          
          // Calculate pending validation correctly: Total - Awaiting - Validated
          const pendingValidation = stats.total_locations - stats.awaiting_geocoding - stats.validated_complete;
          document.getElementById('pendingValidation').textContent = pendingValidation;
        }
      })
      .catch(error => {
        console.error('Error fetching stats:', error);
        showMessage('Unable to refresh statistics. Please check your connection.', 'error');
      });
    }

    function runGeocoding() {
      const force = document.getElementById('forceGeocode') ? document.getElementById('forceGeocode').checked : false;
      const btn = document.getElementById('geocodingBtn');
      
      document.getElementById('geocodingProgress').style.display = 'block';
      btn.disabled = true;
      btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div><span>Processing...</span></div>';
      document.getElementById('geocodingStatus').textContent = 'Initializing coordinate search...';
      
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        document.getElementById('geocodingProgressBar').style.width = progress + '%';
      }, 500);
      
      fetch('{% url "geolocation:geocoding_api" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: 'run_geocoding', force: force})
      })
      .then(response => response.json())
      .then(data => {
        clearInterval(progressInterval);
        document.getElementById('geocodingProgressBar').style.width = '100%';
        
        setTimeout(() => {
          document.getElementById('geocodingProgress').style.display = 'none';
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>üîç</span><span>Start Coordinate Search</span></span>';
          
          if (data.success) {
            showMessage('‚úÖ Coordinate search completed successfully!', 'success');
            setTimeout(() => {
              refreshStats();
              refreshLocationStatus();
            }, 1000);
          } else {
            showMessage('‚ùå Coordinate Search failed: ' + (data.error || 'Unknown error occurred'), 'error');
          }
        }, 1000);
      })
      .catch(error => {
        clearInterval(progressInterval);
        document.getElementById('geocodingProgress').style.display = 'none';
        btn.disabled = false;
        btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>üîç</span><span>Start Coordinate Search</span></span>';
        showMessage('‚ùå Connection error during coordinate search', 'error');
      });
    }

    function runSmartValidation() {
      const btn = document.getElementById('aiAnalysisBtn');
      
      if (confirm('ü§ñ Run auto-validation on all pending locations?\n\nThis will analyze coordinate accuracy with reverse geocoding (70%) and distance proximity (30%) validation.')) {
        btn.disabled = true;
        btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div><span>Analyzing...</span></div>';
        showMessage('ü§ñ Auto-validation started...', 'info');
        
        fetch('{% url "geolocation:bulk_validation_actions" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'run_smart_validation_batch'})
        })
        .then(response => response.json())
        .then(data => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>üß†</span><span>Run Auto-validation</span></span>';
          
          if (data.success) {
            showMessage('‚úÖ Auto-validation completed: ' + data.message, 'success');
            setTimeout(() => {
              refreshStats();
              refreshLocationStatus();
              showMessage('üìä Dashboard updated with validation results', 'info');
            }, 2000);
          } else {
            showMessage('‚ùå Auto-validation failed: ' + (data.error || 'Processing error occurred'), 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>üß†</span><span>Run Auto-validation</span></span>';
          showMessage('‚ùå Connection error during Auto-validation', 'error');
        });
      }
    }

    function autoValidateHighConfidence() {
      const btn = document.getElementById('autoValidateBtn');
      
      if (confirm('‚ö° Automatically approve all high-confidence locations (‚â•80%) auto-validated?\n\nThis will mark them as validated without manual review.')) {
        btn.disabled = true;
        btn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="loading-spinner" style="width: 12px; height: 12px; border-width: 2px;"></div><span>Processing...</span></div>';
        showMessage('‚ö° Auto-validation in progress with confidence factors...', 'info');
        
        fetch('{% url "geolocation:bulk_validation_actions" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'auto_validate_high_confidence'})
        })
        .then(response => response.json())
        .then(data => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>‚ö°</span><span>Auto-approve High Confidence (‚â•80%)</span></span>';
          
          if (data.success) {
            showMessage('‚úÖ Auto-validation completed: ' + data.message, 'success');
            setTimeout(() => {
              refreshStats();
              refreshLocationStatus();
              showMessage('üìä Dashboard refreshed with updated status', 'info');
            }, 2000);
          } else {
            showMessage('‚ùå Auto-validation failed: ' + (data.error || 'Processing error occurred'), 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><span>‚ö°</span><span>Auto-approve High Confidence (‚â•80%)</span></span>';
          showMessage('‚ùå Connection error during auto-validation', 'error');
        });
      }
    }

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      const colors = {
        'success': { bg: '#d4edda', text: '#155724', border: '#c3e6cb' },
        'error': { bg: '#f8d7da', text: '#721c24', border: '#f5c6cb' },
        'info': { bg: '#d1ecf1', text: '#0c5460', border: '#bee5eb' }
      };
      
      const color = colors[type] || colors.info;
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        background: ${color.bg};
        color: ${color.text};
        border: 1px solid ${color.border};
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 1rem;
        max-width: 400px;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;
      
      messageDiv.textContent = message;
      container.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
      }, 10);
      
      setTimeout(() => {
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => messageDiv.remove(), 300);
      }, 5000);
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      refreshStats();
      refreshLocationStatus();
      
      // Set up auto-refresh intervals
      setInterval(refreshStats, 10000); // Every 10 seconds
      setInterval(refreshLocationStatus, 15000); // Every 15 seconds
      
      // Show initial welcome message
      setTimeout(() => {
        showMessage('üåç Welcome to the Geolocation Dashboard', 'info');
      }, 1000);
    });
  </script>
{% endblock content %}